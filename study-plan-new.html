<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>My Study Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body{font-family:'Inter',sans-serif;background-color:#f8fafc}
        .task-item,.card-item{transition:background-color .3s}
        .task-item.completed{background-color:#dcfce7} /* Lighter green for completed */
        .task-item.completed td{color:#374151}
        .task-item.completed .vocab-item{color:#065f46;opacity:.9} /* Darker green for vocab */
        .task-item.completed .vocab-item:hover{background-color:#a7f3d0;opacity:1}
        .card-item.completed{background-color:#dcfce7}
        .card-item.completed p,.card-item.completed .text-gray-600,.card-item.completed .text-sm div{color:#374151}
        .task-checkbox{appearance:none;-webkit-appearance:none;height:1.25rem;width:1.25rem;min-width:1.25rem;border:2px solid #9ca3af;border-radius:.375rem;display:inline-block;position:relative;cursor:pointer;transition:all .2s;margin-right:.75rem;flex-shrink:0}
        .task-checkbox:checked{background-color:#10b981;border-color:#10b981} /* Emerald green checkbox */
        .task-checkbox:checked::after{content:"";position:absolute;display:block;left:.4rem;top:.125rem;width:.35rem;height:.7rem;border-style:solid;border-color:white;border-width:0 .15rem .15rem 0;transform:rotate(45deg)}
        .vocab-item{position:relative;display:inline-flex;align-items:center;background-color:#ecfdf5;color:#047857;padding:4px 10px;border-radius:9999px;cursor:pointer;font-weight:500;transition:background-color .2s;white-space:nowrap;margin-right:8px;margin-bottom:8px;} /* Emerald vocab */
        .vocab-item:hover{background-color:#a7f3d0}
        .vocab-word { /* Added style for the word itself */
            margin-right: 4px; /* Space between word and meaning trigger */
        }
        .vocab-meaning{visibility:hidden;opacity:0;width:max-content;max-width:250px;background-color:#065f46;color:#fff;text-align:center;border-radius:6px;padding:6px 12px;position:absolute;z-index:10;bottom:130%;left:50%;transform:translateX(-50%);transition:opacity .3s,visibility .3s;font-weight:500;white-space:normal;pointer-events:none;} /* Added pointer-events:none */
        .vocab-item:hover .vocab-meaning, .vocab-item.active .vocab-meaning{visibility:visible;opacity:1} /* Changed to hover for visibility by default */
        .vocab-item .vocab-meaning::after{content:"";position:absolute;top:100%;left:50%;margin-left:-5px;border-width:5px;border-style:solid;border-color:#065f46 transparent transparent transparent}
        .modal-hidden{display:none}
        .story-modal-overlay{position:fixed;inset:0;background-color:rgba(0,0,0,.5);z-index:40;transition:opacity .3s}
        .story-modal-box{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:50;background-color:#f0fdf4;border:4px solid #16a34a;border-radius:.75rem;box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04);width:90%;max-width:600px;max-height:80vh;overflow-y:auto;padding:1.25rem}
        .story-modal-box h3{font-size:1.25rem;font-weight:700;color:#16a34a;margin-bottom:1rem}
        .story-modal-box p{color:#047857;line-height:1.6}
        .story-modal-close-btn{position:absolute;top:.75rem;right:.75rem;background-color:transparent;border:none;color:#16a34a;font-size:1.5rem;font-weight:700;line-height:1;cursor:pointer;padding:0}
        .read-story-btn{display:inline-block;margin-top:.75rem;margin-left:.25rem;background-color:#059669;color:white;padding:4px 12px;border-radius:9999px;font-size:.875rem;font-weight:500;cursor:pointer;transition:background-color .2s} /* Emerald story button */
        .read-story-btn:hover{background-color:#047857}
        .progress-container{position:sticky;top:0;z-index:10;background-color:#f8fafc;padding-top:1rem;padding-bottom:1rem;margin-bottom:1.5rem}
        .progress-bar-outer{background-color:#e2e8f0}
        .progress-bar-inner{background-color:#10b981;transition:width .4s ease-in-out} /* Emerald progress bar */
        .full-table table{border-collapse:collapse;width:100%;table-layout: fixed;} /* Added table-layout: fixed */
        .full-table thead th{background-color:#059669;color:white;font-weight:600;text-align:left;padding:.75rem 1.5rem;border-top:3px solid #047857;border-bottom:2px solid #047857;vertical-align:top;}
        .full-table thead th:first-child{border-left:3px solid #047857}
        .full-table thead th:last-child{border-right:3px solid #047857}
        .full-table tbody tr:nth-child(even){background-color:#f0fdf4} /* Lighter emerald even rows */
        .full-table tbody tr:nth-child(odd){background-color:#ffffff} /* White odd rows */
        .full-table tbody tr.task-item.completed:nth-child(even){background-color:#bbf7d0} /* Slightly darker completed even */
        .full-table tbody tr.task-item.completed:nth-child(odd){background-color:#dcfce7} /* Slightly darker completed odd */
        .full-table tbody td{color:#374151;border-top:1px solid #d1fae5;padding:.75rem 1.5rem;word-wrap: break-word;} /* Emerald borders, added word-wrap */
        .full-table tbody tr.day-group-start td{border-top:3px solid #047857}
        .full-table tbody tr.task-item td:first-child{border-left:3px solid #047857}
        .full-table tbody tr.task-item td:last-child{border-right:3px solid #047857}
        .full-table tbody tr:last-child td{border-bottom:3px solid #047857}
        .full-table tbody td:first-child{font-weight:600;color:#064e3b} /* Dark emerald for day */
        .full-table tbody td:nth-child(2){color:#065f46} /* Green for subject */
        .full-table tbody td:nth-child(3){color:#1f2937}

        /* Inline editing styles */
        .editable-field {
            border: 1px solid #d1fae5; /* Light green border for editable fields */
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            width: 100%;
            background-color: #f0fdf4; /* Light green background */
            font-size: 0.875rem;
            line-height: 1.25rem;
            color: #1f2937;
        }
        .editable-field:focus {
            outline: none;
            border-color: #059669; /* Darker green on focus */
            box-shadow: 0 0 0 2px rgba(5, 150, 105, 0.2);
        }
        textarea.editable-field {
            min-height: 40px;
            resize: vertical;
        }
        .edit-buttons button {
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
        }

        /* Full Width Table (overrides previous media queries for demonstration) */
        @media (max-width:768px){.full-table{display:none}.mobile-cards{display:block}}
        @media (min-width:769px){.full-table{display:table; width:100%;}.mobile-cards{display:none}} /* Ensured display:table and width:100% */
        .table-wrapper {
            overflow-x: auto; /* Allow horizontal scrolling on small screens if needed */
        }
    </style>
</head>
<body class="bg-gray-50 p-4 md:p-8">

<div class="max-w-7xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">My Study Plan</h1>
        <p class="text-lg text-gray-500">Monthly Plan (18.10.25 – 17.11.25)</p>
    </div>

    <!-- Auth & Sync Status -->
    <div class="mb-6 p-4 bg-emerald-50 border border-emerald-200 rounded-lg shadow">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
            <div>
                <h3 class="font-semibold text-emerald-800">Sync Status</h3>
                <div class="flex items-center space-x-2">
                    <div id="sync-indicator" class="w-3 h-3 rounded-full bg-gray-400 animate-pulse"></div>
                    <p id="sync-status" class="text-sm text-emerald-700">Waiting for login...</p>
                </div>
                <p id="sync-error" class="hidden text-xs text-red-600 mt-1"></p>
            </div>
            <div id="auth-container" class="mt-4 sm:mt-0 sm:ml-4 flex-shrink-0">
                <button id="login-btn" class="w-full sm:w-auto bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-gray-50 transition flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v8.51h13.04c-.57 2.75-2.23 5.08-4.79 6.64l7.98 6.19C45.27 36.64 48 31.13 48 24c0-.79-.07-1.55-.17-2.3z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.98-6.19c-2.11 1.45-4.8 2.3-7.91 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    Sign in with Google
                </button>
                <div id="user-info" class="hidden text-sm text-right">
                    <p class="font-medium text-gray-800" id="user-name">Loading...</p>
                    <p class="text-gray-600 truncate max-w-[200px]" id="user-email">...</p>
                    <button id="logout-btn" class="text-xs text-red-600 font-medium hover:underline mt-1">Log Out</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Targets -->
    <div class="mb-10">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Monthly Targets</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5" id="monthly-targets-container">
            <!-- Monthly targets will be rendered here dynamically -->
        </div>
    </div>

    <div id="study-plan-container">
        <!-- Monthly and Weekly plans will be dynamically inserted here -->
    </div>

    <button id="add-new-month-btn" class="mt-8 mx-auto block bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-colors">
        Add New Month
    </button>
</div>

<!-- Story Modal -->
<div id="story-modal" class="modal-hidden">
    <div id="story-overlay" class="story-modal-overlay"></div>
    <div id="story-modal-box" class="story-modal-box">
        <button id="story-close-btn" class="story-modal-close-btn">&times;</button>
        <h3 id="story-title">A Day's Tale</h3>
        <p id="story-content" class="mt-4"></p>
    </div>
</div>

<!-- Firebase + App Script -->
<script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, setLogLevel, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* ----------------- CONFIG ----------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyAj7MDnrnzKUO73BXG0jeM-uBGrAH3XiAY",
      authDomain: "study-plan17.firebaseapp.com",
      projectId: "study-plan17",
      storageBucket: "study-plan17.firebasestorage.app",
      messagingSenderId: "394648483332",
      appId: "1:394648483332:web:a0b8f6adc9c8cad0e4e751",
      measurementId: "G-X9CFFJCM2F"
    };

    let app, auth, db, userId, studyPlanDocRef, unsubscribeListener = null; // Changed dataDocRef to studyPlanDocRef
    let isFirebaseReady = false, isDataLoaded = false;
    let editingDay = null; // Stores the day currently being edited (e.g., 'month0-week0-day1')
    let editingMonthlyTarget = null; // Stores the index of the monthly target being edited

    // UI elements
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userInfo = document.getElementById('user-info');
    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    const syncIndicator = document.getElementById('sync-indicator');
    const syncStatus = document.getElementById('sync-status');
    const syncError = document.getElementById('sync-error');
    const monthlyTargetsContainer = document.getElementById('monthly-targets-container');
    const studyPlanContainer = document.getElementById('study-plan-container');
    const addNewMonthBtn = document.getElementById('add-new-month-btn');


    function setSyncStatus(status, isError=false) {
        if (isError) {
            syncIndicator.classList.remove('bg-green-500','animate-pulse', 'bg-emerald-500', 'bg-yellow-500'); // Updated
            syncIndicator.classList.add('bg-red-500');
            syncStatus.textContent = status;
            syncError.textContent = status;
            syncError.classList.remove('hidden');
        } else if (status === 'synced') {
            syncIndicator.classList.remove('bg-gray-400','animate-pulse','bg-yellow-500','bg-red-500');
            syncIndicator.classList.add('bg-emerald-500'); // Updated
            syncStatus.textContent = "Synced";
            syncError.classList.add('hidden');
        } else if (status === 'saving') {
            syncIndicator.classList.remove('bg-emerald-500','bg-red-500'); // Updated
            syncIndicator.classList.add('bg-yellow-500','animate-pulse');
            syncStatus.textContent = "Saving...";
            syncError.classList.add('hidden'); // Hide error on saving
        } else {
            syncIndicator.classList.add('bg-gray-400','animate-pulse');
            syncStatus.textContent = status || "Connecting...";
            syncError.classList.add('hidden'); // Hide error on connecting
        }
    }

    function showLoggedOutUI() {
        if (unsubscribeListener) { unsubscribeListener(); unsubscribeListener = null; }
        userInfo.classList.add('hidden'); loginBtn.classList.remove('hidden');
        setSyncStatus("Waiting for login...");
        syncIndicator.classList.remove('bg-emerald-500','bg-red-500','bg-yellow-500'); // Updated
        syncIndicator.classList.add('bg-gray-400');
        clearLocalData();
        isDataLoaded = false;
        editingDay = null; // Ensure editing state is reset
        editingMonthlyTarget = null;
        buildUI(); // Rebuild UI to clear any editing states
    }
    function showLoggedInUI(user) {
        loginBtn.classList.add('hidden'); userInfo.classList.remove('hidden');
        userName.textContent = user.displayName; userEmail.textContent = user.email;
        setSyncStatus("Connecting...");
    }

    async function signInWithGoogle() {
        if (!auth) return;
        const provider = new GoogleAuthProvider();
        try {
            setSyncStatus("Logging in...");
            await signInWithPopup(auth, provider);
        } catch (err) {
            console.error(err); setSyncStatus(err.message, true);
        }
    }
    async function signOutUser() {
        if (!auth) return;
        try { await signOut(auth); } catch(err){ console.error(err); setSyncStatus(err.message,true); }
    }

    async function initFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('error'); // Only log errors
            isFirebaseReady = true;

            onAuthStateChanged(auth, async user => {
                if (user) {
                    userId = user.uid;
                    showLoggedInUI(user);
                    studyPlanDocRef = doc(db, `studyPlan/users/${userId}`); // Main document for user's study plan
                    listenForDataChanges();
                } else {
                    userId = null;
                    studyPlanDocRef = null;
                    showLoggedOutUI();
                }
            });
        } catch(err) {
            console.error("Firebase init error", err); setSyncStatus(err.message,true);
        }
    }

    /* ------------- APP DATA & UI BUILD ------------- */
    // Initial plan structure. This will now be dynamic and stored in Firestore.
    // We'll manage an array of months, each containing targets and weeks.
    let studyPlan = [
        {
            monthName: 'Monthly Plan (18.10.25 – 17.11.25)',
            monthlyTargets: [
                { title: '1st Week', description: 'Math Class 15, Basic View 1-150 pages', color: 'emerald' },
                { title: '2nd Week', description: 'Bangla Class 15, Computer hour 1-150 pages', color: 'sky' },
                { title: '3rd Week', description: 'Math Class 7, English lit. handbook complete', color: 'amber' },
                { title: '4th Week', description: 'Basic View 151-300 pages, Mental Ability classes 15', color: 'rose' }
            ],
            weeks: [
                {
                    weekName: '1st Week',
                    dailyPlan: [
                        { day: 'Day-1', subject: 'Quran', topic: 'Sura Anfal 8:45- 8:53' },
                        { day: 'Day-1', subject: 'Newspaper', topic: 'The Daily Star: Shibir-backed panel sweeps Rucsu polls, Lowest HSC pass rate in 21 years' },
                        { day: 'Day-1', subject: 'Vocabulary', topic: 'Sweep- বিজয় অর্জন, Clinch- সমর্থন করা, unbridled-অবাধ, outperform-ছাড়িয়ে যাওয়া, Steep-খাড়া, dismally- poorly, poor show- নিম্ন ফলাফল, lenient- কোমল, pronounced- সুস্পষ্ট।' },
                        { day: 'Day-1', subject: 'Math', topic: 'Ratio Class 12, 13' },
                        { day: 'Day-1', subject: 'Basic View', topic: 'Page 1-20' },
                        { day: 'Day-2', subject: 'Quran', topic: 'Sura Anfal 8:53-8:69' },
                        { day: 'Day-2', subject: 'Newspaper', topic: 'Editorial: Our children deserve clean air' },
                        { day: 'Day-2', subject: 'Vocabulary', topic: 'Unnerved- ভীত, dire- অত্যান্ত জরুরি, particulate matter- অতিক্ষুদ্র পদার্থ, brick kilns- ইট ভাটা, infants- শিশু, likelihood- সম্ভাবনা, ingrained- বদ্ধমূল, halt- থামা, perpetuate- অবিরাম করা,' },
                        { day: 'Day-2', subject: 'Math', topic: 'Ratio Class 14, 15' },
                        { day: 'Day-2', subject: 'Basic View', topic: '' },
                        { day: 'Day-3', subject: 'Quran', topic: 'Sura Anfal 8:70- Sura Tawbah 9:6' },
                        { day: 'Day-3', subject: 'Newspaper', topic: 'Editorial: Sabotage or not, the government must account for the recent fires' },
                        { day: 'Day-3', subject: 'Vocabulary', topic: 'Sabotage- নাশকতা, Devastating- ধ্বংশাত্মক, Blaze- তীব্র অগ্নিকাণ্ড, deploy- মোতায়েন করা, disrupt- বিঘ্ন ঘটানো, stranded- আটকে পড়া, spate- ঢল, undermine- দুর্বল করা, sow panic- আতঙ্ক ছড়ানো, arson- অগ্নিসংযোগ, resolute- দৃঢ় প্রতিজ্ঞ, beyond comprehension- বোধগমতার বাইরে, contingency- বিকল্প ব্যবস্থা, bode- ইঙ্গিত দেয়া/ পূর্বাভাস' },
                        { day: 'Day-3', subject: 'Math', topic: 'Class 16, 17' },
                        { day: 'Day-3', subject: 'Basic View', topic: '' },
                        { day: 'Day-4', subject: 'Quran', topic: 'Sura Tawbah 9:7- 9:20' },
                        { day: 'Day-4', subject: 'Newspaper', topic: '' },
                        { day: 'Day-4', subject: 'Vocabulary', topic: '' },
                        { day: 'Day-4', subject: 'Math', topic: 'Class 18, 19' },
                        { day: 'Day-4', subject: 'Basic View', topic: '' },
                        { day: 'Day-5', subject: 'Quran', topic: 'Sura Tawbah 9:21- 9:31' },
                        { day: 'Day-5', subject: 'Newspaper', topic: 'Tripura mob killing of Bangladeshis exposes the accountability gap' },
                        { day: 'Day-5', subject: 'Vocabulary', topic: 'Gruesome-ভয়াবহ, heinous-নিকৃষ্ট, sanctity- পবিত্রতা, frontier vengeance- সীমান্ত প্রতিহিংসা, porous- ছিদ্রযুক্ত, flux- অবিরাম গতি, illicit- অবৈধ, intricate- সূক্ষ্ণ, backdrop- পটভূমি, precarious- ঝুঁকিপূর্ণ, pledged- প্রতিজ্ঞা করা, curb- দমন করা, intrusions- onadhikar probes, repatriate- নিজ দেশে ফেরত পাঠানো, patrols- টহল, usher in- শুরু করা, restraint- সংগম, hollow- ফাঁপা, invoking- আহ্বান করা, culminating-শেষ করা, perpetrators- অপরাধী' },
                        { day: 'Day-5', subject: 'Math', topic: 'Class 20, 21' },
                        { day: 'Day-5', subject: 'Basic View', topic: '' },
                        { day: 'Day-6', subject: 'Quran', topic: 'Sura Tawbah 9:31- 9:41' },
                        { day: 'Day-6', subject: 'Newspaper', topic: '' },
                        { day: 'Day-6', subject: 'Vocabulary', topic: '' },
                        { day: 'Day-6', subject: 'Math', topic: '' },
                        { day: 'Day-6', subject: 'Basic View', topic: '' },
                        { day: 'Day-7', subject: 'Quran', topic: '' },
                        { day: 'Day-7', subject: 'Newspaper', topic: '' },
                        { day: 'Day-7', subject: 'Vocabulary', topic: '' },
                        { day: 'Day-7', subject: 'Math', topic: '' },
                        { day: 'Day-7', subject: 'Basic View', topic: '' },
                    ],
                    vocabStories: {
                        'Day-1': "The young prince planned to <strong>sweep</strong> the election. He needed to <strong>clinch</strong> the final vote from the stubborn council. ...",
                        'Day-2': "The old scientist felt <strong>unnerved</strong> by the sky's strange color. ...",
                        'Day-3': "The empress was certain it was <strong>sabotage</strong>. ...",
                        'Day-5': "The detective inspected the <strong>gruesome</strong> crime scene. ..."
                    },
                    progress: {} // To store checkbox states and dates for this week
                }
            ]
        }
    ];
    let initialStudyPlan = JSON.parse(JSON.stringify(studyPlan)); // To restore on cancel

    // Task weights & progress
    const taskWeights = {'Quran':5/7,'Newspaper':5/7,'Vocabulary':10/7,'Math':40/7,'Basic View':40/7, 'Default': 10}; // Added default
    const colorClasses = ['emerald', 'sky', 'amber', 'rose']; // For monthly targets

    window.updateWeeklyProgress = function(monthIndex, weekIndex) {
        const weekData = studyPlan[monthIndex].weeks[weekIndex];
        let currentWeight = 0;
        let maxWeight = 0;

        // Calculate maxWeight for the current week based on its dailyPlan
        weekData.dailyPlan.forEach(item => {
            if ((item.subject || item.topic) && taskWeights[item.subject]) {
                maxWeight += taskWeights[item.subject];
            } else if ((item.subject || item.topic) && item.subject) { // Handle subjects not explicitly in taskWeights
                maxWeight += taskWeights['Default'];
            }
        });

        const checkedTasks = new Set(); // Use a Set to store unique completed tasks
        document.querySelectorAll(`.task-checkbox[data-month="${monthIndex}"][data-week="${weekIndex}"]`).forEach(cb => {
            const day = cb.dataset.day;
            const subject = cb.dataset.subject;
            const uniqueId = `${day}-${subject}`; // Unique identifier for a task

            if (cb.checked && !checkedTasks.has(uniqueId)) {
                if (subject && taskWeights[subject]) {
                    currentWeight += taskWeights[subject];
                } else if (subject) { // For subjects not in taskWeights
                    currentWeight += taskWeights['Default'];
                }
                checkedTasks.add(uniqueId);
            }
        });

        const percentage = (maxWeight > 0) ? (currentWeight / maxWeight) * 100 : 0;
        const progressLabel = document.getElementById(`weekly-progress-label-${monthIndex}-${weekIndex}`);
        const progressBar = document.getElementById(`weekly-progress-bar-${monthIndex}-${weekIndex}`);

        if (progressLabel) progressLabel.textContent = `Weekly Progress: ${percentage.toFixed(0)}%`;
        if (progressBar) progressBar.style.width = `${percentage}%`;
    }

    /* ---------- Helpers for Vocab UI ---------- */
    function createVocabElementFromPair(pair) {
        const parts = pair.split('-');
        if (parts.length >= 2 && parts[0].trim() && parts[1].trim()) {
            const eng = parts[0].trim();
            const ban = parts[1].trim().replace(/।/g, ''); // Remove all Bengali full stops
            const container = document.createElement('div');
            container.classList.add('vocab-item');
            container.setAttribute('tabindex', '0');

            // Word Span
            const engSpan = document.createElement('span');
            engSpan.classList.add('vocab-word');
            engSpan.textContent = eng;
            container.appendChild(engSpan);

            // Meaning Tooltip
            const banSpan = document.createElement('span');
            banSpan.classList.add('vocab-meaning');
            banSpan.textContent = ban;
            container.appendChild(banSpan);

            return container;
        } else if (pair.trim()) {
            const span = document.createElement('span');
            span.classList.add('vocab-item'); // Apply vocab-item styling even for single words
            span.textContent = pair.trim();
            return span;
        }
        return null;
    }

    // Build UI
    function buildUI() {
        monthlyTargetsContainer.innerHTML = '';
        studyPlanContainer.innerHTML = '';

        studyPlan.forEach((monthData, monthIndex) => {
            // Render Monthly Targets
            const monthTargetsDiv = document.createElement('div');
            monthTargetsDiv.classList.add('grid', 'grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-4', 'gap-5', 'mb-10');
            monthTargetsContainer.appendChild(monthTargetsDiv);

            // Month Title for Targets (and editing functionality)
            const monthTitleDiv = document.createElement('div');
            monthTitleDiv.classList.add('mb-4', 'flex', 'items-center', 'justify-between');
            if (editingMonthlyTarget === `title-${monthIndex}`) {
                monthTitleDiv.innerHTML = `
                    <input type="text" class="editable-field text-2xl font-semibold text-gray-700 flex-grow mr-2" value="${monthData.monthName}" data-month-index="${monthIndex}" data-field-type="monthName">
                    <div class="edit-buttons flex gap-2">
                        <button class="px-3 py-1 rounded-md font-medium text-xs shadow-sm transition bg-emerald-600 text-white hover:bg-emerald-700" data-month-index="${monthIndex}" data-field-type="monthName" onclick="saveMonthlyTargetEdits(event)">Save</button>
                        <button class="px-3 py-1 rounded-md border border-gray-300 text-xs text-gray-700 hover:bg-gray-100 shadow-sm" data-month-index="${monthIndex}" data-field-type="monthName" onclick="cancelMonthlyTargetEdits(event)">Cancel</button>
                    </div>
                `;
            } else {
                monthTitleDiv.innerHTML = `
                    <h2 class="text-2xl font-semibold text-gray-700">${monthData.monthName}</h2>
                    <button class="px-3 py-1 rounded-md border border-gray-300 text-xs text-gray-700 bg-white hover:bg-gray-50 shadow-sm transition" data-month-index="${monthIndex}" data-field-type="monthName" onclick="toggleMonthlyTargetEditMode(event)">Edit Title</button>
                `;
            }
            monthlyTargetsContainer.appendChild(monthTitleDiv);


            monthData.monthlyTargets.forEach((target, targetIndex) => {
                const targetCard = document.createElement('div');
                targetCard.classList.add('p-6', 'rounded-xl', 'shadow-lg', 'border', 'border-gray-100', `bg-white`);

                const titleId = `monthly-target-title-${monthIndex}-${targetIndex}`;
                const descriptionId = `monthly-target-description-${monthIndex}-${targetIndex}`;

                const isEditing = editingMonthlyTarget === `${monthIndex}-${targetIndex}`;

                targetCard.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        ${isEditing ?
                            `<input type="text" id="${titleId}" class="editable-field font-semibold text-lg text-${target.color}-700 w-full" value="${target.title}" data-month-index="${monthIndex}" data-target-index="${targetIndex}" data-field-type="title">` :
                            `<h3 class="font-semibold text-lg text-${target.color}-700">${target.title}</h3>`
                        }
                    </div>
                    ${isEditing ?
                        `<textarea id="${descriptionId}" class="editable-field text-gray-600 w-full" rows="3" data-month-index="${monthIndex}" data-target-index="${targetIndex}" data-field-type="description">${target.description}</textarea>` :
                        `<p class="text-gray-600">${target.description}</p>`
                    }
                    <div class="mt-4 edit-buttons flex gap-2">
                        ${isEditing ?
                            `<button class="px-3 py-1 rounded-md font-medium text-xs shadow-sm transition bg-emerald-600 text-white hover:bg-emerald-700" data-month-index="${monthIndex}" data-target-index="${targetIndex}" onclick="saveMonthlyTargetEdits(event)">Save</button>
                             <button class="px-3 py-1 rounded-md border border-gray-300 text-xs text-gray-700 hover:bg-gray-100 shadow-sm" data-month-index="${monthIndex}" data-target-index="${targetIndex}" onclick="cancelMonthlyTargetEdits(event)">Cancel</button>` :
                            `<button class="px-3 py-1 rounded-md border border-gray-300 text-xs text-gray-700 bg-white hover:bg-gray-50 shadow-sm transition" data-month-index="${monthIndex}" data-target-index="${targetIndex}" onclick="toggleMonthlyTargetEditMode(event)">Edit</button>`
                        }
                    </div>
                `;
                monthTargetsDiv.appendChild(targetCard);
            });

            // Render Weekly Plans for the month
            monthData.weeks.forEach((week, weekIndex) => {
                const weekSection = document.createElement('div');
                weekSection.classList.add('weekly-plan-section', 'mb-10');
                weekSection.id = `month-${monthIndex}-week-${weekIndex}-section`;

                weekSection.innerHTML = `
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Daily Plan – ${week.weekName}</h2>
                    <div class="progress-container">
                        <div class="flex justify-between mb-1">
                            <span id="weekly-progress-label-${monthIndex}-${weekIndex}" class="text-base font-medium text-emerald-700">Weekly Progress: 0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3.5 progress-bar-outer shadow-inner">
                            <div id="weekly-progress-bar-${monthIndex}-${weekIndex}" class="bg-emerald-600 h-3.5 rounded-full progress-bar-inner" style="width:0%"></div>
                        </div>
                    </div>
                    <!-- Desktop Table -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 full-table table-wrapper">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">Day</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12">Subject</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-6/12">Topic</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/12">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white" id="daily-plan-body-${monthIndex}-${weekIndex}"></tbody>
                        </table>
                    </div>
                    <!-- Mobile Cards -->
                    <div class="space-y-4 mobile-cards" id="daily-plan-cards-${monthIndex}-${weekIndex}"></div>
                `;
                studyPlanContainer.appendChild(weekSection);

                const tableBody = weekSection.querySelector(`#daily-plan-body-${monthIndex}-${weekIndex}`);
                const mobileCardsContainer = weekSection.querySelector(`#daily-plan-cards-${monthIndex}-${weekIndex}`);
                let currentDayInWeek = '';

                week.dailyPlan.forEach((item, itemIndex) => {
                    const uniqueDayId = `${item.day}`; // Just the day number within the week
                    const isEditingCurrentDay = (editingDay === `month${monthIndex}-week${weekIndex}-${item.day}`);

                    // Desktop row
                    const row = document.createElement('tr');
                    row.classList.add('task-item');
                    row.setAttribute('data-month', monthIndex);
                    row.setAttribute('data-week', weekIndex);
                    row.setAttribute('data-day', item.day);
                    row.setAttribute('data-subject', item.subject);
                    row.setAttribute('data-item-index', itemIndex);

                    const dayCell = document.createElement('td');
                    dayCell.classList.add('px-6', 'py-4', 'text-sm', 'font-medium', 'text-gray-900', 'align-top');

                    if (item.day !== currentDayInWeek) {
                        row.classList.add('day-group-start');
                        const dayText = document.createElement('span');
                        dayText.textContent = item.day;
                        dayCell.appendChild(dayText);

                        const dateInputDiv = document.createElement('div');
                        dateInputDiv.classList.add('date-input-desktop', 'mt-2');
                        dateInputDiv.setAttribute('data-month', monthIndex);
                        dateInputDiv.setAttribute('data-week', weekIndex);
                        dateInputDiv.setAttribute('data-day-input', item.day);
                        dateInputDiv.style.display = 'none'; // Hidden by default
                        const dateInputId = `date-${monthIndex}-${weekIndex}-${item.day}`;
                        dateInputDiv.innerHTML = `
                            <div class="flex flex-col gap-1">
                                <label for="${dateInputId}" class="text-xs font-medium text-gray-600">Completion Date:</label>
                                <input type="text" id="${dateInputId}" class="form-input p-1 border border-gray-300 rounded-md shadow-sm text-sm w-full max-w-xs editable-field" placeholder="e.g., 24/10/25">
                            </div>
                        `;
                        dateInputDiv.querySelector('input').addEventListener('input', onInputChange);
                        dayCell.appendChild(dateInputDiv);
                        currentDayInWeek = item.day;
                    }
                    row.appendChild(dayCell);

                    const subjectCell = document.createElement('td');
                    subjectCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-500', 'font-medium', 'align-top');
                    if (isEditingCurrentDay) {
                        const subjectInput = document.createElement('input');
                        subjectInput.type = 'text';
                        subjectInput.classList.add('editable-field');
                        subjectInput.value = item.subject;
                        subjectInput.setAttribute('data-field-type', 'subject');
                        subjectInput.setAttribute('data-month', monthIndex);
                        subjectInput.setAttribute('data-week', weekIndex);
                        subjectInput.setAttribute('data-day', item.day);
                        subjectInput.setAttribute('data-item-index', itemIndex);
                        subjectInput.setAttribute('data-old-subject', item.subject); // Store original subject for lookup
                        subjectCell.appendChild(subjectInput);
                    } else {
                        subjectCell.textContent = item.subject;
                    }
                    row.appendChild(subjectCell);


                    const topicCell = document.createElement('td');
                    topicCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-600', 'align-top', 'whitespace-normal', 'break-words');
                    // unique id for topic cell for persistence / updates
                    const topicCellId = `topic-${monthIndex}-${weekIndex}-${item.day}-${item.subject}-${itemIndex}`.replace(/\s+/g, '_');
                    topicCell.id = topicCellId;

                    if (isEditingCurrentDay) {
                        const topicInput = document.createElement(item.subject === 'Vocabulary' || item.subject === 'Newspaper' || item.subject === 'Basic View' ? 'textarea' : 'input');
                        if (topicInput.tagName === 'INPUT') topicInput.type = 'text';
                        topicInput.classList.add('editable-field');
                        topicInput.value = item.topic || '';
                        if (item.subject === 'Vocabulary') topicInput.placeholder = 'Enter comma separated pairs like: Word- বাংলা, ...';
                        topicInput.setAttribute('data-field-type', 'topic');
                        topicInput.setAttribute('data-month', monthIndex);
                        topicInput.setAttribute('data-week', weekIndex);
                        topicInput.setAttribute('data-day', item.day);
                        topicInput.setAttribute('data-subject', item.subject);
                        topicInput.setAttribute('data-item-index', itemIndex);
                        topicCell.appendChild(topicInput);

                        // "Add New Row" button appears after topic input for a day in edit mode
                        const lastItemForDay = week.dailyPlan.filter(d => d.day === item.day).pop();
                        if (item === lastItemForDay) { // Only show once per day group
                            const addRowBtn = document.createElement('button');
                            addRowBtn.textContent = 'Add New Row';
                            addRowBtn.classList.add('read-story-btn', 'mt-2', 'mb-2'); // Reusing some styles
                            addRowBtn.setAttribute('data-month', monthIndex);
                            addRowBtn.setAttribute('data-week', weekIndex);
                            addRowBtn.setAttribute('data-day', item.day);
                            addRowBtn.setAttribute('data-insert-after-index', itemIndex); // Insert after this item
                            addRowBtn.addEventListener('click', addNewRow);
                            topicCell.appendChild(addRowBtn);
                        }


                        if (item.subject === 'Basic View') { // Story field for this specific Basic View entry
                            const storyFieldWrapper = document.createElement('div');
                            storyFieldWrapper.classList.add('mt-4');
                            const storyLabel = document.createElement('label'); storyLabel.textContent = 'Vocabulary Story (optional)'; storyLabel.classList.add('block', 'text-sm', 'font-medium', 'text-gray-700', 'mb-1');
                            const storyArea = document.createElement('textarea');
                            storyArea.classList.add('editable-field');
                            storyArea.rows = 4;
                            storyArea.placeholder = 'HTML allowed (e.g., use <strong>word</strong>)';
                            storyArea.value = week.vocabStories[item.day] || '';
                            storyArea.setAttribute('data-field-type', 'story');
                            storyArea.setAttribute('data-month', monthIndex);
                            storyArea.setAttribute('data-week', weekIndex);
                            storyArea.setAttribute('data-day', item.day);
                            storyFieldWrapper.appendChild(storyLabel);
                            storyFieldWrapper.appendChild(storyArea);
                            topicCell.appendChild(storyFieldWrapper);
                        }

                    } else {
                        if (item.subject === 'Vocabulary' && item.topic) {
                            const wrapper = document.createElement('div');
                            wrapper.classList.add('flex', 'flex-wrap', 'gap-2', 'py-1');
                            const pairs = item.topic.split(/, |।/).filter(p => p.trim());
                            pairs.forEach(p => {
                                const el = createVocabElementFromPair(p);
                                if (el) wrapper.appendChild(el);
                            });
                            topicCell.appendChild(wrapper);
                            if (pairs.length > 0 && week.vocabStories[item.day]) {
                                const storyBtn = document.createElement('button');
                                storyBtn.textContent = 'Read story';
                                storyBtn.classList.add('read-story-btn');
                                storyBtn.setAttribute('data-month', monthIndex);
                                storyBtn.setAttribute('data-week', weekIndex);
                                storyBtn.setAttribute('data-day', item.day);
                                topicCell.appendChild(storyBtn);
                            }
                        } else {
                            const span = document.createElement('span');
                            span.textContent = item.topic || '-';
                            topicCell.appendChild(span);
                        }
                    }
                    row.appendChild(topicCell);

                    const actionsCell = document.createElement('td');
                    actionsCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-500', 'align-top', 'flex', 'items-start', 'gap-2');

                    // Checkbox
                    if (item.subject || item.topic) {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.classList.add('task-checkbox');
                        checkbox.setAttribute('data-month', monthIndex);
                        checkbox.setAttribute('data-week', weekIndex);
                        checkbox.setAttribute('data-day', item.day);
                        checkbox.setAttribute('data-subject', item.subject);
                        checkbox.addEventListener('change', onInputChange);
                        actionsCell.appendChild(checkbox);
                    }

                    // Edit/Save/Cancel buttons for daily plan
                    const lastItemForDay = week.dailyPlan.filter(d => d.day === item.day).pop();
                    if (item === lastItemForDay) { // Attach buttons only to the last subject row for the day
                        const editButtonContainer = document.createElement('div');
                        editButtonContainer.classList.add('edit-buttons', 'flex', 'flex-col', 'gap-2', 'ml-2');
                        const editSaveBtn = document.createElement('button');
                        editSaveBtn.classList.add('px-3', 'py-1', 'rounded-md', 'font-medium', 'text-xs', 'shadow-sm', 'transition');
                        editSaveBtn.setAttribute('data-month', monthIndex);
                        editSaveBtn.setAttribute('data-week', weekIndex);
                        editSaveBtn.setAttribute('data-day', item.day);

                        if (isEditingCurrentDay) {
                            editSaveBtn.textContent = 'Save';
                            editSaveBtn.classList.add('bg-emerald-600', 'text-white', 'hover:bg-emerald-700');
                            editSaveBtn.addEventListener('click', saveDayEdits);

                            const cancelBtn = document.createElement('button');
                            cancelBtn.textContent = 'Cancel';
                            cancelBtn.classList.add('px-3', 'py-1', 'rounded-md', 'border', 'border-gray-300', 'text-xs', 'text-gray-700', 'hover:bg-gray-100', 'shadow-sm');
                            cancelBtn.setAttribute('data-month', monthIndex);
                            cancelBtn.setAttribute('data-week', weekIndex);
                            cancelBtn.setAttribute('data-day', item.day);
                            cancelBtn.addEventListener('click', cancelDayEdits);
                            editButtonContainer.appendChild(cancelBtn);
                        } else {
                            editSaveBtn.textContent = 'Edit';
                            editSaveBtn.classList.add('bg-white', 'border', 'border-gray-300', 'text-gray-700', 'hover:bg-gray-50');
                            editSaveBtn.addEventListener('click', toggleDayEditMode);
                        }
                        editButtonContainer.appendChild(editSaveBtn);
                        actionsCell.appendChild(editButtonContainer);
                    }

                    row.appendChild(actionsCell);
                    tableBody.appendChild(row);

                    // Mobile card
                    if (item.subject || item.topic) {
                        const card = document.createElement('div');
                        card.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow', 'card-item');
                        card.setAttribute('data-month', monthIndex);
                        card.setAttribute('data-week', weekIndex);
                        card.setAttribute('data-day', item.day);
                        card.setAttribute('data-item-index', itemIndex);

                        let headerHTML = '';
                        let dateInputMobileHTML = '';
                        const dateInputMobileId = `date-mobile-${monthIndex}-${weekIndex}-${item.day}`;
                        if (item.day !== currentMobileDay) {
                            headerHTML = `<h3 class="font-bold text-lg text-gray-800 mb-2">${item.day}</h3>`;
                            dateInputMobileHTML = `
                                <div class="date-input-mobile mt-2 mb-3 p-3 bg-emerald-50 rounded-md" data-month="${monthIndex}" data-week="${weekIndex}" data-day-input="${item.day}" style="display:none;">
                                    <div class="flex items-center gap-2">
                                        <label for="${dateInputMobileId}" class="text-sm font-medium text-gray-700">Completion Date:</label>
                                        <input type="text" id="${dateInputMobileId}" class="form-input p-1 border border-gray-300 rounded-md shadow-sm text-sm w-full editable-field" placeholder="e.g., 24/10/25">
                                    </div>
                                </div>
                            `;
                            currentMobileDay = item.day;
                        }
                        let subjectContent = item.subject;
                        let topicMobileContent = '';
                        let storyMobileContent = '';
                        let editButtonsMobileHTML = '';
                        let addRowMobileBtnHTML = '';

                        if (isEditingCurrentDay) {
                            subjectContent = `<input type="text" class="editable-field" value="${item.subject}" data-field-type="subject" data-month="${monthIndex}" data-week="${weekIndex}" data-day="${item.day}" data-item-index="${itemIndex}" data-old-subject="${item.subject}">`;

                            const topicInputType = (item.subject === 'Vocabulary' || item.subject === 'Newspaper' || item.subject === 'Basic View') ? 'textarea' : 'input';
                            topicMobileContent = `<${topicInputType} class="editable-field" rows="${topicInputType === 'textarea' ? '2' : '1'}" placeholder="${item.subject === 'Vocabulary' ? 'Enter comma separated pairs like: Word- বাংলা, ...' : 'Enter topic'}" data-field-type="topic" data-month="${monthIndex}" data-week="${weekIndex}" data-day="${item.day}" data-subject="${item.subject}" data-item-index="${itemIndex}">${item.topic || ''}</${topicInputType}>`;

                            if (item === lastItemForDay) {
                                addRowMobileBtnHTML = `
                                    <button class="read-story-btn mt-2 mb-2" data-month="${monthIndex}" data-week="${weekIndex}" data-day="${item.day}" data-insert-after-index="${itemIndex}" onclick="addNewRow(event)">Add New Row</button>
                                `;
                            }

                            if (item.subject === 'Basic View') {
                                storyMobileContent = `
                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Vocabulary Story (optional)</label>
                                        <textarea class="editable-field" rows="4" placeholder="HTML allowed (e.g., use <strong>word</strong>)" data-field-type="story" data-month="${monthIndex}" data-week="${weekIndex}" data-day="${item.day}">${week.vocabStories[item.day] || ''}</textarea>
                                    </div>
                                `;
                            }

                            // Mobile edit buttons
                            if (item === lastItemForDay) {
                                editButtonsMobileHTML = `
                                    <div class="flex flex-col gap-2 mt-4">
                                        <button class="px-3 py-1 rounded-md font-medium text-xs shadow-sm transition bg-emerald-600 text-white hover:bg-emerald-700" data-month="${monthIndex}" data-week="${weekIndex}" data-day="${item.day}" onclick="saveDayEdits(event)">Save</button>
                                        <button class="px-3 py-1 rounded-md border border-gray-300 text-xs text-gray-700 hover:bg-gray-100 shadow-sm" data-month="${monthIndex}" data-week="${weekIndex}" data-day="${item.day}" onclick="cancelDayEdits(event)">Cancel</button>
                                    </div>
                                `;
                            }

                        } else {
                            if (item.subject === 'Vocabulary' && item.topic) {
                                const pairs = item.topic.split(/, |।/).filter(p => p.trim());
                                topicMobileContent = '<div class="flex flex-wrap gap-2 py-1">';
                                pairs.forEach(p => {
                                    const el = createVocabElementFromPair(p);
                                    if (el) topicMobileContent += el.outerHTML;
                                });
                                topicMobileContent += '</div>';
                                if (pairs.length > 0 && week.vocabStories[item.day]) topicMobileContent += `<button class="read-story-btn" data-month="${monthIndex}" data-week="${weekIndex}" data-day="${item.day}">Read story</button>`;
                            } else {
                                topicMobileContent = `<span class="text-gray-600">${item.topic || '-'}</span>`;
                            }

                            // Mobile edit button (non-editing state)
                            if (item === lastItemForDay) {
                                editButtonsMobileHTML = `
                                    <div class="flex mt-4">
                                        <button class="px-3 py-1 rounded-md border border-gray-300 text-xs text-gray-700 bg-white hover:bg-gray-50 shadow-sm transition" data-month="${monthIndex}" data-week="${weekIndex}" data-day="${item.day}" onclick="toggleDayEditMode(event)">Edit</button>
                                    </div>
                                `;
                            }
                        }

                        card.innerHTML = `
                            ${headerHTML}
                            ${dateInputMobileHTML}
                            <div class="flex items-start">
                                <input type="checkbox" class="task-checkbox mt-1" data-month="${monthIndex}" data-week="${weekIndex}" data-day="${item.day}" data-subject="${item.subject}">
                                <div class="ml-2 flex-1 min-w-0">
                                    <p class="font-medium text-gray-700">${subjectContent}</p>
                                    <div class="text-sm break-words" id="topic-mobile-${monthIndex}-${weekIndex}-${item.day}-${item.subject}-${itemIndex}">${topicMobileContent}</div>
                                    ${addRowMobileBtnHTML}
                                    ${storyMobileContent}
                                    ${editButtonsMobileHTML}
                                </div>
                            </div>
                        `;
                        // checkbox listener
                        card.querySelector('.task-checkbox').addEventListener('change', onInputChange);
                        // date input listener if present
                        if (card.querySelector(`#${dateInputMobileId}`)) card.querySelector(`#${dateInputMobileId}`).addEventListener('input', onInputChange);

                        // attach vocab click toggles for mobile items that were put as innerHTML
                        card.querySelectorAll('.vocab-item').forEach(vc => {
                            vc.addEventListener('click', function(ev) {
                                ev.stopPropagation();
                                document.querySelectorAll('.vocab-item.active').forEach(i => {
                                    if (i !== this) i.classList.remove('active');
                                });
                                this.classList.toggle('active');
                            });
                        });
                        mobileCardsContainer.appendChild(card);
                    }
                });

                updateWeeklyProgress(monthIndex, weekIndex);

                // Add New Week Button for the current month
                if (weekIndex < 3) { // Max 4 weeks
                    const addNewWeekButton = document.createElement('button');
                    addNewWeekButton.textContent = `Add New Week (${monthData.weeks.length + 1} of 4)`;
                    addNewWeekButton.classList.add('mt-8', 'mx-auto', 'block', 'bg-sky-600', 'hover:bg-sky-700', 'text-white', 'font-bold', 'py-2', 'px-4', 'rounded-lg', 'shadow-md', 'transition-colors');
                    addNewWeekButton.setAttribute('data-month', monthIndex);
                    addNewWeekButton.addEventListener('click', addNewWeek);
                    studyPlanContainer.appendChild(addNewWeekButton);
                }
            });

            // Add New Month Button - moved to the end of the entire studyPlanContainer
        });

        // global click to close vocab tooltips
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.vocab-item')) {
                document.querySelectorAll('.vocab-item.active').forEach(v => v.classList.remove('active'));
            }
        });
        // This will be handled by applyLoadedData() after initial build
        // updateWeeklyProgress();
    }

    // Input change handler (checkboxes & date inputs)
    function onInputChange(event) {
        if (!isDataLoaded) return; // Don't allow saves before initial data load
        const el = event.target;
        const monthIndex = el.dataset.month;
        const weekIndex = el.dataset.week;

        if (el.classList.contains('task-checkbox')) {
            const day = el.dataset.day;
            const subject = el.dataset.subject;
            const uniqueKey = `${day}-${subject}`;

            // Update the in-memory progress for this week
            if (!studyPlan[monthIndex].weeks[weekIndex].progress) {
                studyPlan[monthIndex].weeks[weekIndex].progress = {};
            }
            studyPlan[monthIndex].weeks[weekIndex].progress[uniqueKey] = el.checked;

            // set all checkboxes for this day & subject in this week to same state (keeps table+mobile synced)
            document.querySelectorAll(`.task-checkbox[data-month="${monthIndex}"][data-week="${weekIndex}"][data-day="${day}"][data-subject="${subject}"]`).forEach(cb => {
                cb.checked = el.checked;
                const taskItem = cb.closest('.task-item, .card-item');
                if (taskItem) taskItem.classList.toggle('completed', el.checked);
            });
            checkDayCompletion(monthIndex, weekIndex, day);
            updateWeeklyProgress(monthIndex, weekIndex);
            debouncedSaveData(); // Save immediately on checkbox change
        } else if (el.tagName === 'INPUT' && el.type === 'text' && (el.id.startsWith('date-') || el.id.startsWith('date-mobile-'))) {
            const day = el.dataset.dayInput;
            const key = `${day}-date`;

            // Update in-memory data
            if (!studyPlan[monthIndex].weeks[weekIndex].progress) {
                studyPlan[monthIndex].weeks[weekIndex].progress = {};
            }
            studyPlan[monthIndex].weeks[weekIndex].progress[key] = el.value;


            // date input: keep desktop & mobile in sync
            const desktop = document.getElementById(`date-${monthIndex}-${weekIndex}-${day}`);
            const mobile = document.getElementById(`date-mobile-${monthIndex}-${weekIndex}-${day}`);
            if (desktop) desktop.value = el.value;
            if (mobile) mobile.value = el.value;
            debouncedSaveData(); // Save immediately on date input change
        }
    }

 // Check if all subjects for a day are completed to show date input
    window.checkDayCompletion = function(monthIndex, weekIndex, day) {
        const allCheckboxesForDay = document.querySelectorAll(`.task-checkbox[data-month="${monthIndex}"][data-week="${weekIndex}"][data-day="${day}"]`);
        if (allCheckboxesForDay.length === 0) return;

        let allTasksCompleted = true; // Renamed for clarity
        const subjectsInDay = new Set(Array.from(allCheckboxesForDay).map(cb => cb.dataset.subject));

        subjectsInDay.forEach(subject => {
            const boxes = document.querySelectorAll(`.task-checkbox[data-month="${monthIndex}"][data-week="${weekIndex}"][data-day="${day}"][data-subject="${subject}"]`);
            const subjectHasChecked = Array.from(boxes).some(cb => cb.checked);
            if (!subjectHasChecked) allTasksCompleted = false;
        });

        // Show/hide desktop & mobile date inputs for this specific day
        const desktopInput = document.getElementById(`date-${monthIndex}-${weekIndex}-${day}`);
        const mobileInput = document.getElementById(`date-mobile-${monthIndex}-${weekIndex}-${day}`);

        if (allTasksCompleted) {
            if (desktopInput) desktopInput.parentElement.style.display = 'block';
            if (mobileInput) mobileInput.parentElement.style.display = 'block';
        } else {
            if (desktopInput) desktopInput.parentElement.style.display = 'none';
            if (mobileInput) mobileInput.parentElement.style.display = 'none';
        }

        // toggle completed class on desktop rows & mobile cards for visual sync
        document.querySelectorAll(`.task-item[data-day="${day}"], .card-item[data-day="${day}"]`).forEach(el => {
            // If any subject in this day is checked, consider individual items toggled already by change event.
            // Here we ensure rows with same day-subject are marked completed only if their checkbox is checked.
            // Leave this as no-op for now to avoid overriding per-task completed states.
        });

        // Update the weekly progress bar for this week
        updateWeeklyProgress(monthIndex, weekIndex);
    }

    /* ---------- Add / Remove / Insert helpers ---------- */

    // Adds a new empty row after a given index in the week's dailyPlan.
    // Event may be click (mobile) or programmatic call.
    function addNewRow(event) {
        // Determine attributes (support event or programmatic call where event is an object)
        let el = event && event.currentTarget ? event.currentTarget : event;
        if (!el) return;
        const monthIndex = parseInt(el.dataset.month, 10);
        const weekIndex = parseInt(el.dataset.week, 10);
        const insertAfterIndex = parseInt(el.dataset['insertAfterIndex'] || el.dataset['insert-after-index'] || el.getAttribute('data-insert-after-index'), 10);

        if (isNaN(monthIndex) || isNaN(weekIndex) || isNaN(insertAfterIndex)) return;

        const week = studyPlan[monthIndex].weeks[weekIndex];
        // Insert a new blank task row after the specified index (keeps same day)
        const refItem = week.dailyPlan[insertAfterIndex];
        const newItem = { day: refItem ? refItem.day : `Day-1`, subject: '', topic: '' };
        week.dailyPlan.splice(insertAfterIndex + 1, 0, newItem);

        // Keep initialStudyPlan snapshot in sync for cancel operations
        initialStudyPlan = JSON.parse(JSON.stringify(studyPlan));

        buildUI();
        debouncedSaveData();
    }

    // Add a new week within a month (max 4 weeks). New week gets 7 days template.
    function addNewWeek(event) {
        const el = event.currentTarget || event;
        const monthIndex = parseInt(el.dataset.month, 10);
        if (isNaN(monthIndex)) return;

        const month = studyPlan[monthIndex];
        if (!month) return;
        if (!month.weeks) month.weeks = [];

        if (month.weeks.length >= 4) {
            alert('Maximum 4 weeks per month reached.');
            return;
        }

        const weekNumber = month.weeks.length + 1;
        const newWeek = {
            weekName: `${weekNumber}${getWeekSuffix(weekNumber)} Week`,
            dailyPlan: [
                { day: 'Day-1', subject: 'Quran', topic: '' },
                { day: 'Day-1', subject: 'Newspaper', topic: '' },
                { day: 'Day-1', subject: 'Vocabulary', topic: '' },
                { day: 'Day-1', subject: 'Math', topic: '' },
                { day: 'Day-1', subject: 'Basic View', topic: '' },
                { day: 'Day-2', subject: 'Quran', topic: '' },
                { day: 'Day-2', subject: 'Newspaper', topic: '' },
                { day: 'Day-2', subject: 'Vocabulary', topic: '' },
                { day: 'Day-2', subject: 'Math', topic: '' },
                { day: 'Day-2', subject: 'Basic View', topic: '' },
                { day: 'Day-3', subject: 'Quran', topic: '' },
                { day: 'Day-3', subject: 'Newspaper', topic: '' },
                { day: 'Day-3', subject: 'Vocabulary', topic: '' },
                { day: 'Day-3', subject: 'Math', topic: '' },
                { day: 'Day-3', subject: 'Basic View', topic: '' },
                { day: 'Day-4', subject: 'Quran', topic: '' },
                { day: 'Day-4', subject: 'Newspaper', topic: '' },
                { day: 'Day-4', subject: 'Vocabulary', topic: '' },
                { day: 'Day-4', subject: 'Math', topic: '' },
                { day: 'Day-4', subject: 'Basic View', topic: '' },
                { day: 'Day-5', subject: 'Quran', topic: '' },
                { day: 'Day-5', subject: 'Newspaper', topic: '' },
                { day: 'Day-5', subject: 'Vocabulary', topic: '' },
                { day: 'Day-5', subject: 'Math', topic: '' },
                { day: 'Day-5', subject: 'Basic View', topic: '' },
                { day: 'Day-6', subject: 'Quran', topic: '' },
                { day: 'Day-6', subject: 'Newspaper', topic: '' },
                { day: 'Day-6', subject: 'Vocabulary', topic: '' },
                { day: 'Day-6', subject: 'Math', topic: '' },
                { day: 'Day-6', subject: 'Basic View', topic: '' },
                { day: 'Day-7', subject: 'Quran', topic: '' },
                { day: 'Day-7', subject: 'Newspaper', topic: '' },
                { day: 'Day-7', subject: 'Vocabulary', topic: '' },
                { day: 'Day-7', subject: 'Math', topic: '' },
                { day: 'Day-7', subject: 'Basic View', topic: '' }
            ],
            vocabStories: {},
            progress: {}
        };

        month.weeks.push(newWeek);

        // snapshot for cancel
        initialStudyPlan = JSON.parse(JSON.stringify(studyPlan));

        buildUI();
        debouncedSaveData();
    }

    // Add a new month (max 12 months)
    function addNewMonth(event) {
        if (studyPlan.length >= 12) {
            alert('You can create up to 12 months only.');
            return;
        }
        const newMonthIndex = studyPlan.length + 1;
        const newMonth = {
            monthName: `Monthly Plan ${newMonthIndex}`,
            monthlyTargets: [
                { title: '1st Week', description: '', color: colorClasses[(newMonthIndex - 1) % colorClasses.length] },
                { title: '2nd Week', description: '', color: colorClasses[(newMonthIndex - 1) % colorClasses.length] },
                { title: '3rd Week', description: '', color: colorClasses[(newMonthIndex - 1) % colorClasses.length] },
                { title: '4th Week', description: '', color: colorClasses[(newMonthIndex - 1) % colorClasses.length] }
            ],
            weeks: [
                {
                    weekName: '1st Week',
                    dailyPlan: [
                        { day: 'Day-1', subject: 'Quran', topic: '' },
                        { day: 'Day-1', subject: 'Newspaper', topic: '' },
                        { day: 'Day-1', subject: 'Vocabulary', topic: '' },
                        { day: 'Day-1', subject: 'Math', topic: '' },
                        { day: 'Day-1', subject: 'Basic View', topic: '' },
                        { day: 'Day-2', subject: 'Quran', topic: '' },
                        { day: 'Day-2', subject: 'Newspaper', topic: '' },
                        { day: 'Day-2', subject: 'Vocabulary', topic: '' },
                        { day: 'Day-2', subject: 'Math', topic: '' },
                        { day: 'Day-2', subject: 'Basic View', topic: '' },
                        { day: 'Day-3', subject: 'Quran', topic: '' },
                        { day: 'Day-3', subject: 'Newspaper', topic: '' },
                        { day: 'Day-3', subject: 'Vocabulary', topic: '' },
                        { day: 'Day-3', subject: 'Math', topic: '' },
                        { day: 'Day-3', subject: 'Basic View', topic: '' },
                        { day: 'Day-4', subject: 'Quran', topic: '' },
                        { day: 'Day-4', subject: 'Newspaper', topic: '' },
                        { day: 'Day-4', subject: 'Vocabulary', topic: '' },
                        { day: 'Day-4', subject: 'Math', topic: '' },
                        { day: 'Day-4', subject: 'Basic View', topic: '' },
                        { day: 'Day-5', subject: 'Quran', topic: '' },
                        { day: 'Day-5', subject: 'Newspaper', topic: '' },
                        { day: 'Day-5', subject: 'Vocabulary', topic: '' },
                        { day: 'Day-5', subject: 'Math', topic: '' },
                        { day: 'Day-5', subject: 'Basic View', topic: '' },
                        { day: 'Day-6', subject: 'Quran', topic: '' },
                        { day: 'Day-6', subject: 'Newspaper', topic: '' },
                        { day: 'Day-6', subject: 'Vocabulary', topic: '' },
                        { day: 'Day-6', subject: 'Math', topic: '' },
                        { day: 'Day-6', subject: 'Basic View', topic: '' },
                        { day: 'Day-7', subject: 'Quran', topic: '' },
                        { day: 'Day-7', subject: 'Newspaper', topic: '' },
                        { day: 'Day-7', subject: 'Vocabulary', topic: '' },
                        { day: 'Day-7', subject: 'Math', topic: '' },
                        { day: 'Day-7', subject: 'Basic View', topic: '' }
                    ],
                    vocabStories: {},
                    progress: {}
                }
            ]
        };

        studyPlan.push(newMonth);
        initialStudyPlan = JSON.parse(JSON.stringify(studyPlan));
        buildUI();
        debouncedSaveData();
    }

    // small helper to get ordinal suffix for week names
    function getWeekSuffix(n) {
        if (n === 1) return 'st';
        if (n === 2) return 'nd';
        if (n === 3) return 'rd';
        return 'th';
    }

    /* ---------- Monthly Targets Editing ---------- */

    window.toggleMonthlyTargetEditMode = function(event) {
        const monthIndex = parseInt(event.currentTarget.dataset.monthIndex, 10);
        const targetIndex = parseInt(event.currentTarget.dataset.targetIndex, 10);
        if (isNaN(monthIndex) || isNaN(targetIndex)) return;

        const key = `${monthIndex}-${targetIndex}`;
        editingMonthlyTarget = (editingMonthlyTarget === key) ? null : key;

        // snapshot before editing for cancel
        if (editingMonthlyTarget) initialStudyPlan = JSON.parse(JSON.stringify(studyPlan));

        buildUI();
    }

    window.saveMonthlyTargetEdits = function(event) {
        const monthIndex = parseInt(event.currentTarget.dataset.monthIndex, 10);
        const targetIndex = parseInt(event.currentTarget.dataset.targetIndex, 10);
        if (isNaN(monthIndex) || isNaN(targetIndex)) return;

        const titleInput = document.querySelector(`#monthly-target-title-${monthIndex}-${targetIndex}`);
        const descInput = document.querySelector(`#monthly-target-desc-${monthIndex}-${targetIndex}`);

        if (titleInput) studyPlan[monthIndex].monthlyTargets[targetIndex].title = titleInput.value.trim();
        if (descInput) studyPlan[monthIndex].monthlyTargets[targetIndex].description = descInput.value.trim();

        editingMonthlyTarget = null;
        initialStudyPlan = JSON.parse(JSON.stringify(studyPlan));
        buildUI();
        debouncedSaveData();
    }

    window.cancelMonthlyTargetEdits = function(event) {
        // revert to snapshot
        studyPlan = JSON.parse(JSON.stringify(initialStudyPlan));
        editingMonthlyTarget = null;
        buildUI();
    }

    /* ---------- Persistence: Save & Load (Firestore) ---------- */

    let saveTimeout;
    function debouncedSaveData() {
        if (!isDataLoaded || !isFirebaseReady || !userId || !studyPlanDocRef) return;
        clearTimeout(saveTimeout);
        setSyncStatus('saving');
        saveTimeout = setTimeout(() => {
            saveStudyPlanToFirestore();
        }, 900);
    }

    async function saveStudyPlanToFirestore() {
        if (!studyPlanDocRef) { console.warn('No doc ref to save'); setSyncStatus('No doc ref', true); return; }
        try {
            // Save the whole studyPlan structure. Week-level progress objects already live inside the structure.
            await setDoc(studyPlanDocRef, { studyPlan: studyPlan }, { merge: true });
            setSyncStatus('synced');
            console.log('Study plan saved to Firestore.');
        } catch (err) {
            console.error('Save error', err);
            setSyncStatus('Save error: ' + (err.message || err), true);
        }
    }

    // Listen for remote changes (real-time)
    function listenForDataChanges() {
        if (!studyPlanDocRef) return;
        if (unsubscribeListener) {
            try { unsubscribeListener(); } catch (e) { /* ignore */ }
            unsubscribeListener = null;
        }
        unsubscribeListener = onSnapshot(studyPlanDocRef, (docSnap) => {
            const data = docSnap.data();
            if (!data) return;
            if (data.studyPlan) {
                // replace local copy but preserve in-memory editing if any
                studyPlan = data.studyPlan;
                initialStudyPlan = JSON.parse(JSON.stringify(studyPlan));
                isDataLoaded = true;
                buildUI();
                // After building UI, apply any saved checkbox/date states from each week's progress object
                applyLoadedProgress();
            }
        }, (err) => {
            console.error('Listener error', err);
            setSyncStatus('Listener error: ' + (err.message || err), true);
        });
    }

    // After loading studyPlan from Firestore, ensure checkboxes & date inputs reflect week.progress objects
    function applyLoadedProgress() {
        studyPlan.forEach((month, monthIndex) => {
            month.weeks.forEach((week, weekIndex) => {
                if (!week.progress) week.progress = {};
                // Apply each stored progress key for this week
                Object.keys(week.progress).forEach(key => {
                    const val = week.progress[key];
                    // Keys are expected like "Day-1-Quran-checked" or "Day-1-date"
                    if (key.endsWith('-checked')) {
                        // parse day & subject: e.g. "Day-1-Quran-checked"
                        const parts = key.split('-');
                        // parts: ['Day','1','Quran','checked'] OR if original pattern used dashes in subject need a more robust approach
                        const idx = key.lastIndexOf('-checked');
                        const daySubj = key.slice(0, idx); // e.g. "Day-1-Quran"
                        const lastDash = daySubj.lastIndexOf('-');
                        if (lastDash > 0) {
                            const day = daySubj.slice(0, lastDash);
                            const subject = daySubj.slice(lastDash + 1);
                            // find corresponding checkboxes in DOM for any week that matches monthIndex/weekIndex
                            document.querySelectorAll(`.task-checkbox[data-month="${monthIndex}"][data-week="${weekIndex}"][data-day="${day}"][data-subject="${subject}"]`).forEach(cb => {
                                cb.checked = !!val;
                                const taskItem = cb.closest('.task-item, .card-item');
                                if (taskItem) taskItem.classList.toggle('completed', !!val);
                            });
                        }
                    } else if (key.endsWith('-date')) {
                        const idx = key.lastIndexOf('-date');
                        const day = key.slice(0, idx);
                        const desktop = document.getElementById(`date-${monthIndex}-${weekIndex}-${day}`);
                        const mobile = document.getElementById(`date-mobile-${monthIndex}-${weekIndex}-${day}`);
                        if (desktop) desktop.value = val || '';
                        if (mobile) mobile.value = val || '';
                    } else if (key.endsWith('-story')) {
                        // apply story in week.vocabStories
                        const day = key.replace(/-story$/, '');
                        if (!week.vocabStories) week.vocabStories = {};
                        week.vocabStories[day] = val;
                    }
                });

                // After applying, run UI helpers for each day
                const uniqueDays = new Set(week.dailyPlan.map(d => d.day));
                uniqueDays.forEach(day => checkDayCompletion(monthIndex, weekIndex, day));
                updateWeeklyProgress(monthIndex, weekIndex);
            });
        });

        setSyncStatus('synced');
    }

    /* ---------- Authentication / Init ---------- */
    document.addEventListener('DOMContentLoaded', async () => {
        // Attach login/logout handlers (elements already selected earlier)
        if (loginBtn) loginBtn.addEventListener('click', signInWithGoogle);
        if (logoutBtn) logoutBtn.addEventListener('click', signOutUser);

        // Wire Add New Month button
        const addMonthBtn = document.getElementById('add-new-month-btn');
        if (addMonthBtn) addMonthBtn.addEventListener('click', addNewMonth);

        // initial UI build
        buildUI();

        // init firebase
        await initFirebase();
    });

    // attach save on unload (best effort)
    window.addEventListener('beforeunload', function() { if (isDataLoaded) saveStudyPlanToFirestore(); });

    /* ----------------- Utility: make sure vocab items visible / accessible right away ----------------- */
    // Some vocab items are created as innerHTML; ensure their toggles are bound when UI rebuilt
    document.addEventListener('click', function(event) {
        if (event.target && event.target.classList && event.target.classList.contains('read-story-btn')) {
            const month = event.target.getAttribute('data-month');
            const week = event.target.getAttribute('data-week');
            const day = event.target.getAttribute('data-day');
            // Find story
            let storyText = '';
            if (typeof month !== 'undefined' && typeof week !== 'undefined') {
                const m = studyPlan[parseInt(month, 10)];
                if (m && m.weeks && m.weeks[parseInt(week, 10)]) {
                    storyText = m.weeks[parseInt(week, 10)].vocabStories ? m.weeks[parseInt(week, 10)].vocabStories[day] || '' : '';
                }
            } else {
                // fallback for older single-month designs
                const m = studyPlan[0];
                if (m && m.weeks) {
                    m.weeks.forEach(w => {
                        if (w.vocabStories && w.vocabStories[day]) storyText = w.vocabStories[day];
                    });
                }
            }
            if (storyText) {
                const modal = document.getElementById('story-modal');
                const overlay = document.getElementById('story-overlay');
                const title = document.getElementById('story-title');
                const contentBox = document.getElementById('story-content');
                if (modal && overlay && title && contentBox) {
                    title.textContent = `A Tale from ${day}`;
                    contentBox.innerHTML = storyText;
                    modal.classList.remove('modal-hidden');
                }
            } else {
                alert('No story found for this day.');
            }
        }
    });

    // Close story modal handlers (if present)
    const storyCloseBtn = document.getElementById('story-close-btn');
    const storyOverlay = document.getElementById('story-overlay');
    if (storyCloseBtn) storyCloseBtn.addEventListener('click', () => document.getElementById('story-modal').classList.add('modal-hidden'));
    if (storyOverlay) storyOverlay.addEventListener('click', () => document.getElementById('story-modal').classList.add('modal-hidden'));

    // Expose a manual sync/save in case user wants to force it
    window.forceSaveStudyPlan = function() {
        saveStudyPlanToFirestore();
    }

    /* ---------- End of continuation ---------- */
</script>
</body>
</html>






