<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JWZXVQC68L"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-JWZXVQC68L');
	</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Caddy - My Study Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Naskh+Arabic:wght@400;700&family=Kalpurush:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" href="https://eco.du.ac.bd//assets/images/fab_icon.ico" type="image/x-icon">
    <style>
        /* --- Light Theme & Motivational Styles --- */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', 'Poppins', sans-serif; /* Prioritize Inter */
            background-color: #f8fafc; /* Lighter gray background (slate-50) */
            color: #1f2937; /* gray-800 */
            -webkit-font-smoothing: antialiased; /* Smoother fonts */
            -moz-osx-font-smoothing: grayscale;
        }
        /* Subtle background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(circle at top right, rgba(16, 185, 129, 0.03), transparent 40%),
                              radial-gradient(circle at bottom left, rgba(99, 102, 241, 0.03), transparent 40%);
            z-index: -1;
            opacity: 0.8;
        }
        .kalpurush { font-family: 'Kalpurush', sans-serif; }
        .arabic-font { font-family: 'Noto Naskh Arabic', serif; }

        /* --- General Button Styles --- */
        .action-button {
            background-color: #10b981; /* emerald-500 */
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            cursor: pointer;
            border: none;
            font-size: 0.875rem; /* text-sm */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            display: inline-flex; /* Align icon and text */
            align-items: center;
            justify-content: center;
            gap: 0.375rem; /* space-x-1.5 */
        }
        .action-button:hover {
            background-color: #059669; /* emerald-600 */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.05);
        }
         .action-button:active {
            transform: scale(0.98);
        }
        .action-button-secondary {
             background-color: #ffffff; /* white */
             color: #374151; /* gray-700 */
             box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
             border: 1px solid #d1d5db; /* gray-300 */
        }
        .action-button-secondary:hover {
             background-color: #f9fafb; /* gray-50 */
        }
        .action-button-danger {
            background-color: #fee2e2; /* red-100 */
            color: #b91c1c; /* red-700 */
            box-shadow: none;
            border: 1px solid #fecaca; /* red-300 */
        }
         .action-button-danger:hover {
            background-color: #fecaca; /* red-300 */
             color: #991b1b; /* red-800 */
        }
        .icon-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 999px;
            transition: background-color 0.2s, color 0.2s;
            color: #9ca3af; /* gray-400 */
        }
         .icon-button:hover {
             background-color: #e5e7eb; /* gray-200 */
             color: #ef4444; /* red-500 for delete */
         }
         .icon-button.add:hover {
             color: #10b981; /* emerald-500 for add */
         }

        /* --- Card Styles --- */
        .card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #e5e7eb; /* gray-200 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem; /* p-6 */
        }

        /* --- Target Card Link Styles --- */
        a.target-card-link {
            display: block;
            text-decoration: none;
            color: inherit;
            border-radius: 0.75rem;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, background-color 0.2s ease-out;
            cursor: pointer;
        }
        a.target-card-link:hover {
            background-color: #6ee7b7; /* emerald-300 */
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.1), 0 4px 6px -4px rgba(16, 185, 129, 0.1);
            transform: translateY(-3px);
        }
        .target-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px -3px rgba(0,0,0,0.07), 0 2px 6px -2px rgba(0,0,0,0.04);
            border: 1px solid #f3f4f6;
            transition: background-color 0.2s ease-out;
        }
        a.target-card-link:hover .target-card {
            background-color: transparent;
            box-shadow: none;
            border-color: transparent;
        }
        .target-textarea {
            font-family: 'Inter', 'Poppins', sans-serif;
            background-color: transparent;
            border: none; padding: 0; margin: 0;
            width: 100%; height: 100%; min-height: 60px;
            resize: none; color: #4b5563;
            font-size: 0.95rem; line-height: 1.5;
            outline: none; box-shadow: none;
        }
        .target-textarea:disabled {
            background-color: transparent;
            cursor: default;
			pointer-events: none;
        }
         .target-textarea:not(:disabled) {
             background-color: #f9fafb;
             border: 1px dashed #34d399;
             padding: 8px; border-radius: 4px;
         }
         a.target-card-link:hover .target-textarea:disabled { color: #4b5563; }
         a.target-card-link:hover .target-card h3 { color: #065f46; }

        /* --- Day Card Styles --- */
        .day-section {
            border-radius: 0.75rem; padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.2s ease-out;
            position: relative; /* Needed for absolute positioning of save button */
        }
        .day-section:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        /* Color variations */
        :root { --day-color-1: #ecfdf5; --day-color-2: #f0f9ff; --day-color-3: #fffbeb; --day-color-4: #fef2f2; --day-color-5: #faf5ff; --day-color-6: #f5f3ff; --day-color-7: #f0fdfa; }
        .days-container > .day-section:nth-of-type(7n+1) { background-color: var(--day-color-1); border-left: 4px solid #10b981; }
        .days-container > .day-section:nth-of-type(7n+2) { background-color: var(--day-color-2); border-left: 4px solid #0ea5e9; }
        .days-container > .day-section:nth-of-type(7n+3) { background-color: var(--day-color-3); border-left: 4px solid #f59e0b; }
        .days-container > .day-section:nth-of-type(7n+4) { background-color: var(--day-color-4); border-left: 4px solid #ef4444; }
        .days-container > .day-section:nth-of-type(7n+5) { background-color: var(--day-color-5); border-left: 4px solid #a855f7; }
        .days-container > .day-section:nth-of-type(7n+6) { background-color: var(--day-color-6); border-left: 4px solid #8b5cf6; }
        .days-container > .day-section:nth-of-type(7n+7) { background-color: var(--day-color-7); border-left: 4px solid #06b6d4; }
        .day-section .flex.justify-between { margin-bottom: 1rem; }
        .day-section .study-table { margin-top: 0.5rem; }
        .day-section .edit-mode-controls { margin-top: 1rem; }

        /* --- Table & Editing Styles --- */
        .study-table { width: 100%; text-align: left; color: #4b5563; font-size: 0.875rem; /* sm */ }
        .study-table thead { background-color: rgba(249, 250, 251, 0.6); /* gray-50/60 */ color: #4b5563; font-size: 0.75rem; text-transform: uppercase; }
        .study-table tbody tr { border-bottom: 1px solid #e5e7eb; }
        .study-table tbody tr:hover { background-color: rgba(249, 250, 251, 0.5); } /* Lighter hover */
        .study-table td, .study-table th { padding: 10px 8px; vertical-align: middle; } /* Reduced horizontal padding */
        .study-table th { text-align: left; }
        .study-table td.center-cell { text-align: center; }
		/* --- Style for Completed Table Row --- */
.study-table tbody tr.row-completed {
    background-color: #d1fae5; /* Light emerald (emerald-100) */
    /* Optional: Make text slightly darker for contrast */
    color: #065f46; /* emerald-800 */
}
.study-table tbody tr.row-completed .text-gray-500 { /* Make comment text readable */
    color: #047857; /* emerald-700 */
}
.study-table tbody tr.row-completed .subject-display { /* Make subject text readable */
    color: #065f46; /* emerald-800 */
}
/* Ensure hover effect doesn't clash too much */
.study-table tbody tr.row-completed:hover {
    background-color: #a7f3d0; /* Slightly darker emerald on hover (emerald-200) */
}

        .editable-input, .vocab-input { background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 4px; padding: 6px 8px; color: #1f2937; width: 100%; font-size: 0.875rem; transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s; }
        .editable-input:focus, .vocab-input:focus { outline: none; border-color: #34d399; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); background-color: white; }
        textarea.editable-input { min-height: 40px; }
        tr.editing-mode td { background-color: transparent !important; } /* Remove row highlight in edit */
        .day-section.editing { background-color: #f0fdf4 !important; } /* Highlight whole card in edit */


        /* --- Vocabulary Specific Styles --- */
        .vocab-word {
            position: relative; display: inline-block; background-color: #eef2ff; color: #3730a3;
            padding: 4px 10px; border-radius: 9999px; cursor: pointer; font-weight: 500;
            transition: background-color 0.2s; margin-right: 8px; margin-bottom: 4px; font-size: 0.875rem;
        }
        .vocab-word:hover { background-color: #e0e7ff; }
        .vocab-meaning {
            visibility: hidden; opacity: 0; width: max-content; max-width: 250px;
            background-color: #1e293b; color: #fff; text-align: center; border-radius: 6px;
            padding: 6px 12px; position: absolute; z-index: 10; bottom: 130%; left: 50%;
            transform: translateX(-50%); transition: opacity 0.3s, visibility 0.3s;
            font-weight: 500; white-space: normal; font-size: 0.8rem;
        }
        .vocab-word.active .vocab-meaning { visibility: visible; opacity: 1; }
        .vocab-word .vocab-meaning::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #1e293b transparent transparent transparent;
        }
/* --- Style for Highlighted Vocab in Story (Green) --- */
.highlighted-vocab {
    background-color: #d1fae5; /* emerald-100 */
    color: #047857; /* emerald-700 */
    font-weight: 600; /* semi-bold */
    padding: 0.1em 0.3em; /* Small padding */
    border-radius: 3px; /* Slightly rounded */
    margin: 0 0.1em; /* Tiny space around the word */
    display: inline-block; /* Ensures padding is applied correctly */
}
        .vocab-pair { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .vocab-pair .vocab-input { flex-grow: 1; }

        /* --- Modal Styles --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background-color: #ffffff; margin: 10% auto; padding: 25px; border: 1px solid #e5e7eb; width: 90%; max-width: 550px; border-radius: 10px; position: relative; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); }
        .modal-close { color: #9ca3af; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover, .modal-close:focus { color: #1f2937; }
        #story-textarea { background-color: #f9fafb; border: 1px solid #d1d5db; color: #1f2937; }

        /* --- Sticky Progress Bar --- */
        .sticky-progress-wrapper {
            position: sticky; z-index: 10; background-color: rgba(255, 255, 255, 0.85); /* Slightly transparent */
            backdrop-filter: blur(4px); padding: 10px 0; /* Reduced padding */
            margin: 0 -1.5rem 1rem -1.5rem; /* Counteract parent padding and add bottom margin */
            padding-left: 1.5rem; padding-right: 1.5rem; /* Restore side padding */
            border-bottom: 1px solid #e5e7eb; transition: top 0.3s ease-in-out;
        }
        .progress-bar-container { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 10px; } /* Slimmer bar */
        .progress-bar-fill { background-color: #10b981; height: 100%; transition: width 0.4s ease-in-out; border-radius: 9999px; }

        /* --- Add Day Button --- */
        .add-day-btn { display: flex; align-items: center; justify-content: center; background-color: #ecfdf5; color: #059669; border: 1px dashed #34d399; border-radius: 8px; padding: 12px; margin-top: 1rem; cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .add-day-btn:hover { background-color: #d1fae5; color: #047857; border-color: #6ee7b7; }
        .add-day-btn i { margin-right: 8px; }

        /* --- Month Navigation --- */
        #month-nav-buttons button { background-color: #e5e7eb; color: #374151; margin-right: 8px; margin-bottom: 8px; padding: 6px 12px; border-radius: 6px; font-weight: 500; font-size: 0.875rem; transition: background-color 0.2s, color 0.2s; }
        #month-nav-buttons button:hover { background-color: #d1d5db; }
        #month-nav-buttons button.active-month { background-color: #10b981; color: white; font-weight: 600; }

        /* --- Header Adjustments --- */
        header.main-website-ui { background-color: rgb(255 255 255 / 0.9); border-bottom-color: #e5e7eb; transition: transform 0.3s ease-in-out; }
        header.header-hidden { transform: translateY(-100%); }
        header.main-website-ui h1 { color: #1f2937; }
        header.main-website-ui nav a { color: #4b5563; }
        header.main-website-ui nav a:hover { color: #111827; }
        header.main-website-ui nav #academic-button, header.main-website-ui nav #academic-button a { color: #4b5563; }
        header.main-website-ui nav a.bg-emerald-500, header.main-website-ui nav a.text-emerald-600 { color: white !important; } /* Active link */
        header.main-website-ui #auth-container-desktop .text-gray-700 { color: #374151; }
        header.main-website-ui #auth-container-desktop .text-gray-500 { color: #6b7280; }
        header.main-website-ui .md\:hidden button { color: #374151; }
        #mobile-menu { background-color: #ffffff; border-color: #e5e7eb; }
        #mobile-menu a { color: #374151; }
        #mobile-menu a:hover { background-color: #f3f4f6; }
        #mobile-menu button { color: #374151; }
        #mobile-menu button:hover { background-color: #f3f4f6; }
        #mobile-menu #mobile-academic-menu { background-color: #f9fafb; }
        #mobile-menu #mobile-academic-menu a { color: #4b5563; }
        #mobile-menu a.text-emerald-600 { background-color: #ecfdf5; }
        #mobile-menu #auth-container-mobile { border-color: #e5e7eb; }
        .dropdown-menu { opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease; transform: translateY(-10px); display: block; }
        .dropdown-menu.hidden { opacity: 0; visibility: hidden; transform: translateY(-10px); }
        .dropdown-menu:not(.hidden) { opacity: 1; visibility: visible; transform: translateY(0); }
        #academic-menu { background-color: #ffffff; border-color: #e5e7eb; }
        #academic-menu a { color: #374151; }
        #academic-menu a:hover { background-color: #f3f4f6; }

        /* --- Mobile Responsiveness for Table --- */
        @media (max-width: 768px) {
            .study-table thead { display: none; } /* Hide table header */
            .study-table tbody, .study-table tr, .study-table td { display: block; width: 100%; } /* Stack elements */
            .study-table tr {
                border: 1px solid #e5e7eb; /* Add border around each stacked row */
                border-radius: 6px;
                margin-bottom: 1rem;
                padding: 0.75rem; /* Add internal padding */
                background-color: rgba(255,255,255,0.5); /* Slight white background */
            }
            .study-table td {
                padding: 8px 0; /* Adjust padding */
                border: none; /* Remove internal cell borders */
                position: relative;
                padding-left: 45%; /* Make space for the label */
                text-align: left;
                min-height: 24px; /* Ensure space even if empty */
            }
            .study-table td::before { /* Add labels */
                content: attr(data-label);
                position: absolute;
                left: 8px; /* Padding for label */
                width: 40%; /* Width of the label area */
                font-weight: 600;
                color: #374151; /* gray-700 */
                font-size: 0.75rem; /* text-xs */
                text-transform: uppercase;
                white-space: nowrap;
            }
            /* Specific adjustments for certain cells */
            .study-table td.center-cell { padding-left: 0; text-align: center; } /* Center Done checkbox */
            .study-table td.center-cell::before { display: none; } /* No label needed for checkbox/delete */
            .study-table td.actions-cell, .study-table td.completion-perc-cell { padding-left: 0; text-align: center; }
            .study-table td.actions-cell::before, .study-table td.completion-perc-cell::before { display: none; }

            .vocab-topic-cell { padding-left: 0 !important; } /* Full width for vocab/topic */
            .vocab-topic-cell::before { display: none !important; } /* No label needed */
            .vocab-word { display: block; margin-bottom: 6px; text-align: center; } /* Stack vocab words */
            .vocab-pair { flex-direction: column; align-items: stretch; } /* Stack vocab edit inputs */

            .editable-input, .vocab-input { font-size: 0.95rem; } /* Slightly larger inputs on mobile */
            textarea.editable-input { min-height: 50px; }

             /* Adjust button positions */
            .day-section .flex.justify-between .edit-day-btn { /* Make Edit button smaller */
                 padding: 6px 10px; font-size: 0.75rem;
            }
             .edit-mode-controls {
                 display: flex; flex-wrap: wrap; gap: 8px; /* Arrange buttons */
             }
             .edit-mode-controls .save-day-btn { order: 99; } /* Push save button to end */
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-sm border-b border-gray-200 main-website-ui shadow-sm">
        <div class="container mx-auto px-6 py-3">
            <nav class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <a href="https://facebook.com/emammehedi17" target="_blank" rel="noopener noreferrer">
                        <img src="images/profile.jpg" alt="Profile" class="h-10 w-10 rounded-full border-2 border-emerald-500 object-cover" onerror="this.onerror=null; this.src='https::placehold.co/40x40/ffffff/059669?text=CC';">
                    </a>
                    <a href="index.html">
                        <h1 class="text-xl font-bold text-gray-800">Class Caddy</h1>
                    </a>
                </div>
                <div class="hidden md:flex items-center gap-1 bg-gray-100/50 border border-gray-200 rounded-full p-1 text-sm">
                    <a href="index.html" class="px-5 py-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-full transition-colors">Home</a>
                    <div id="academic-dropdown" class="relative">
                        <button id="academic-button" class="px-5 py-1.5 font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-full transition-colors flex items-center">
                            <a href="academic.html" class="flex items-center">Academic <svg class="w-4 h-4 ml-1 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></a>
                        </button>
                        <div id="academic-menu" class="dropdown-menu absolute top-full left-1/2 -translate-x-1/2 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg hidden">
                            <a href="course-405.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Course 405</a>
                            <a href="course-406.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Course 406</a>
                            <a href="course-407.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Course 407</a>
                            <a href="course-408.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Course 408 (B)</a>
                        </div>
                    </div>
                     <a href="study_plan.html" class="px-5 py-1.5 bg-emerald-500 text-white rounded-full transition-colors">Study Plan</a> <a href="about.html" class="px-5 py-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-full transition-colors">About</a>
                    <a href="contact.html" class="px-5 py-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-full transition-colors">Contact</a>
                </div>
                 <div class="hidden md:flex items-center gap-4">
                    <a href="https://du.ac.bd/" target="_blank" rel="noopener noreferrer">
                        <img src="images/du_logo.png" alt="DU Logo" class="h-10 w-10 rounded-full border border-gray-200 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/40x40/eeeeee/111827?text=DU';">
                    </a>
                     <div id="auth-container-desktop" class="auth-container text-sm">
                         <a href="index.html#signup" class="px-5 py-2 font-semibold bg-emerald-500 hover:bg-emerald-600 text-white rounded-full transition-colors signup-button">Sign Up</a>
                    </div>
                </div>
                 <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button" class="text-gray-700 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </nav>
             <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-200 -mx-6 mt-3 shadow-md">
                <a href="index.html" class="block px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">Home</a>
                <div>
                    <button id="mobile-academic-button" class="w-full text-left px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors flex justify-between items-center">
                        <span>Academic</span>
                        <svg class="w-4 h-4 transition-transform duration-300 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="mobile-academic-menu" class="hidden pl-8 bg-gray-50">
                        <a href="course-405.html" class="block px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 transition-colors">Course 405</a>
                        <a href="course-406.html" class="block px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 transition-colors">Course 406</a>
                        <a href="course-407.html" class="block px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 transition-colors">Course 407</a>
                        <a href="course-408.html" class="block px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 transition-colors">Course 408 (B)</a>
                    </div>
                </div>
                 <a href="study_plan.html" class="block px-6 py-3 text-sm font-semibold text-emerald-600 bg-emerald-50 transition-colors">Study Plan</a> <a href="about.html" class="block px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">About</a>
                <a href="contact.html" class="block px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">Contact</a>
                <div id="auth-container-mobile" class="auth-container px-6 py-4 border-t border-gray-200">
                    <a href="index.html#signup" class="block w-full text-center text-sm font-semibold bg-emerald-500 hover:bg-emerald-600 text-white rounded-full py-2 transition-colors signup-button">Sign Up</a>
                </div>
            </div>
        </div>
    </header>
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 pt-28 pb-16"> <h1 class="text-3xl sm:text-4xl font-bold text-emerald-600 mb-8 text-center">My Study Plan</h1>

        <div id="auth-section" class="mb-10 card">
             <div id="login-prompt" class="text-center">
                <p class="text-gray-600 mb-4">Log in to create and manage your personalized study plans.</p>
                <button id="google-login-btn" class="action-button bg-red-500 hover:bg-red-600 text-white shadow-sm">
                    <i class="fab fa-google mr-2"></i> Sign in with Google
                </button>
            </div>
             <div id="user-info" class="hidden flex flex-col sm:flex-row justify-between items-center text-sm">
                 <div class="flex items-center gap-3 mb-3 sm:mb-0 text-gray-600">
                     <i class="fas fa-check-circle text-emerald-500"></i>
                     <span class="font-semibold">Sync Status:</span>
                     <span id="sync-status-text" class="text-emerald-500 font-medium">Synced</span>
                 </div>
                <div class="text-center sm:text-right">
                    <p id="user-display" class="font-medium text-gray-800"></p>
                    <p id="user-email-display" class="text-gray-500 text-xs"></p>
                     <span id="user-id-display" class="ml-4 text-xs text-gray-400 break-all" title="Your unique User ID"></span>
                    <button id="logout-btn" class="mt-1 text-red-500 hover:text-red-700 text-xs font-semibold">Log Out</button>
                </div>
            </div>
        </div>

        <div id="study-plan-content" class="hidden">

            <div class="mb-8 flex flex-wrap items-center gap-2">
                 <span class="text-sm font-medium text-gray-500 mr-2">Months:</span>
                 <div id="month-nav-buttons" class="flex-grow flex flex-wrap gap-2">
                     </div>
                 <button id="add-month-btn" class="action-button flex items-center gap-1.5 ml-auto flex-shrink-0">
                     <i class="fas fa-plus-circle text-sm"></i> Add Month
                 </button>
            </div>

            <div id="current-month-plan-display">
                <p id="no-plans-message" class="text-center text-gray-500 italic py-10">No study plans found. Click "Add Month" to create one.</p>
                 <p id="select-month-message" class="text-center text-gray-500 italic py-10 hidden">Select a month from the buttons above to view its plan.</p>
            </div>

        </div> </main>

    <div id="story-modal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal('story-modal')">&times;</span>
        <h3 class="text-xl font-semibold mb-3 text-emerald-600">Story</h3>
        <p id="story-modal-content" class="text-gray-700 whitespace-pre-wrap"></p>
      </div>
    </div>

     <div id="edit-story-modal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal('edit-story-modal')">&times;</span>
        <h3 class="text-xl font-semibold mb-3 text-emerald-600">Add/Edit Story</h3>
        <textarea id="story-textarea" rows="6" class="w-full p-2 bg-gray-50 border border-gray-300 rounded-md text-gray-800 placeholder-gray-400 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Write a story using the vocabulary words..."></textarea>
        <div class="mt-4 flex justify-end gap-3">
             <button onclick="closeModal('edit-story-modal')" class="action-button action-button-secondary">Cancel</button>
             <button id="save-story-btn" class="action-button">Save Story</button>
        </div>
      </div>
    </div>

     <div id="confirm-modal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal('confirm-modal')">&times;</span>
        <h3 id="confirm-modal-title" class="text-lg font-semibold mb-4 text-gray-800">Confirm Action</h3>
        <p id="confirm-modal-message" class="text-gray-600 mb-6">Are you sure?</p>
        <div class="flex justify-end gap-3">
             <button id="confirm-modal-cancel" class="action-button action-button-secondary">Cancel</button>
             <button id="confirm-modal-confirm" class="action-button action-button-danger">Confirm</button>
        </div>
      </div>
    </div>


    <script type="module">
        // Import necessary functions from Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc, getDoc, collection, query, getDocs, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, writeBatch, Timestamp, where, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        setLogLevel('debug'); // Keep debug logging enabled for now

        // PASTE YOUR ACTUAL FIREBASE CONFIG HERE:
        const firebaseConfig = {
          apiKey: "AIzaSyAj7MDnrnzKUO73BXG0jeM-uBGrAH3XiAY", // <-- YOUR ACTUAL KEY
          authDomain: "study-plan17.firebaseapp.com", // <-- YOURS
          projectId: "study-plan17", // <-- YOURS
          storageBucket: "study-plan17.appspot.com", // <-- YOURS
          messagingSenderId: "394648483332", // <-- YOURS
          appId: "1:394648483332:web:31c0d7a8b3f7065ce4e751", // <-- YOURS
          measurementId: "G-61TH4D55J3" // <-- YOURS (Optional)
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; // Use projectId as fallback app identifier if __app_id is missing

        console.log("Using manually added Firebase config:", firebaseConfig); // Log that manual config is used


        // Initialize Firebase
        let app;
        let auth;
        let db;
        let googleProvider;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            googleProvider = new GoogleAuthProvider();
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("CRITICAL ERROR initializing Firebase:", error);
            console.error("Firebase Config Used:", firebaseConfig);
             const authSection = document.getElementById('auth-section');
             if(authSection) authSection.innerHTML = `<p class="text-red-500 font-bold text-center">Error: Could not initialize Firebase. Please check the console.</p>`;
             throw new Error("Firebase initialization failed.");
        }
        // --- End Firebase Configuration ---

        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const loginPrompt = document.getElementById('login-prompt');
        const userInfo = document.getElementById('user-info');
        const userDisplay = document.getElementById('user-display');
        const userEmailDisplay = document.getElementById('user-email-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn'); // Main logout button
        const studyPlanContent = document.getElementById('study-plan-content');
        const addMonthBtn = document.getElementById('add-month-btn');
        const monthNavButtonsContainer = document.getElementById('month-nav-buttons');
        const currentMonthPlanDisplay = document.getElementById('current-month-plan-display');
        const noPlansMessage = document.getElementById('no-plans-message');
        const selectMonthMessage = document.getElementById('select-month-message');
        const syncStatusText = document.getElementById('sync-status-text');

        const authContainerDesktop = document.getElementById('auth-container-desktop');
        const authContainerMobile = document.getElementById('auth-container-mobile');

        // Header navigation elements
        const pageHeader = document.querySelector('header.main-website-ui');
        const academicDropdown = document.getElementById('academic-dropdown');
        const academicMenu = document.getElementById('academic-menu');
        const academicButton = document.getElementById('academic-button');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileAcademicButton = document.getElementById('mobile-academic-button');
        const mobileAcademicMenu = document.getElementById('mobile-academic-menu');

        // Modals
        const storyModal = document.getElementById('story-modal');
        const editStoryModal = document.getElementById('edit-story-modal');
        const saveStoryBtn = document.getElementById('save-story-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel');


        let currentUser = null;
        let userId = null;
        let unsubscribePlans = null; // For the list of month buttons
        let unsubscribeActiveMonth = null; // For the currently displayed month
        let currentStoryTarget = null;
        let currentConfirmAction = null;


        // --- Header Navigation & Scroll Logic (from script.js) ---
        if (pageHeader) {
            let lastScrollY = window.scrollY;
            const headerHeight = pageHeader.offsetHeight; // Get header height

            window.addEventListener('scroll', () => {
                const currentScrollY = window.scrollY;
                let isHeaderHidden = false; // Track state

                if (currentScrollY > lastScrollY && currentScrollY > 100) {
                     pageHeader.classList.add('header-hidden');
                     isHeaderHidden = true;
                } else {
                     pageHeader.classList.remove('header-hidden');
                     isHeaderHidden = false;
                }
                lastScrollY = currentScrollY <= 0 ? 0 : currentScrollY;

                // NEW LOGIC: Update all sticky progress bars
                const newTop = isHeaderHidden ? '0px' : `${headerHeight}px`;
                document.querySelectorAll('.sticky-progress-wrapper').forEach(bar => {
                    bar.style.top = newTop;
                });
            });
        }

        if (academicDropdown && academicMenu && academicButton) {
            let hideTimeout;
            const showMenu = () => { clearTimeout(hideTimeout); academicMenu.classList.remove('hidden'); };
            const hideMenu = () => { academicMenu.classList.add('hidden'); };
            const hideMenuWithDelay = () => { hideTimeout = setTimeout(hideMenu, 2000); };

            academicButton.addEventListener('click', (event) => {
                event.stopPropagation();
                academicMenu.classList.toggle('hidden');
            });
            academicDropdown.addEventListener('mouseenter', showMenu);
            academicDropdown.addEventListener('mouseleave', hideMenuWithDelay);
            window.addEventListener('click', (event) => {
                if (!academicDropdown.contains(event.target)) {
                    hideMenu();
                }
            });
        }

        if (mobileMenuButton && mobileMenu) {
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        }

        if (mobileAcademicButton && mobileAcademicMenu) {
            mobileAcademicButton.addEventListener('click', () => {
                mobileAcademicMenu.classList.toggle('hidden');
                const arrowIcon = mobileAcademicButton.querySelector('svg');
                if (arrowIcon) {
                    arrowIcon.classList.toggle('rotate-180');
                }
            });
        }
        // --- End Header Logic ---


        // --- Authentication ---
        function updateAuthUI(user) {
             if (user) {
                currentUser = user;
                userId = user.uid;
                console.log("User logged in:", userId);

                loginPrompt.style.display = 'none';
                userInfo.classList.remove('hidden');
                userDisplay.textContent = user.displayName || 'User';
                userEmailDisplay.textContent = user.email || (user.isAnonymous ? 'Anonymous User' : '');
                userIdDisplay.textContent = `ID: ${userId}`;
                userIdDisplay.title = 'Your unique User ID';
                logoutBtn.classList.remove('hidden');

                const loggedInHTML = `<div class="text-sm"><p class="font-semibold text-gray-700">${user.displayName || 'User'}</p><p class="text-gray-500 text-xs">${user.email || (user.isAnonymous ? 'Anonymous' : '')}</p></div><button id="logout-btn-header" class="ml-3 action-button action-button-danger text-xs px-3 py-1">Log Out</button>`;
                authContainerDesktop.innerHTML = loggedInHTML;
                authContainerMobile.innerHTML = loggedInHTML.replace('ml-3', 'w-full mt-2').replace('logout-btn-header', 'logout-btn-mobile');

                document.getElementById('logout-btn-header')?.addEventListener('click', handleLogout);
                document.getElementById('logout-btn-mobile')?.addEventListener('click', handleLogout);

                studyPlanContent.classList.remove('hidden');
                loadStudyPlans(); // Load plans AND month buttons
            } else {
                currentUser = null;
                userId = null;
                console.log("User logged out");

                loginPrompt.style.display = 'block';
                userInfo.classList.add('hidden');
                logoutBtn.classList.add('hidden');

                 const loggedOutHTML = `<a href="index.html#signup" class="px-5 py-2 font-semibold bg-emerald-500 hover:bg-emerald-600 text-white rounded-full transition-colors signup-button text-sm">Sign Up</a>`;
                 authContainerDesktop.innerHTML = loggedOutHTML;
                 authContainerMobile.innerHTML = loggedOutHTML.replace('px-5 py-2', 'block w-full text-center py-2');

                studyPlanContent.classList.add('hidden');
                monthNavButtonsContainer.innerHTML = '';
                currentMonthPlanDisplay.innerHTML = '';
                noPlansMessage.style.display = 'block';
                 selectMonthMessage.classList.add('hidden');

                if (unsubscribePlans) unsubscribePlans();
                if (unsubscribeActiveMonth) unsubscribeActiveMonth();
                unsubscribePlans = null;
                unsubscribeActiveMonth = null;
            }
        }

        onAuthStateChanged(auth, async (user) => {
             console.log("Auth state changed. User:", user);
             if (user) {
                updateAuthUI(user);
             } else {
                 if (auth.currentUser) {
                     updateAuthUI(auth.currentUser);
                     return;
                 }
                 if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                     try {
                         await signInWithCustomToken(auth, __initial_auth_token);
                     } catch (error) {
                         console.error("Error custom token, trying anonymous:", error);
                         try { await signInAnonymously(auth); }
                         catch (anonError) { console.error("Error anonymous:", anonError); updateAuthUI(null); }
                     }
                 } else {
                     try { await signInAnonymously(auth); }
                     catch (anonError) { console.error("Error anonymous:", anonError); updateAuthUI(null); }
                 }
             }
        });

        googleLoginBtn.addEventListener('click', async () => { try { await signInWithPopup(auth, googleProvider); } catch (error) { console.error("Google Sign-In Error:", error); } });
        async function handleLogout() { try { if (unsubscribeActiveMonth) unsubscribeActiveMonth(); unsubscribeActiveMonth = null; await signOut(auth); console.log("Logout successful."); } catch (error) { console.error("Logout Error:", error); } }
        logoutBtn.addEventListener('click', handleLogout);


        // --- Firestore ---
        function getUserPlansCollectionPath() { if (!userId) throw new Error("User ID is not available."); return `artifacts/${appId}/users/${userId}/studyPlans`; }

        // Load plans AND setup month navigation
        async function loadStudyPlans() {
            if (!currentUser || !userId) return;
            const plansCollectionPath = getUserPlansCollectionPath();
            const q = query(collection(db, plansCollectionPath), orderBy("createdAt", "desc")); // Order by creation time

            if (unsubscribePlans) unsubscribePlans();

            unsubscribePlans = onSnapshot(q, (querySnapshot) => {
                console.log("Received plans snapshot. Number of plans:", querySnapshot.size);
                monthNavButtonsContainer.innerHTML = '';

                let currentMonthElement = currentMonthPlanDisplay.querySelector('.card[data-month-id]');
                let currentMonthId = currentMonthElement ? currentMonthElement.dataset.monthId : null;
                let monthExists = false;

                // Save scroll position
                let scrollY = window.scrollY;
                let parentContainerRect = monthNavButtonsContainer.getBoundingClientRect();
                let shouldRestoreScroll = scrollY > (parentContainerRect.top + window.scrollY);

                if (querySnapshot.empty) {
                    currentMonthPlanDisplay.innerHTML = '';
                    noPlansMessage.style.display = 'block';
                    selectMonthMessage.classList.add('hidden');
                } else {
                    noPlansMessage.style.display = 'none';

                    querySnapshot.forEach((docSnap) => {
                        const monthId = docSnap.id;
                        if (monthId === currentMonthId) monthExists = true;
                        const monthData = docSnap.data();

                        const button = document.createElement('button');
                        button.textContent = monthData.monthName || monthId;
                        button.dataset.monthId = monthId;
                        button.classList.add('action-button', 'action-button-secondary', 'text-xs');
                        if (monthId === currentMonthId) {
                             button.classList.add('active-month');
                             button.classList.remove('action-button-secondary');
                        }
                        button.addEventListener('click', (e) => {
                            e.preventDefault(); // Prevent page jump
                            displayMonthPlan(monthId);
                        });
                        monthNavButtonsContainer.appendChild(button);
                    });

                    if (currentMonthId && !monthExists) {
                        currentMonthPlanDisplay.innerHTML = '';
                        selectMonthMessage.classList.remove('hidden');
                        if (unsubscribeActiveMonth) unsubscribeActiveMonth(); // Stop listening to deleted month
                        unsubscribeActiveMonth = null;
                    } else if (!currentMonthId) {
                         selectMonthMessage.classList.remove('hidden');
                    }
                }

                // Restore scroll position
                if (shouldRestoreScroll) {
                    console.log("Restoring scroll position to (loadStudyPlans):", scrollY);
                    window.scrollTo({ top: scrollY, behavior: 'auto' }); // Use 'auto' for instant jump
                }
            }, (error) => {
                console.error("Error fetching study plans:", error);
                currentMonthPlanDisplay.innerHTML = '<p class="text-red-500 text-center">Error loading plans.</p>';
                noPlansMessage.style.display = 'none';
                selectMonthMessage.classList.add('hidden');
            });
        }

         // Display a specific month's plan
        async function displayMonthPlan(monthId) {
            if (!currentUser || !userId) return;
             console.log("Displaying plan for month:", monthId);

             monthNavButtonsContainer.querySelectorAll('button').forEach(btn => {
                 btn.classList.toggle('active-month', btn.dataset.monthId === monthId);
                 btn.classList.toggle('action-button-secondary', btn.dataset.monthId !== monthId);
             });

             currentMonthPlanDisplay.innerHTML = '<p class="text-center text-gray-500 italic py-10">Loading...</p>';
             selectMonthMessage.classList.add('hidden');

             // Stop listening to the previously active month
             if (unsubscribeActiveMonth) {
                 unsubscribeActiveMonth();
             }

             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             try {
                 // Listen for real-time updates ONLY on the selected month
                 unsubscribeActiveMonth = onSnapshot(docRef, (docSnap) => {
                     // Check if this is still the active month before re-rendering
                     const activeBtn = monthNavButtonsContainer.querySelector('button.active-month');
                     if (!activeBtn || activeBtn.dataset.monthId !== monthId) {
                         console.log("Snapshot received for non-active month. Ignoring render.");
                         if (unsubscribeActiveMonth) unsubscribeActiveMonth(); // Stop listening
                         return;
                     }

                     // Save scroll position
                     let scrollY = window.scrollY;
                     let parentContainerRect = currentMonthPlanDisplay.getBoundingClientRect();
                     // Only restore if we're scrolled past the *start* of the container
                     let shouldRestoreScroll = parentContainerRect.top < 0;


                     if (docSnap.exists()) {
                         currentMonthPlanDisplay.innerHTML = '';
                         currentMonthPlanDisplay.appendChild(createMonthElement(monthId, docSnap.data()));
                     } else {
                         console.error("Document for monthId not found (or deleted):", monthId);
                         currentMonthPlanDisplay.innerHTML = '<p class="text-red-500 text-center">This plan was not found (it may have been deleted).</p>';
                     }

                     // Restore scroll position
                     if (shouldRestoreScroll) {
                        console.log("Restoring scroll position to (displayMonthPlan):", scrollY);
                        window.scrollTo({ top: scrollY, behavior: 'auto' });
                     }
                 });
             } catch (error) {
                 console.error("Error fetching specific month plan:", error);
                 currentMonthPlanDisplay.innerHTML = '<p class="text-red-500 text-center">Error loading this month\'s plan.</p>';
             }
         }


       // Add a new month
        addMonthBtn.addEventListener('click', async (e) => {
             e.preventDefault(); // Prevent page jump
             if (!currentUser || !userId) return;
             const currentYear = new Date().getFullYear();
             const currentMonthIndex = new Date().getMonth();
             const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

             // Default to *current* month
             const suggestedMonthName = `${monthNames[currentMonthIndex]} ${currentYear}`;
             const monthNameInput = prompt("Enter month name (e.g., 'October 2025'):", suggestedMonthName);
             if (!monthNameInput || monthNameInput.trim() === '') return;
             const monthName = monthNameInput.trim();

             let monthId = '';
             let monthYear = currentYear;
             let monthIndex = currentMonthIndex;

             try {
                const parts = monthName.split(' ');
                const year = parseInt(parts[1]);
                const index = monthNames.findIndex(m => m.toLowerCase() === parts[0].toLowerCase());
                if (year && index !== -1 && year > 1900 && year < 3000) {
                    monthId = `${year}-${(index + 1).toString().padStart(2, '0')}`;
                    monthYear = year;
                    monthIndex = index;
                } else { throw new Error("Invalid format"); }
             } catch (e) {
                 monthId = `${monthYear}-${(monthIndex + 1).toString().padStart(2, '0')}`;
                 console.warn("Could not parse month name, using generated ID:", monthId);
             }

             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             const docSnap = await getDoc(docRef);
             if (docSnap.exists()) { showCustomAlert(`Month ID ${monthId} (${monthName}) already exists.`); return; }

             const newPlanData = {
                monthName: monthName,
                createdAt: Timestamp.now(), // Used for sorting
                weeklyTargets: { week1: '', week2: '', week3: '', week4: '' },
                weeks: {
                    week1: { days: [] }, week2: { days: [] }, week3: { days: [] }, week4: { days: [] }
                }
             };

            try { await setDoc(docRef, newPlanData); console.log("New month added:", monthId); }
            catch (error) { console.error("Error adding new month:", error); showCustomAlert("Error adding month."); }
        });


        // --- UI Creation ---

        function createMonthElement(monthId, data) {
            const monthDiv = document.createElement('div');
            monthDiv.className = 'mb-12 p-6 card';
            monthDiv.dataset.monthId = monthId;

            const targetColors = { week1: 'text-indigo-700', week2: 'text-teal-700', week3: 'text-amber-700', week4: 'text-rose-700' };
            const targetHoverBgColors = { week1: 'hover:bg-indigo-50', week2: 'hover:bg-teal-50', week3: 'hover:bg-amber-50', week4: 'hover:bg-rose-50' };

            monthDiv.innerHTML = `
                <div class="flex justify-between items-start mb-6">
                     <h2 class="text-2xl font-bold text-emerald-600">${data.monthName || 'Unnamed Month'} <span class="text-lg text-gray-400 font-normal">(${monthId})</span></h2>
                     <button class="icon-button delete-month-btn" title="Delete Month"><i class="fas fa-trash-alt text-red-500"></i></button>
                 </div>
                 <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                         <h3 class="text-2xl font-semibold text-gray-700">Monthly Targets</h3>
                         <button class="action-button action-button-secondary text-xs edit-targets-btn" data-editing="false">
                            <i class="fas fa-pencil-alt mr-1"></i> Edit Targets
                         </button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 monthly-targets">
                        ${[1, 2, 3, 4].map(weekNum => `
                            <a href="#week-${monthId}-${weekNum}" class="target-card-link ${targetHoverBgColors[`week${weekNum}`] || ''}">
                                <div class="target-card">
                                    <h3 class="font-semibold text-lg ${targetColors[`week${weekNum}`] || 'text-gray-700'} mb-2">Week ${weekNum}</h3>
                                    <textarea id="target-week-${monthId}-${weekNum}" data-week="week${weekNum}" rows="3" class="target-textarea w-full" placeholder="Enter target..." disabled>${escapeHtml(data.weeklyTargets?.[`week${weekNum}`] || '')}</textarea>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                </div>
                 <div class="space-y-8 weekly-plans-container">
                    ${[1, 2, 3, 4].map(weekNum => createWeekElement(monthId, `week${weekNum}`, data.weeks?.[`week${weekNum}`], `week-${monthId}-${weekNum}`)).join('')}
                </div>`;

             monthDiv.querySelector('.edit-targets-btn').addEventListener('click', (e) => handleEditTargets(e.target, monthId));
             monthDiv.querySelector('.delete-month-btn').addEventListener('click', () => confirmDeleteMonth(monthId));
             attachWeekEventListeners(monthDiv, monthId);
             return monthDiv;
        }

        function createWeekElement(monthId, weekId, weekData, sectionId) {
            let daysHtml = '<p class="text-gray-500 italic text-sm py-4 text-center">No days added yet.</p>'; // Default message
            const daysSource = weekData?.days;

            if (daysSource) {
                if (Array.isArray(daysSource)) {
                    // --- Handle NEW Array structure ---
                    if (daysSource.length > 0) {
                        daysHtml = daysSource.map((dayData, index) => createDayElement(monthId, weekId, index, dayData)).join('');
                    }
                } else if (typeof daysSource === 'object' && !Array.isArray(daysSource) && Object.keys(daysSource).length > 0) {
                    // --- Handle OLD Map/Object structure ---
                    console.warn(`Detected old Map structure for days in ${monthId}/${weekId}. Converting for display.`);
                    // Sort keys numerically if they are numbers, otherwise alphabetically
                    const sortedKeys = Object.keys(daysSource).sort((a, b) => {
                        const numA = parseInt(a);
                        const numB = parseInt(b);
                        if (!isNaN(numA) && !isNaN(numB)) {
                            return numA - numB;
                        }
                        return a.localeCompare(b); // Fallback for non-numeric keys
                    });
                     // Generate HTML using the sorted keys, treating the key as the index for compatibility
                    daysHtml = sortedKeys.map(key => createDayElement(monthId, weekId, parseInt(key), daysSource[key])).join('');
                }
            }

            const totalDays = Array.isArray(daysSource) ? (daysSource?.length || 0) : (daysSource ? Object.keys(daysSource).length : 0); // Correctly count days for both types
            const initialProgress = calculateWeeklyProgress(weekData); // Assumes calculateWeeklyProgress can handle both structures
            const headerHeight = (pageHeader.classList.contains('header-hidden') ? 0 : (pageHeader.offsetHeight || 65)) + 'px'; // Ensure pageHeader is defined or provide fallback

            return `
                <div id="${sectionId}" class="bg-white/60 border border-gray-200 p-4 rounded-lg shadow week-section" data-week-id="${weekId}">
                    <h3 class="text-lg font-semibold text-emerald-700 mb-4 capitalize">${weekId.replace('week', 'Week ')} Plan</h3>
                    <div class="sticky-progress-wrapper" style="top: ${headerHeight};">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>Weekly Progress</span>
                            <span class="progress-percentage font-medium">${initialProgress}%</span>
                        </div>
                        <div class="progress-bar-container w-full"> <div class="progress-bar-fill" style="width: ${initialProgress}%;"></div> </div>
                    </div>
                    <div class="days-container space-y-6 mt-4"> ${daysHtml} </div>
                     ${totalDays < 7 ? (totalDays > 0 ? `<button class="add-day-btn w-full mt-4" data-week-id="${weekId}"><i class="fas fa-plus"></i> Add New Day</button>` : `<button class="action-button mt-4 add-first-day-btn" data-week-id="${weekId}"><i class="fas fa-calendar-plus mr-2"></i> Add First Day</button>`) : '<p class="text-center text-xs text-gray-400 mt-4">Maximum 7 days reached for this week.</p>'}
                </div>`;
        }

        function createDayElement(monthId, weekId, dayIndex, dayData) {
             const tableId = `table-${monthId}-${weekId}-${dayIndex}`;
             let rowsHtml = '';
             const rowsSource = dayData?.rows;

             if (rowsSource) {
                 if (Array.isArray(rowsSource)) {
                     // --- Handle NEW Array structure ---
                     rowsHtml = rowsSource.map((rowData, rowIndex) => createTableRow(monthId, weekId, dayIndex, rowIndex, rowData, false)).join('');
                 } else if (typeof rowsSource === 'object' && !Array.isArray(rowsSource) && Object.keys(rowsSource).length > 0) {
                     // --- Handle OLD Map/Object structure ---
                    console.warn(`Detected old Map structure for rows in ${monthId}/${weekId}/day ${dayData.dayNumber}. Converting for display.`);
                    // Sort keys numerically if they are numbers, otherwise alphabetically
                    const sortedKeys = Object.keys(rowsSource).sort((a, b) => {
                        const numA = parseInt(a);
                        const numB = parseInt(b);
                        if (!isNaN(numA) && !isNaN(numB)) {
                            return numA - numB;
                        }
                        return a.localeCompare(b); // Fallback for non-numeric keys
                    });
                     // Generate HTML using sorted keys, treating key as rowIndex
                     rowsHtml = sortedKeys.map(key => createTableRow(monthId, weekId, dayIndex, parseInt(key), rowsSource[key], false)).join('');
                 }
             }

             return `
                 <div class="day-section" data-day-index="${dayIndex}"> <div class="flex justify-between items-center mb-3">
                         <div class="flex items-center gap-2">
                             <h4 class="font-semibold text-gray-700">Day ${dayData.dayNumber}</h4>
                             <button class="icon-button delete-day-btn hidden" title="Delete Day"><i class="fas fa-calendar-times text-red-500"></i></button>
                         </div>
                         <button class="action-button action-button-secondary text-xs edit-day-btn"> <i class="fas fa-pencil-alt mr-1"></i> Edit </button>
                     </div>
                     <table class="w-full text-sm text-left text-gray-600 study-table" id="${tableId}">
                         <thead class="text-xs text-gray-500 uppercase">
                             <tr>
                                 <th scope="col" class="px-3 py-2 md:w-[20%]">Subject</th>
                                 <th scope="col" class="px-3 py-2 md:w-[40%]">Topic / Vocab</th>
                                 <th scope="col" class="px-3 py-2 md:w-[20%]">Comment</th>
                                 <th scope="col" class="px-3 py-2 w-[5%] md:w-[5%] center-cell">Done</th>
                                 <th scope="col" class="px-3 py-2 w-[10%] md:w-[5%] center-cell completion-perc-header hidden">%</th>
                                 <th scope="col" class="px-3 py-2 w-[5%] md:w-[5%] center-cell actions-header hidden"></th> </tr>
                         </thead>
                         <tbody> ${rowsHtml} </tbody>
                     </table>
                     <div class="edit-mode-controls hidden mt-3 flex flex-wrap gap-2 justify-between items-center">
                         <button class="action-button action-button-secondary text-xs add-normal-row-btn"><i class="fas fa-plus mr-1"></i> Add Row</button>
                         <button class="action-button action-button-secondary text-xs add-vocab-row-btn"><i class="fas fa-book mr-1"></i> Add Vocabulary</button>
                         <button class="action-button action-button-secondary text-xs add-story-btn"><i class="fas fa-feather-alt mr-1"></i> Add/Edit Story</button>
                         <button class="action-button text-xs save-day-btn"><i class="fas fa-save mr-1"></i> Save</button>
                     </div>
                 </div>`;
        }

        function createTableRow(monthId, weekId, dayIndex, rowIndex, rowData, isEditing) {
             const uniqueRowId = `row-${monthId}-${weekId}-${dayIndex}-${rowIndex}`;
             const isVocabRow = rowData.subject?.toLowerCase() === 'vocabulary';

             let topicContent = '';
             if (isEditing) {
                 if (isVocabRow) {
                     topicContent = `<div class="vocab-edit-container space-y-2">`;
                     (rowData.vocabData || [{ word: '', meaning: '' }]).forEach((pair, pairIndex) => {
                         topicContent += `
                             <div class="vocab-pair" data-pair-index="${pairIndex}">
                                 <input type="text" class="vocab-input vocab-word-input" placeholder="Word" value="${escapeHtml(pair.word || '')}">
                                 <input type="text" class="vocab-input vocab-meaning-input" placeholder="Meaning" value="${escapeHtml(pair.meaning || '')}">
                                 <button type="button" class="icon-button delete-vocab-pair-btn" title="Delete Pair"><i class="fas fa-times text-red-500"></i></button>
                             </div>`;
                     });
                     topicContent += `<button type="button" class="icon-button add-vocab-pair-btn mt-1" title="Add Word/Meaning Pair"><i class="fas fa-plus-circle text-emerald-500"></i></button></div>`;
                 } else {
                     topicContent = `<textarea class="editable-input topic-input text-xs" rows="2" placeholder="Topic details...">${escapeHtml(rowData.topic || '')}</textarea>`;
                 }
             } else {
                 if (isVocabRow) {
                     topicContent = generateVocabHtml(rowData.vocabData);
                 } else {
                     topicContent = `<span class="topic-display">${escapeHtml(rowData.topic || '-')}</span>`;
                 }
             }

             const storyButtonHtml = (!isEditing && isVocabRow && rowData.story)
                ? `<button class="action-button action-button-secondary text-xs read-story-btn mt-2 block w-full md:w-auto"><i class="fas fa-book-open mr-1"></i> Read Story</button>` : '';


             // *** MODIFICATION START ***
             // Add 'row-completed' class if rowData.completed is true AND it's NOT in editing mode
             const completedClass = (!isEditing && rowData.completed) ? 'row-completed' : '';
             // *** MODIFICATION END ***

             return `
                 <tr id="${uniqueRowId}" data-row-index="${rowIndex}" class="${isEditing ? 'editing-mode' : ''} ${isVocabRow ? 'vocab-row' : 'normal-row'} ${completedClass}">
                     <td class="px-3 py-2 align-top" data-label="Subject"> ${isEditing ? `<input type="text" class="editable-input subject-input" placeholder="Subject" value="${escapeHtml(rowData.subject || '')}" ${isVocabRow ? 'readonly style="background-color:#e5e7eb;"' : ''}>` : `<span class="subject-display font-medium text-gray-700">${escapeHtml(rowData.subject || '-')}</span>`}
                     </td>
                     <td class="px-3 py-2 align-top vocab-topic-cell" data-label="Topic / Vocab"> ${topicContent}
                         ${storyButtonHtml}
                     </td>
                     <td class="px-3 py-2 align-top" data-label="Comment"> ${isEditing ? `<textarea class="editable-input comment-input text-xs" rows="2" placeholder="Comment...">${escapeHtml(rowData.comment || '')}</textarea>` : `<span class="comment-display text-xs text-gray-500">${escapeHtml(rowData.comment || '-')}</span>`}
                     </td>
                     <td class="px-3 py-2 align-middle center-cell" data-label="Done"> <input type="checkbox" class="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500 completion-checkbox" ${rowData.completed ? 'checked' : ''} ${isEditing ? 'disabled' : ''}>
                     </td>
                      <td class="px-3 py-2 align-middle center-cell completion-perc-cell ${isEditing ? '' : 'hidden'}" data-label="%"> ${isEditing ? `<input type="text" inputmode="decimal" class="editable-input completion-perc-input w-16 text-center text-xs" placeholder="%" value="${rowData.completionPercentage ?? ''}">` : ''}
                      </td>
                     <td class="px-3 py-2 align-middle center-cell actions-cell ${isEditing ? '' : 'hidden'}" data-label="Actions"> ${isEditing ? `<button class="icon-button delete-row-btn" title="Delete Row"><i class="fas fa-trash-alt text-red-500"></i></button>` : ''}
                     </td>
                 </tr>
             `; // This is the end of the return statement
        }


        // Generate Vocab HTML with new Tooltip style
        function generateVocabHtml(vocabData) {
            if (!vocabData || vocabData.length === 0) return '-';
            return vocabData.map(v =>
                `<div class="vocab-word" tabindex="0">
                    ${escapeHtml(v.word || '')}
                    <span class="vocab-meaning">${escapeHtml(v.meaning || 'No meaning')}</span>
                 </div>`
            ).join(' ');
        }

        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
             return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }


        // --- Event Listeners ---

function attachWeekEventListeners(monthElement, monthId) {
             const weeklyPlansContainer = monthElement.querySelector('.weekly-plans-container');

             weeklyPlansContainer.addEventListener('click', async (e) => {
                 const target = e.target;
                 const button = target.closest('button');
                 const weekSection = target.closest('.week-section');
                 if (!weekSection) return;
                 const weekId = weekSection.dataset.weekId;
                 const daySection = target.closest('.day-section');
                 const row = target.closest('tr');

                 // Handle vocab word click
                 if (target.closest('.vocab-word') && !daySection?.classList.contains('editing')) {
                     e.preventDefault();
                     showVocabMeaning(target.closest('.vocab-word'));
                     return;
                 }

                 // *** MODIFICATION START ***
                 // Handle checkbox click (moved up, modified)
                 if (target.classList.contains('completion-checkbox')) {
                     if (!daySection?.classList.contains('editing')) {
                         // --- Normal Mode Checkbox Click ---
                         let scrollY = window.scrollY;
                         // Toggle class immediately for visual feedback
                         row?.classList.toggle('row-completed', target.checked);
                         await saveDayPlan(monthId, weekId, daySection); // Save the state
                         updateWeeklyProgressUI(monthId, weekId);
                         window.scrollTo({ top: scrollY, behavior: 'auto' });
                     } else {
                         // --- Edit Mode Checkbox Click (Prevent default action) ---
                         // Checkboxes are disabled in edit mode anyway, but this adds safety
                         e.preventDefault();
                     }
                     return; // Stop further processing after handling checkbox
                 }
                 // *** MODIFICATION END ***


                 // Handle other button clicks (must be a button now)
                 if (!button) return;
                 e.preventDefault();

                 // Edit/Save Day Button
                 if (button.classList.contains('edit-day-btn') || button.classList.contains('save-day-btn')) {
                     const isEditing = daySection.classList.contains('editing');
                     toggleDayEditMode(monthId, weekId, daySection, !isEditing);
                 }
                 // Add Normal Row Button (Edit Mode)
                 else if (button.classList.contains('add-normal-row-btn')) { addRowToDay(monthId, weekId, daySection, 'normal'); }
                 // Add Vocab Row Button (Edit Mode)
                 else if (button.classList.contains('add-vocab-row-btn')) { addRowToDay(monthId, weekId, daySection, 'vocabulary'); }
                 // Add/Edit Story Button (Edit Mode)
                 else if (button.classList.contains('add-story-btn')) {
                     const dayIndex = parseInt(daySection.dataset.dayIndex);
                     const vocabRow = daySection.querySelector('tr.vocab-row');
                     let vocabRowIndex = vocabRow ? parseInt(vocabRow.dataset.rowIndex) : -1;
                     openEditStoryModal(monthId, weekId, dayIndex, vocabRowIndex);
                 }
                 // Delete Row Button (Edit Mode)
                 else if (button.classList.contains('delete-row-btn')) { confirmDeleteRow(monthId, weekId, daySection, row); }
                 // Delete Day Button (Edit Mode)
                 else if (button.classList.contains('delete-day-btn')) { confirmDeleteDay(monthId, weekId, daySection); }
                 // Add Vocab Pair Button (Edit Mode)
                 else if (button.classList.contains('add-vocab-pair-btn')) { addVocabPairInputs(button.closest('.vocab-edit-container')); }
                 // Delete Vocab Pair Button (Edit Mode)
                 else if (button.classList.contains('delete-vocab-pair-btn')) { deleteVocabPairInputs(button.closest('.vocab-pair')); }
                 // Read Story Button (Normal Mode)
                 else if (button.classList.contains('read-story-btn')) {
                     const dayIndex = parseInt(daySection.dataset.dayIndex);
                     const rowIndex = parseInt(row.dataset.rowIndex);
                     readStory(monthId, weekId, dayIndex, rowIndex);
                 }
                 // Add Day Button / Add First Day
                 else if (button.classList.contains('add-day-btn') || button.classList.contains('add-first-day-btn')) {
                     addNewDay(monthId, weekId, weekSection);
                 }
             });

            // Add global click listener to close vocab popups
            document.addEventListener('click', function (event) {
                if (!event.target.closest('.vocab-word')) {
                    document.querySelectorAll('.vocab-word.active').forEach(v => v.classList.remove('active'));
                }
            });
        }


        // Toggle Edit Mode - Updated for Button Swap
        async function toggleDayEditMode(monthId, weekId, daySection, enterEditMode) {
             const dayIndex = parseInt(daySection.dataset.dayIndex);
             const tableBody = daySection.querySelector('tbody');
             const editButton = daySection.querySelector('.edit-day-btn'); // Top right button
             const saveButton = daySection.querySelector('.save-day-btn'); // Bottom button
             const editModeControls = daySection.querySelector('.edit-mode-controls');
             const deleteDayButton = daySection.querySelector('.delete-day-btn');
             const actionsHeader = daySection.querySelector('.actions-header');
             const completionPercHeader = daySection.querySelector('.completion-perc-header');

             setSyncStatus("Syncing...", "yellow");

             if (enterEditMode) {
                 // --- ENTERING EDIT MODE ---
                 daySection.classList.add('editing');
                 editButton.classList.add('hidden'); // Hide Edit button
                 editModeControls.classList.remove('hidden'); // Show controls (including Save)
                 // saveButton is already visible because editModeControls is shown
                 deleteDayButton.classList.remove('hidden');
                 actionsHeader.classList.remove('hidden');
                 completionPercHeader.classList.remove('hidden');

                 const planDoc = await getDoc(doc(db, getUserPlansCollectionPath(), monthId));
                 const dayData = planDoc.exists() ? planDoc.data().weeks[weekId]?.days[dayIndex] : null;
                 if (!dayData) { console.error("Could not find day data to edit."); setSyncStatus("Error", "red"); return; }

                 tableBody.innerHTML = dayData.rows.map((rowData, rowIndex) =>
                    createTableRow(monthId, weekId, dayIndex, rowIndex, rowData, true) // Render in edit mode
                 ).join('');
                 daySection.querySelectorAll('.completion-checkbox').forEach(cb => cb.disabled = true);
                 setSyncStatus("Editing...", "blue");

             } else {
                 // --- SAVING AND EXITING EDIT MODE ---
                 await saveDayPlan(monthId, weekId, daySection); // Save first

                 daySection.classList.remove('editing');
                 editButton.classList.remove('hidden'); // Show Edit button
                 editModeControls.classList.add('hidden'); // Hide controls (including Save)
                 // saveButton is hidden because editModeControls is hidden
                 deleteDayButton.classList.add('hidden');
                 actionsHeader.classList.add('hidden');
                 completionPercHeader.classList.add('hidden');

                 // Re-render rows in normal mode
                 try {
                     const planDoc = await getDoc(doc(db, getUserPlansCollectionPath(), monthId));
                     const dayData = planDoc.exists() ? planDoc.data().weeks[weekId]?.days[dayIndex] : null;

                     if (!dayData) { tableBody.innerHTML = ''; }
                     else {
                         tableBody.innerHTML = dayData.rows.map((rowData, rowIndex) =>
                            createTableRow(monthId, weekId, dayIndex, rowIndex, rowData, false) // Render non-edit mode
                         ).join('');
                     }

                     updateWeeklyProgressUI(monthId, weekId);
                     setSyncStatus("Synced", "green");
                 } catch (renderError) {
                     console.error("Error re-rendering day after save:", renderError);
                     setSyncStatus("Error", "red");
                 }
             }
        }

        // Save Day Plan
        async function saveDayPlan(monthId, weekId, daySection) {
            if (!currentUser || !userId) return;
            const dayIndex = parseInt(daySection.dataset.dayIndex);
            console.log(`Saving day plan for ${monthId}, ${weekId}, Day Index: ${dayIndex}`);
            setSyncStatus("Syncing...", "yellow");

            const docRef = doc(db, getUserPlansCollectionPath(), monthId);
            try {
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) throw new Error("Month document not found.");

                let monthData = docSnap.data();
                let daysArray = monthData.weeks?.[weekId]?.days || [];
                const currentDayData = daysArray[dayIndex];
                 if (!currentDayData) throw new Error(`Day data for index ${dayIndex} not found in Firestore.`);

                const updatedRows = [];
                const rowElements = daySection.querySelectorAll('tbody tr');

                rowElements.forEach((row) => {
                    let existingRowIndex = parseInt(row.dataset.rowIndex);
                    const existingRowData = !isNaN(existingRowIndex) && currentDayData.rows?.[existingRowIndex] ? currentDayData.rows[existingRowIndex] : {};

                    let subject, topic, comment, completed, completionPercentage, vocabData = null, story;

                    if (daySection.classList.contains('editing')) {
                         subject = row.querySelector('.subject-input')?.value.trim() || '';
                         comment = row.querySelector('.comment-input')?.value.trim() || '';
                         completed = existingRowData.completed || false;
                         const percInput = row.querySelector('.completion-perc-input')?.value;
                         completionPercentage = parsePercentage(percInput);
                         story = (subject.toLowerCase() === 'vocabulary') ? (existingRowData.story || null) : null;

                         if (row.classList.contains('vocab-row')) {
                             subject = 'Vocabulary';
                             vocabData = [];
                             row.querySelectorAll('.vocab-pair').forEach(pairEl => {
                                 const word = pairEl.querySelector('.vocab-word-input')?.value.trim();
                                 const meaning = pairEl.querySelector('.vocab-meaning-input')?.value.trim();
                                 if (word) { vocabData.push({ word: word, meaning: meaning || '' }); }
                             });
                             topic = null;
                         } else {
                             topic = row.querySelector('.topic-input')?.value.trim() || '';
                             vocabData = null;
                         }
                    } else { // Handle saving checkbox clicks in normal mode
                         completed = row.querySelector('.completion-checkbox')?.checked || false;
                         subject = existingRowData.subject; topic = existingRowData.topic; comment = existingRowData.comment;
                         completionPercentage = existingRowData.completionPercentage; vocabData = existingRowData.vocabData; story = existingRowData.story;
                     }
                     updatedRows.push({ subject: subject || '', topic: topic || null, comment: comment || '', completed: completed || false, completionPercentage: completionPercentage ?? null, vocabData: vocabData || null, story: story || null });
                });

                 daysArray[dayIndex].rows = updatedRows;
                const updatePayload = { [`weeks.${weekId}.days`]: daysArray };
                await updateDoc(docRef, updatePayload);
                console.log(`Day ${dayIndex + 1} for ${weekId} saved successfully.`);
                setSyncStatus("Synced", "green");

            } catch (error) {
                console.error("Error saving day plan:", error);
                showCustomAlert("Error saving changes. Please check your connection and try again.");
                setSyncStatus("Error", "red");
            }
        }

         // Add Row (normal or vocab)
        function addRowToDay(monthId, weekId, daySection, type = 'normal') {
             const dayIndex = parseInt(daySection.dataset.dayIndex);
             const tableBody = daySection.querySelector('tbody');
             let maxIndex = -1;
             tableBody.querySelectorAll('tr').forEach(tr => { const idx = parseInt(tr.dataset.rowIndex); if (idx > maxIndex) maxIndex = idx; });
             const newRowIndex = maxIndex + 1;

             let newRowData;
             if (type === 'vocabulary') { newRowData = { subject: 'Vocabulary', topic: null, completed: false, comment: '', completionPercentage: null, vocabData: [{ word: '', meaning: '' }], story: null }; }
             else { newRowData = { subject: '', topic: '', completed: false, comment: '', completionPercentage: null, vocabData: null, story: null }; }

             const newRowHtml = createTableRow(monthId, weekId, dayIndex, newRowIndex, newRowData, true);
             tableBody.insertAdjacentHTML('beforeend', newRowHtml);
         }

        // Add/Delete Vocab Pair Inputs
         function addVocabPairInputs(container) {
             const newPairIndex = container.querySelectorAll('.vocab-pair').length;
             const pairHtml = `<div class="vocab-pair" data-pair-index="${newPairIndex}"><input type="text" class="vocab-input vocab-word-input" placeholder="Word" value=""><input type="text" class="vocab-input vocab-meaning-input" placeholder="Meaning" value=""><button type="button" class="icon-button delete-vocab-pair-btn" title="Delete Pair"><i class="fas fa-times text-red-500"></i></button></div>`;
             container.querySelector('.add-vocab-pair-btn').insertAdjacentHTML('beforebegin', pairHtml);
         }
         function deleteVocabPairInputs(pairElement) {
             const container = pairElement.closest('.vocab-edit-container');
             if (container && container.querySelectorAll('.vocab-pair').length > 1) { pairElement.remove(); }
             else { showCustomAlert("Cannot delete the last word/meaning pair."); }
         }

        // --- Delete Operations ---
         function confirmDeleteRow(monthId, weekId, daySection, rowElement) {
             const rowIndex = parseInt(rowElement.dataset.rowIndex);
             showConfirmationModal("Delete Row", "Are you sure you want to delete this row? This action cannot be undone.", () => deleteRow(monthId, weekId, daySection, rowElement, rowIndex));
         }
         async function deleteRow(monthId, weekId, daySection, rowElement, rowIndex) {
            rowElement.remove(); // Remove from UI
            console.log("Row removed from UI. Changes will be saved when day plan is saved.");
            setSyncStatus("Editing...", "blue"); // Keep status as Editing

            // await saveDayPlan(monthId, weekId, daySection); // <-- REMOVED immediate save

            // Re-index remaining rows visually in the DOM
            daySection.querySelectorAll('tbody tr').forEach((tr, newIdx) => {
                 tr.dataset.rowIndex = newIdx; // Update the data attribute
                 tr.id = `row-${monthId}-${weekId}-${daySection.dataset.dayIndex}-${newIdx}`; // Update the ID

                 // Also update the field paths for Firestore within input/textarea names or data attributes if you use them directly for saving later
                 tr.querySelectorAll('input, textarea').forEach(input => {
                     // Example: If you were using names like 'rows[0].subject', update them
                     const name = input.getAttribute('name');
                     // Find the original index in the name attribute using regex to handle multi-digit indices
                     const match = name ? name.match(/rows\[(\d+)\]/) : null;
                     if (match) {
                         const originalIndex = parseInt(match[1]);
                         // Only update if the original index needs re-indexing (i.e., it was after the deleted row)
                         if (originalIndex > rowIndex) {
                             // Correctly replace the old index number with the new index number
                             input.setAttribute('name', name.replace(`rows[${originalIndex}]`, `rows[${originalIndex - 1}]`));
                         } else if (originalIndex === rowIndex) {
                            // Although the row is removed, inputs might still linger briefly; ensure they don't cause issues
                            // Or handle this by ensuring all event listeners are removed with the row
                         }
                     }
                     // Add similar logic if you store paths in data attributes
                 });
                  // Re-index vocab pairs within remaining vocab rows if necessary
                 if (tr.classList.contains('vocab-row')) {
                     tr.querySelectorAll('.vocab-pair').forEach((pair, pairIdx) => {
                         pair.dataset.pairIndex = pairIdx;
                         // Update input names/data attributes within the pair if needed
                     });
                 }
             });
         }
         function confirmDeleteDay(monthId, weekId, daySection) {
             const dayIndex = parseInt(daySection.dataset.dayIndex);
             const dayNum = daySection.querySelector('h4').textContent;
             showConfirmationModal(`Delete ${dayNum}`, `Are you sure you want to delete all entries for ${dayNum}? This action cannot be undone.`, () => deleteDay(monthId, weekId, daySection, dayIndex));
         }
         async function deleteDay(monthId, weekId, daySection, dayIndex) {
            if (!currentUser || !userId) return;
            console.log(`Attempting to delete day index ${dayIndex} from week ${weekId}, month ${monthId}`);
            setSyncStatus("Syncing...", "yellow");
            const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             try {
                 const docSnap = await getDoc(docRef);
                 if (!docSnap.exists()) throw new Error("Month document not found.");
                 let monthData = docSnap.data();
                 let daysArray = monthData.weeks?.[weekId]?.days || [];
                 if (!daysArray[dayIndex]) throw new Error("Day not found in Firestore.");
                 daysArray.splice(dayIndex, 1);
                 for (let i = dayIndex; i < daysArray.length; i++) { daysArray[i].dayNumber = i + 1; }
                 const updatePayload = { [`weeks.${weekId}.days`]: daysArray };
                 await updateDoc(docRef, updatePayload);
                 console.log("Day deleted successfully from Firestore.");
                 setSyncStatus("Synced", "green");
             } catch (error) { console.error("Error deleting day:", error); showCustomAlert("Error deleting day. Please try again."); setSyncStatus("Error", "red"); }
         }
         function confirmDeleteMonth(monthId) {
             const monthButton = monthNavButtonsContainer.querySelector(`button[data-month-id="${monthId}"]`);
             const monthName = monthButton ? monthButton.textContent : monthId;
             showConfirmationModal(`Delete Month: ${monthName}`, `Are you sure you want to delete the entire study plan for ${monthName}? This action cannot be undone.`, () => deleteMonth(monthId));
         }
         async function deleteMonth(monthId) {
             if (!currentUser || !userId) return;
             console.log("Attempting to delete month:", monthId);
             setSyncStatus("Syncing...", "yellow");
             const activeBtn = monthNavButtonsContainer.querySelector('button.active-month');
             if (activeBtn && activeBtn.dataset.monthId === monthId && unsubscribeActiveMonth) { unsubscribeActiveMonth(); unsubscribeActiveMonth = null; }
             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             try { await deleteDoc(docRef); console.log("Month deleted successfully."); setSyncStatus("Synced", "green"); }
             catch (error) { console.error("Error deleting month:", error); showCustomAlert("Error deleting month. Please try again."); setSyncStatus("Error", "red"); }
         }
         function showConfirmationModal(title, message, onConfirm) {
             confirmModalTitle.textContent = title; confirmModalMessage.textContent = message; currentConfirmAction = onConfirm;
             confirmModalConfirmBtn.onclick = () => { if (currentConfirmAction) currentConfirmAction(); closeModal('confirm-modal'); };
             confirmModalCancelBtn.onclick = () => closeModal('confirm-modal');
             confirmModal.style.display = 'block';
         }

        // Add New Day
        async function addNewDay(monthId, weekId, weekSection) {
            if (!currentUser || !userId) return;
             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             try {
                 const docSnap = await getDoc(docRef);
                 if (!docSnap.exists()) throw new Error("Month document not found.");
                 const monthData = docSnap.data();
                 let daysArray = monthData.weeks?.[weekId]?.days || [];
                 if (daysArray.length >= 7) { showCustomAlert("You cannot add more than 7 days to a week."); return; }
                console.log(`Adding new day to ${monthId}, ${weekId} (Current count: ${daysArray.length})`);
                setSyncStatus("Syncing...", "yellow");
                 const lastDayIndex = daysArray.length - 1;
                 let newDayData;
                  if (lastDayIndex >= 0) {
                     const lastDayRows = daysArray[lastDayIndex].rows || [];
                     newDayData = { dayNumber: daysArray.length + 1, date: '', rows: lastDayRows.map(row => ({ subject: row.subject || '', topic: (row.subject?.toLowerCase() === 'vocabulary') ? null : (row.topic || ''), completed: false, comment: '', completionPercentage: row.completionPercentage ?? null, vocabData: (row.subject?.toLowerCase() === 'vocabulary') ? (row.vocabData || null) : null, story: null })) };
                 } else { newDayData = { dayNumber: 1, date: '', rows: [{ subject: '', topic: '', completed: false, comment: '', completionPercentage: null, vocabData: null, story: null }] }; }
                 const updatePayload = { [`weeks.${weekId}.days`]: arrayUnion(newDayData) };
                 await updateDoc(docRef, updatePayload);
                 console.log("New day added successfully.");
                 setSyncStatus("Synced", "green");
             } catch (error) { console.error("Error adding new day:", error); showCustomAlert("Error adding new day."); setSyncStatus("Error", "red"); }
        }

        // --- Monthly Target Edit ---
        function handleEditTargets(button, monthId) {
            const isEditing = button.dataset.editing === 'true';
            const targetsContainer = button.closest('.mb-8');
            const textareas = targetsContainer.querySelectorAll('.target-textarea');
            const links = targetsContainer.querySelectorAll('.target-card-link');

            if (isEditing) {
                saveMonthlyTargets(monthId, targetsContainer);
                button.innerHTML = '<i class="fas fa-pencil-alt mr-1"></i> Edit Targets';
                button.dataset.editing = 'false';
                button.classList.add('action-button-secondary');
                textareas.forEach(ta => ta.disabled = true );
                links.forEach(link => { if (link.dataset.href) { link.setAttribute('href', link.dataset.href); } });
            } else {
                button.innerHTML = '<i class="fas fa-save mr-1"></i> Save Targets';
                button.dataset.editing = 'true';
                button.classList.remove('action-button-secondary');
                links.forEach(link => { link.dataset.href = link.getAttribute('href'); link.removeAttribute('href'); });
                textareas.forEach(ta => ta.disabled = false );
                textareas[0].focus();
            }
        }
        async function saveMonthlyTargets(monthId, targetsContainer) {
             if (!currentUser || !userId) return;
             console.log("Saving targets for month:", monthId);
             setSyncStatus("Syncing...", "yellow");
             const targets = {};
             targetsContainer.querySelectorAll('.target-textarea').forEach(textarea => { targets[textarea.dataset.week] = textarea.value.trim(); });
             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             try { await updateDoc(docRef, { weeklyTargets: targets }); console.log("Monthly targets saved."); showCustomAlert("Monthly targets saved!", "success"); setSyncStatus("Synced", "green"); }
             catch (error) { console.error("Error saving targets:", error); showCustomAlert("Error saving targets."); setSyncStatus("Error", "red"); }
        }

        // --- Story Modals ---
         async function openEditStoryModal(monthId, weekId, dayIndex, vocabRowIndex) {
             if (!currentUser || !userId) return;
             let daySection = document.querySelector(`[data-month-id="${monthId}"] [data-week-id="${weekId}"] [data-day-index="${dayIndex}"]`);
             if (vocabRowIndex === -1) {
                 const vocabRow = daySection ? daySection.querySelector('tr.vocab-row') : null;
                 if(vocabRow) { vocabRowIndex = parseInt(vocabRow.dataset.rowIndex); }
                 else { showCustomAlert("Please add and save a Vocabulary row before adding a story."); return; }
             }
             let existingStory = ''; const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             setSyncStatus("Syncing...", "yellow");
             try {
                 const docSnap = await getDoc(docRef); let dayData;
                 if (docSnap.exists()) {
                     dayData = docSnap.data().weeks?.[weekId]?.days?.[dayIndex];
                     if (dayData && dayData.rows && dayData.rows[vocabRowIndex]) { existingStory = dayData.rows[vocabRowIndex].story || ''; }
                     else if (daySection.classList.contains('editing')) { console.log("New row detected. Saving day plan..."); await saveDayPlan(monthId, weekId, daySection); }
                     else { throw new Error("Target row not found."); }
                 }
                 setSyncStatus("Synced", "green"); currentStoryTarget = { monthId, weekId, dayIndex, rowIndex: vocabRowIndex };
                 document.getElementById('story-textarea').value = existingStory; editStoryModal.style.display = "block";
             } catch (error) { console.error("Error fetching/prepping story:", error); showCustomAlert("Could not open story editor. Please save your day plan first."); setSyncStatus("Error", "red"); }
         }
         saveStoryBtn.addEventListener('click', async () => {
            if (!currentUser || !userId || !currentStoryTarget) return;
            const { monthId, weekId, dayIndex, rowIndex } = currentStoryTarget;
            if (rowIndex === -1) { showCustomAlert("Error: No associated vocabulary row found."); return; }
            const newStory = document.getElementById('story-textarea').value.trim();
            const docRef = doc(db, getUserPlansCollectionPath(), monthId);
            setSyncStatus("Syncing...", "yellow");
            try {
                // Construct the specific field path to update only the story
                const storyFieldPath = `weeks.${weekId}.days.${dayIndex}.rows.${rowIndex}.story`;
                const updatePayload = { [storyFieldPath]: newStory || null }; // Use null if story is empty

                await updateDoc(docRef, updatePayload); // Update only the story field in Firestore
                console.log("Story saved successfully for row:", rowIndex);
                closeModal('edit-story-modal'); // Close modal
                // Keep the status as "Editing..." since the main day isn't fully saved yet.
                setSyncStatus("Editing...", "blue");
                // The visual change (like the 'Read Story' button appearing/disappearing)
                // won't happen until the main 'Save' button for the day is clicked.
                // This is expected behavior to maintain the edit state.
            } catch (error) {
                console.error("Error saving story:", error);
                showCustomAlert("Error saving story.");
                setSyncStatus("Error", "red"); // Show error if save fails
            }
            // Do NOT reset currentStoryTarget here, keep it in case needed again before saving day
            // finally { currentStoryTarget = null; } // Removed this line
         });
         async function readStory(monthId, weekId, dayIndex, rowIndex) {
            if (!currentUser || !userId) return;
            const storyModalContent = document.getElementById('story-modal-content');
            storyModalContent.innerHTML = '<p class="text-gray-500 italic">Loading story...</p>'; // Clear previous content and show loading
            storyModal.style.display = "block"; // Show modal immediately

             try {
                 const docRef = doc(db, getUserPlansCollectionPath(), monthId);
                 const docSnap = await getDoc(docRef);
                 if (docSnap.exists()) {
                     const dayData = docSnap.data().weeks?.[weekId]?.days?.[dayIndex];
                     const rowData = dayData?.rows?.[rowIndex];
                     const story = rowData?.story;
                     const vocabData = rowData?.vocabData; // Get the vocab data for this row

                     if (story) {
                         let highlightedStory = escapeHtml(story); // Start with escaped story text

                         if (vocabData && vocabData.length > 0) {
                             // Create a sorted list of vocab words (longer words first to avoid partial matches)
                             const wordsToHighlight = vocabData
                                 .map(v => v.word?.trim())
                                 .filter(Boolean) // Remove empty words
                                 .sort((a, b) => b.length - a.length); // Sort longest first

                             wordsToHighlight.forEach(word => {
                                 // Use RegExp for case-insensitive, whole word matching
                                 // \b ensures word boundaries (prevents matching 'cat' inside 'category')
                                 // 'gi' flags: global (all occurrences) and case-insensitive
                                 const regex = new RegExp(`\\b(${escapeRegExp(word)})\\b`, 'gi');

                                 // Replace found words with highlighted span, preserving original casing
                                 highlightedStory = highlightedStory.replace(regex, (match) => {
                                     // Check if already inside a span (avoid nested highlighting)
                                     // This is a basic check; complex HTML might need a more robust parser
                                     const surroundingChars = highlightedStory.substring(
                                         Math.max(0, highlightedStory.indexOf(match) - 25),
                                         highlightedStory.indexOf(match) + match.length + 10
                                     );
                                     if (surroundingChars.includes('<span class="highlighted-vocab">')) {
                                         return match; // Already highlighted (or part of one), skip
                                     }
                                     return `<span class="highlighted-vocab">${match}</span>`;
                                 });
                             });
                         }
                         // Use innerHTML to render the spans
                         storyModalContent.innerHTML = highlightedStory.replace(/\n/g, '<br>'); // Replace newlines with <br> for display

                     } else {
                         storyModalContent.textContent = "No story found for this entry.";
                     }
                 } else {
                     storyModalContent.textContent = "Study plan data not found.";
                 }
             } catch (error) {
                 console.error("Error reading or highlighting story:", error);
                 storyModalContent.textContent = "Could not load or process the story.";
                 showCustomAlert("Could not load story.");
             }
        }

        // Helper function to escape special characters for RegExp
        function escapeRegExp(string) {
          return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
        }

        // --- Other Utility functions ---
         function calculateWeeklyProgress(weekData) {
            if (!weekData || !weekData.days) return 0; // Check if days exist

            let totalPercentage = 0;
            let totalRows = 0;
            const daysSource = weekData.days;

            // Function to process rows within a day (handles both Array and Map for rows)
            const processDayRows = (day) => {
                 const rowsSource = day?.rows;
                 if (!rowsSource) return;

                 if (Array.isArray(rowsSource)) {
                     // Handle NEW Array structure for rows
                     rowsSource.forEach(row => {
                         totalRows++;
                         if (row.completed) {
                             const perc = parsePercentage(row.completionPercentage);
                             totalPercentage += (perc === null ? 100 : perc);
                         }
                     });
                 } else if (typeof rowsSource === 'object' && !Array.isArray(rowsSource)) {
                     // Handle OLD Map structure for rows
                     Object.values(rowsSource).forEach(row => { // Iterate over values (the row objects)
                         totalRows++;
                         if (row.completed) {
                             const perc = parsePercentage(row.completionPercentage);
                             totalPercentage += (perc === null ? 100 : perc);
                         }
                     });
                 }
            };

            // Iterate over days depending on whether it's an Array or Map
            if (Array.isArray(daysSource)) {
                 // Handle NEW Array structure for days
                 if (daysSource.length === 0) return 0;
                 daysSource.forEach(processDayRows);
            } else if (typeof daysSource === 'object' && !Array.isArray(daysSource)) {
                 // Handle OLD Map structure for days
                 const dayKeys = Object.keys(daysSource);
                 if (dayKeys.length === 0) return 0;
                 dayKeys.forEach(key => processDayRows(daysSource[key])); // Pass the day object
            } else {
                 return 0; // Not an array or object, or empty
            }

            // Calculate average percentage based on number of rows
            return totalRows === 0 ? 0 : Math.min(Math.round(totalPercentage / totalRows), 100);
        }
        async function updateWeeklyProgressUI(monthId, weekId) {
             if (!currentUser || !userId) return;
             const weekSection = document.querySelector(`[data-month-id="${monthId}"] .week-section[data-week-id="${weekId}"]`);
             if (!weekSection) return;
             const progressBarFill = weekSection.querySelector('.progress-bar-fill');
             const progressPercentageSpan = weekSection.querySelector('.progress-percentage');
             try {
                const docRef = doc(db, getUserPlansCollectionPath(), monthId); const docSnap = await getDoc(docRef);
                 if (docSnap.exists()) {
                     const weekData = docSnap.data().weeks?.[weekId]; const progress = calculateWeeklyProgress(weekData);
                    progressBarFill.style.width = `${progress}%`; progressPercentageSpan.textContent = `${progress}%`;
                 }
             } catch (error) { console.error("Error fetching data for progress UI:", error); }
        }
        function showVocabMeaning(vocabWordElement) {
             document.querySelectorAll('.vocab-word.active').forEach(v => { if (v !== vocabWordElement) v.classList.remove('active'); });
             vocabWordElement.classList.toggle('active');
        }
        window.closeModal = function(modalId) { document.getElementById(modalId).style.display = "none"; }
        window.onclick = function(event) {
             if (event.target.classList.contains('modal')) { event.target.style.display = "none"; }
             if (!event.target.closest('.vocab-word')) { document.querySelectorAll('.vocab-word.active').forEach(v => v.classList.remove('active')); }
         }
        function parsePercentage(value) {
            if (value === null || value === undefined) return null; let strVal = String(value).trim(); if (strVal === '') return null;
            if (strVal.includes('/')) {
                const parts = strVal.split('/'); const num = parseFloat(parts[0]); const den = parseFloat(parts[1]);
                if (!isNaN(num) && !isNaN(den) && den !== 0) { return Math.min(Math.max(parseFloat((num / den * 100).toFixed(10)), 0), 100); } // Convert fraction to percentage
            }
            strVal = strVal.replace(',', '.').replace('%', ''); // Allow comma, dot, and % sign
            const floatVal = parseFloat(strVal);
            if (!isNaN(floatVal)) { return Math.min(Math.max(parseFloat(floatVal.toFixed(10)), 0), 100); } // Clamp between 0 and 100
            return null; // Invalid input
         }
         function setSyncStatus(text, color) {
             if (!syncStatusText) return; syncStatusText.textContent = text;
             syncStatusText.classList.remove('text-emerald-500', 'text-yellow-500', 'text-red-500', 'text-blue-500');
             if (color === 'green') syncStatusText.classList.add('text-emerald-500');
             else if (color === 'yellow') syncStatusText.classList.add('text-yellow-500');
             else if (color === 'red') syncStatusText.classList.add('text-red-500');
             else if (color === 'blue') syncStatusText.classList.add('text-blue-500');
         }
         function showCustomAlert(message, type = "error") {
             console.log(`ALERT (${type}): ${message}`);
             const alertBox = document.createElement('div');
             alertBox.style.cssText = `position:fixed; top:80px; left:50%; transform:translateX(-50%); padding:12px 24px; border-radius:8px; z-index:200; box-shadow:0 4px 12px rgba(0,0,0,0.15); font-size: 0.9rem; font-weight: 500;`;
             if (type === 'success') { alertBox.style.backgroundColor = '#10b981'; alertBox.style.color = 'white'; }
             else { alertBox.style.backgroundColor = '#ef4444'; alertBox.style.color = 'white'; }
             alertBox.textContent = message; document.body.appendChild(alertBox);
             setTimeout(() => { alertBox.remove(); }, 3000);
         }

    </script>
</body>
</html>