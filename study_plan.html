<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-JWZXVQC68L"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-JWZXVQC68L');
	</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Caddy - My Study Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Naskh+Arabic:wght@400;700&family=Kalpurush:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Link to your existing style.css for consistency (Optional, styles below override/complement) -->
    <!-- <link rel="stylesheet" href="style.css"> -->
    <link rel="icon" href="https://eco.du.ac.bd//assets/images/fab_icon.ico" type="image/x-icon">
    <style>
        /* --- Light Theme & Motivational Styles --- */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
        }
        /* Subtle background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(circle at top right, rgba(16, 185, 129, 0.05), transparent 40%),
                              radial-gradient(circle at bottom left, rgba(99, 102, 241, 0.05), transparent 40%);
            z-index: -1;
            opacity: 0.6;
        }
        .kalpurush { font-family: 'Kalpurush', sans-serif; }
        .arabic-font { font-family: 'Noto Naskh Arabic', serif; }

        /* --- General Button Styles --- */
        .action-button {
            background-color: #10b981; /* emerald-500 */
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
            border: none;
            font-size: 0.875rem; /* text-sm */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .action-button:hover {
            background-color: #059669; /* emerald-600 */
        }
         .action-button:active {
            transform: scale(0.98);
        }
        .action-button-secondary {
             background-color: #e5e7eb; /* gray-200 */
             color: #374151; /* gray-700 */
             box-shadow: none;
             border: 1px solid #d1d5db; /* gray-300 */
        }
        .action-button-secondary:hover {
             background-color: #d1d5db; /* gray-300 */
        }
        .action-button-danger {
            background-color: #fecaca; /* red-200 */
            color: #b91c1c; /* red-700 */
            box-shadow: none;
            border: 1px solid #fca5a5; /* red-300 */
        }
         .action-button-danger:hover {
            background-color: #fca5a5; /* red-300 */
             color: #991b1b; /* red-800 */
        }
        .icon-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 999px;
            transition: background-color 0.2s, color 0.2s;
            color: #9ca3af; /* gray-400 */
        }
         .icon-button:hover {
             background-color: #e5e7eb; /* gray-200 */
             color: #ef4444; /* red-500 for delete */
         }
         .icon-button.add:hover {
             color: #10b981; /* emerald-500 for add */
         }


        /* --- Card Styles --- */
        .card {
            background-color: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb; /* gray-200 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem; /* p-6 */
        }

        /* --- Table & Editing Styles --- */
        .study-table thead {
            background-color: #f9fafb; /* gray-50 */
            color: #4b5563; /* gray-600 */
            font-size: 0.75rem; /* text-xs */
        }
        .study-table tbody tr {
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        .study-table tbody tr:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        .study-table td, .study-table th {
            padding: 8px 12px; /* px-3 py-2 */
            vertical-align: middle;
        }
        .study-table th { text-align: left; }
        .study-table td.center-cell { text-align: center; }

        .editable-input, .vocab-input {
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 4px;
            padding: 6px 8px;
            color: #1f2937; /* gray-800 */
            width: 100%;
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
         .editable-input:focus, .vocab-input:focus {
             outline: none;
             border-color: #34d399; /* emerald-400 */
             box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
         }
        textarea.editable-input { min-height: 40px; }

        tr.editing-mode td { background-color: #f0fdf4; } /* emerald-50 */

        /* --- Vocabulary Specific Styles --- */
        .vocab-word {
            cursor: pointer;
            text-decoration: none;
            border-bottom: 1px dotted #10b981; /* emerald-500 */
            margin-right: 8px;
            padding-bottom: 1px;
             color: #047857; /* emerald-700 */
             font-weight: 500;
            transition: color 0.2s;
        }
        .vocab-word:hover {
            color: #064e3b; /* emerald-900 */
        }
        .vocab-pair {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .vocab-pair .vocab-input {
            flex-grow: 1;
        }

        /* --- Modal Styles --- */
        .modal { display: none; /* ... rest of modal styles */ position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background-color: #ffffff; margin: 10% auto; padding: 25px; border: 1px solid #e5e7eb; width: 90%; max-width: 550px; border-radius: 10px; position: relative; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); }
        .modal-close { color: #9ca3af; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover, .modal-close:focus { color: #1f2937; }
         #story-textarea { background-color: #f9fafb; border: 1px solid #d1d5db; color: #1f2937; }

        /* --- Progress Bar --- */
        .progress-bar-container { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 12px; }
        .progress-bar-fill { background-color: #10b981; /* ... rest of progress bar styles */ height: 100%; transition: width 0.3s ease-in-out; text-align: center; line-height: 12px; font-size: 10px; color: white; font-weight: bold; border-radius: 9999px; }

        /* --- Add Day Button --- */
        .add-day-btn { display: flex; align-items: center; justify-content: center; background-color: #ecfdf5; color: #059669; border: 1px dashed #34d399; /* ... rest of add day styles */ border-radius: 8px; padding: 12px; margin-top: 1rem; cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .add-day-btn:hover { background-color: #d1fae5; color: #047857; border-color: #6ee7b7; }
        .add-day-btn i { margin-right: 8px; }

         /* --- Month Navigation --- */
         #month-nav-buttons button {
             background-color: #e5e7eb; /* gray-200 */
             color: #374151; /* gray-700 */
             margin-right: 8px;
             margin-bottom: 8px;
             padding: 6px 12px;
         }
         #month-nav-buttons button:hover {
             background-color: #d1d5db; /* gray-300 */
         }
          #month-nav-buttons button.active-month {
             background-color: #10b981; /* emerald-500 */
             color: white;
             font-weight: 700;
         }

        /* --- Header Adjustments --- */
         header nav a { color: #d1d5db; /* gray-300 */ } /* Default nav link color */
         header nav a:hover { color: white; }
         header nav #academic-button,
         header nav #academic-button a { color: #d1d5db; } /* Ensure dropdown button matches */
         header nav a.bg-emerald-500 { color: white !important; } /* Active link */
         header #auth-container-desktop .text-gray-200 { color: #e5e7eb; } /* Lighter gray for name */
         header #auth-container-desktop .text-gray-400 { color: #9ca3af; } /* Medium gray for email */

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header (Assuming you have a standard header included via server-side or copy-pasted) -->
    <!-- You Copy/Paste your existing header structure here -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-sm border-b border-gray-200 main-website-ui shadow-sm">
        <div class="container mx-auto px-6 py-3">
            <nav class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <a href="https://facebook.com/emammehedi17" target="_blank" rel="noopener noreferrer">
                        <img src="images/profile.jpg" alt="Profile" class="h-10 w-10 rounded-full border-2 border-emerald-500 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/40x40/ffffff/059669?text=CC';">
                    </a>
                    <a href="index.html">
                        <h1 class="text-xl font-bold text-gray-800">Class Caddy</h1>
                    </a>
                </div>
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center gap-1 bg-gray-100/50 border border-gray-200 rounded-full p-1 text-sm">
                    <a href="index.html" class="px-5 py-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-full transition-colors">Home</a>
                    <div id="academic-dropdown" class="relative">
                        <button id="academic-button" class="px-5 py-1.5 font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-full transition-colors flex items-center">
                            <a href="academic.html" class="flex items-center">Academic <svg class="w-4 h-4 ml-1 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></a>
                        </button>
                        <div id="academic-menu" class="dropdown-menu absolute top-full left-1/2 -translate-x-1/2 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg hidden">
                            <a href="course-405.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Course 405</a>
                            <a href="course-406.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Course 406</a>
                            <a href="course-407.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Course 407</a>
                            <a href="course-408.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Course 408 (B)</a>
                        </div>
                    </div>
                     <a href="study_plan.html" class="px-5 py-1.5 bg-emerald-500 text-white rounded-full transition-colors">Study Plan</a> <!-- Active -->
                    <a href="shop.html" class="px-5 py-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-full transition-colors">Shop</a>
                    <a href="about.html" class="px-5 py-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-full transition-colors">About</a>
                    <a href="contact.html" class="px-5 py-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-full transition-colors">Contact</a>
                </div>
                 <!-- Desktop Auth / DU Logo -->
                <div class="hidden md:flex items-center gap-4">
                    <a href="https://du.ac.bd/" target="_blank" rel="noopener noreferrer">
                        <img src="images/du_logo.png" alt="DU Logo" class="h-10 w-10 rounded-full border border-gray-200 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/40x40/eeeeee/111827?text=DU';">
                    </a>
                     <div id="auth-container-desktop" class="auth-container text-sm">
                         <a href="index.html#signup" class="px-5 py-2 font-semibold bg-emerald-500 hover:bg-emerald-600 text-white rounded-full transition-colors signup-button">Sign Up</a>
                    </div>
                </div>
                 <!-- Mobile Menu Button -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button" class="text-gray-700 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </nav>
             <!-- Mobile Menu Panel -->
             <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-200 -mx-6 mt-3 shadow-md">
                <a href="index.html" class="block px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">Home</a>
                <div>
                    <button id="mobile-academic-button" class="w-full text-left px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors flex justify-between items-center">
                        <span>Academic</span>
                        <svg class="w-4 h-4 transition-transform duration-300 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="mobile-academic-menu" class="hidden pl-8 bg-gray-50">
                        <a href="course-405.html" class="block px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 transition-colors">Course 405</a>
                        <a href="course-406.html" class="block px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 transition-colors">Course 406</a>
                        <a href="course-407.html" class="block px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 transition-colors">Course 407</a>
                        <a href="course-408.html" class="block px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 transition-colors">Course 408 (B)</a>
                    </div>
                </div>
                 <a href="study_plan.html" class="block px-6 py-3 text-sm font-semibold text-emerald-600 bg-emerald-50 transition-colors">Study Plan</a> <!-- Active -->
                <a href="shop.html" class="block px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">Shop</a>
                <a href="about.html" class="block px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">About</a>
                <a href="contact.html" class="block px-6 py-3 text-sm text-gray-700 hover:bg-gray-100 transition-colors">Contact</a>
                <div id="auth-container-mobile" class="auth-container px-6 py-4 border-t border-gray-200">
                    <a href="index.html#signup" class="block w-full text-center text-sm font-semibold bg-emerald-500 hover:bg-emerald-600 text-white rounded-full py-2 transition-colors signup-button">Sign Up</a>
                </div>
            </div>
        </div>
    </header>
    <!-- End Header -->

    <!-- Main Content Area -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 pt-28 pb-16"> <!-- Increased pt -->

        <h1 class="text-3xl sm:text-4xl font-bold text-emerald-600 mb-8 text-center">My Study Plan</h1>

        <!-- Auth Status / Login Section -->
        <div id="auth-section" class="mb-10 card">
             <div id="login-prompt" class="text-center">
                <p class="text-gray-600 mb-4">Log in to create and manage your personalized study plans.</p>
                <button id="google-login-btn" class="action-button bg-red-500 hover:bg-red-600 text-white shadow-sm">
                    <i class="fab fa-google mr-2"></i> Sign in with Google
                </button>
            </div>
             <div id="user-info" class="hidden flex flex-col sm:flex-row justify-between items-center text-sm">
                 <div class="flex items-center gap-3 mb-3 sm:mb-0 text-gray-600">
                     <i class="fas fa-check-circle text-emerald-500"></i>
                     <span class="font-semibold">Sync Status:</span>
                     <span class="text-emerald-500 font-medium">Synced</span>
                     <span id="user-id-display" class="ml-4 text-xs text-gray-400 break-all" title="Your unique User ID"></span>
                 </div>
                <div class="text-center sm:text-right">
                    <p id="user-display" class="font-medium text-gray-800"></p>
                    <p id="user-email-display" class="text-gray-500 text-xs"></p>
                    <button id="logout-btn" class="mt-1 text-red-500 hover:text-red-700 text-xs font-semibold">Log Out</button>
                </div>
            </div>
        </div>

        <!-- Study Plan Content (Hidden until logged in) -->
        <div id="study-plan-content" class="hidden">

            <!-- Month Navigation & Add Button -->
            <div class="mb-8 flex flex-wrap items-center gap-2">
                 <span class="text-sm font-medium text-gray-500 mr-2">Months:</span>
                 <div id="month-nav-buttons" class="flex-grow flex flex-wrap gap-2">
                     <!-- Month buttons loaded here -->
                 </div>
                 <button id="add-month-btn" class="action-button flex items-center gap-1.5 ml-auto flex-shrink-0">
                     <i class="fas fa-plus-circle text-sm"></i> Add Month
                 </button>
            </div>

            <!-- Container for the Currently Displayed Monthly Plan -->
            <div id="current-month-plan-display">
                <!-- Selected month plan will be loaded here by JavaScript -->
                 <p id="no-plans-message" class="text-center text-gray-500 italic py-10">No study plans found. Click "Add Month" to create one.</p>
                 <p id="select-month-message" class="text-center text-gray-500 italic py-10 hidden">Select a month from the buttons above to view its plan.</p>
            </div>

        </div> <!-- End Study Plan Content -->

    </main>

    <!-- Modal for Vocabulary Meaning -->
    <div id="vocab-modal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal('vocab-modal')">&times;</span>
        <h3 id="vocab-modal-word" class="text-xl font-semibold mb-3 text-emerald-600">Word</h3>
        <p id="vocab-modal-meaning" class="text-gray-700"></p>
      </div>
    </div>

    <!-- Modal for Story -->
    <div id="story-modal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal('story-modal')">&times;</span>
        <h3 class="text-xl font-semibold mb-3 text-emerald-600">Story</h3>
        <p id="story-modal-content" class="text-gray-700 whitespace-pre-wrap"></p>
      </div>
    </div>

     <!-- Modal for Adding/Editing Story -->
    <div id="edit-story-modal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal('edit-story-modal')">&times;</span>
        <h3 class="text-xl font-semibold mb-3 text-emerald-600">Add/Edit Story</h3>
        <textarea id="story-textarea" rows="6" class="w-full p-2 bg-gray-50 border border-gray-300 rounded-md text-gray-800 placeholder-gray-400 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Write a story using the vocabulary words..."></textarea>
        <div class="mt-4 flex justify-end gap-3">
             <button onclick="closeModal('edit-story-modal')" class="action-button action-button-secondary">Cancel</button>
             <button id="save-story-btn" class="action-button">Save Story</button>
        </div>
      </div>
    </div>

     <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal('confirm-modal')">&times;</span>
        <h3 id="confirm-modal-title" class="text-lg font-semibold mb-4 text-gray-800">Confirm Action</h3>
        <p id="confirm-modal-message" class="text-gray-600 mb-6">Are you sure?</p>
        <div class="flex justify-end gap-3">
             <button id="confirm-modal-cancel" class="action-button action-button-secondary">Cancel</button>
             <button id="confirm-modal-confirm" class="action-button action-button-danger">Confirm</button>
        </div>
      </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Import necessary functions from Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc, getDoc, collection, query, getDocs, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, writeBatch, Timestamp, where, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        setLogLevel('debug'); // Keep debug logging enabled for now

        // PASTE YOUR ACTUAL FIREBASE CONFIG HERE:
        const firebaseConfig = {
          apiKey: "AIzaSyAj7MDnrnzKUO73BXG0jeM-uBGrAH3XiAY", // <-- YOUR ACTUAL KEY
          authDomain: "study-plan17.firebaseapp.com", // <-- YOURS
          projectId: "study-plan17", // <-- YOURS
          storageBucket: "study-plan17.appspot.com", // <-- YOURS
          messagingSenderId: "394648483332", // <-- YOURS
          appId: "1:394648483332:web:31c0d7a8b3f7065ce4e751", // <-- YOURS
          measurementId: "G-61TH4D55J3" // <-- YOURS (Optional)
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; // Use projectId as fallback app identifier if __app_id is missing

        console.log("Using manually added Firebase config:", firebaseConfig); // Log that manual config is used


        // Initialize Firebase
        let app;
        let auth;
        let db;
        let googleProvider;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            googleProvider = new GoogleAuthProvider();
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("CRITICAL ERROR initializing Firebase:", error);
            console.error("Firebase Config Used:", firebaseConfig);
             const authSection = document.getElementById('auth-section');
             if(authSection) authSection.innerHTML = `<p class="text-red-500 font-bold text-center">Error: Could not initialize Firebase. Please check the console.</p>`;
             throw new Error("Firebase initialization failed.");
        }
        // --- End Firebase Configuration ---

        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const loginPrompt = document.getElementById('login-prompt');
        const userInfo = document.getElementById('user-info');
        const userDisplay = document.getElementById('user-display');
        const userEmailDisplay = document.getElementById('user-email-display');
        const userIdDisplay = document.getElementById('user-id-display');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn'); // Main logout button
        const studyPlanContent = document.getElementById('study-plan-content');
        const addMonthBtn = document.getElementById('add-month-btn');
        const monthNavButtonsContainer = document.getElementById('month-nav-buttons');
        const currentMonthPlanDisplay = document.getElementById('current-month-plan-display');
        const noPlansMessage = document.getElementById('no-plans-message');
        const selectMonthMessage = document.getElementById('select-month-message');

        const authContainerDesktop = document.getElementById('auth-container-desktop');
        const authContainerMobile = document.getElementById('auth-container-mobile');

        // Modals
        const vocabModal = document.getElementById('vocab-modal');
        const storyModal = document.getElementById('story-modal');
        const editStoryModal = document.getElementById('edit-story-modal');
        const saveStoryBtn = document.getElementById('save-story-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel');


        let currentUser = null;
        let userId = null;
        let unsubscribePlans = null;
        let currentStoryTarget = null;
        let currentConfirmAction = null; // To store the function to execute on confirm


        // --- Authentication ---
        function updateAuthUI(user) {
             // Simplified - assumes script.js might handle some header parts
             if (user) {
                currentUser = user;
                userId = user.uid;
                console.log("User logged in:", userId);

                loginPrompt.style.display = 'none';
                userInfo.classList.remove('hidden');
                userDisplay.textContent = user.displayName || 'User';
                userEmailDisplay.textContent = user.email || '';
                userIdDisplay.textContent = `ID: ${userId}`;
                userIdDisplay.title = 'Your unique User ID';
                logoutBtn.classList.remove('hidden');

                // Update Header elements (basic example)
                const loggedInHTML = `<div class="text-sm"><p class="font-semibold text-gray-700">${user.displayName || 'User'}</p><p class="text-gray-500 text-xs">${user.email || ''}</p></div><button id="logout-btn-header" class="ml-3 action-button action-button-danger text-xs px-3 py-1">Log Out</button>`;
                authContainerDesktop.innerHTML = loggedInHTML;
                authContainerMobile.innerHTML = loggedInHTML.replace('ml-3', 'w-full mt-2').replace('logout-btn-header', 'logout-btn-mobile'); // Adjust mobile layout

                document.getElementById('logout-btn-header')?.addEventListener('click', handleLogout);
                document.getElementById('logout-btn-mobile')?.addEventListener('click', handleLogout);


                studyPlanContent.classList.remove('hidden');
                loadStudyPlans(); // Load plans AND month buttons
            } else {
                currentUser = null;
                userId = null; // No persistent ID if logged out
                console.log("User logged out");

                loginPrompt.style.display = 'block';
                userInfo.classList.add('hidden');
                logoutBtn.classList.add('hidden');

                 // Update Header elements (basic example)
                 const loggedOutHTML = `<a href="index.html#signup" class="px-5 py-2 font-semibold bg-emerald-500 hover:bg-emerald-600 text-white rounded-full transition-colors signup-button text-sm">Sign Up</a>`;
                 authContainerDesktop.innerHTML = loggedOutHTML;
                 authContainerMobile.innerHTML = loggedOutHTML.replace('px-5 py-2', 'block w-full text-center py-2');


                studyPlanContent.classList.add('hidden');
                monthNavButtonsContainer.innerHTML = ''; // Clear nav
                currentMonthPlanDisplay.innerHTML = ''; // Clear display
                noPlansMessage.style.display = 'block';
                 selectMonthMessage.classList.add('hidden');
                if (unsubscribePlans) {
                    unsubscribePlans();
                    unsubscribePlans = null;
                }
            }
        }

        onAuthStateChanged(auth, async (user) => {
             console.log("Auth state changed. User:", user);
             if (user) {
                updateAuthUI(user);
             } else {
                 // Try custom token first, then anonymous as fallback ONLY IF no Google login attempt is pending
                 if (auth.currentUser) { // If a user object exists (e.g., anonymous), just update UI
                     updateAuthUI(auth.currentUser);
                     return;
                 }

                 if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                     try {
                         console.log("Attempting sign in with custom token...");
                         await signInWithCustomToken(auth, __initial_auth_token);
                         console.log("Sign in with custom token successful."); // onAuthStateChanged triggers again
                     } catch (error) {
                         console.error("Error signing in with custom token, trying anonymous:", error);
                         try { await signInAnonymously(auth); console.log("Anonymous sign in successful."); }
                         catch (anonError) { console.error("Error signing in anonymously:", anonError); updateAuthUI(null); }
                     }
                 } else {
                     console.log("No user, no custom token, trying anonymous...");
                     try { await signInAnonymously(auth); console.log("Anonymous sign in successful."); }
                     catch (anonError) { console.error("Error signing in anonymously:", anonError); updateAuthUI(null); }
                 }
             }
        });

        googleLoginBtn.addEventListener('click', async () => { try { await signInWithPopup(auth, googleProvider); } catch (error) { console.error("Google Sign-In Error:", error); } });
        async function handleLogout() { try { await signOut(auth); console.log("Logout successful."); } catch (error) { console.error("Logout Error:", error); } }
        logoutBtn.addEventListener('click', handleLogout); // Attach to main logout btn


        // --- Firestore ---
        function getUserPlansCollectionPath() { if (!userId) throw new Error("User ID is not available."); return `artifacts/${appId}/users/${userId}/studyPlans`; }

        // Load plans AND setup month navigation
        async function loadStudyPlans() {
            if (!currentUser || !userId) return;
            console.log("Loading study plans for user:", userId);

            const plansCollectionPath = getUserPlansCollectionPath();
            const q = query(collection(db, plansCollectionPath), orderBy("monthName")); // Order by name for buttons

            if (unsubscribePlans) unsubscribePlans(); // Detach old listener

            unsubscribePlans = onSnapshot(q, (querySnapshot) => {
                console.log("Received plans snapshot. Number of plans:", querySnapshot.size);
                monthNavButtonsContainer.innerHTML = ''; // Clear old buttons
                currentMonthPlanDisplay.innerHTML = ''; // Clear old display

                if (querySnapshot.empty) {
                    noPlansMessage.style.display = 'block';
                    selectMonthMessage.classList.add('hidden');
                } else {
                    noPlansMessage.style.display = 'none';
                    selectMonthMessage.classList.remove('hidden'); // Show select message initially
                    let firstMonthId = null;

                    querySnapshot.forEach((docSnap) => {
                        const monthId = docSnap.id;
                        const monthData = docSnap.data();
                        if (!firstMonthId) firstMonthId = monthId; // Keep track of the first month

                        const button = document.createElement('button');
                        button.textContent = monthData.monthName || monthId;
                        button.dataset.monthId = monthId;
                        button.classList.add('action-button', 'action-button-secondary', 'text-xs');
                        button.addEventListener('click', () => displayMonthPlan(monthId));
                        monthNavButtonsContainer.appendChild(button);
                    });

                    // Optionally, auto-load the first month
                    // if (firstMonthId) {
                    //    displayMonthPlan(firstMonthId);
                    // }
                }
            }, (error) => {
                console.error("Error fetching study plans:", error);
                currentMonthPlanDisplay.innerHTML = '<p class="text-red-500 text-center">Error loading plans.</p>';
                noPlansMessage.style.display = 'none';
                selectMonthMessage.classList.add('hidden');

            });
        }

         // Display a specific month's plan
        async function displayMonthPlan(monthId) {
            if (!currentUser || !userId) return;
             console.log("Displaying plan for month:", monthId);

             // Highlight active button
             monthNavButtonsContainer.querySelectorAll('button').forEach(btn => {
                 btn.classList.toggle('active-month', btn.dataset.monthId === monthId);
                 btn.classList.toggle('action-button-secondary', btn.dataset.monthId !== monthId); // Ensure others are secondary
             });


             currentMonthPlanDisplay.innerHTML = '<p class="text-center text-gray-500 italic py-10">Loading...</p>'; // Loading indicator
             selectMonthMessage.classList.add('hidden');


             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             try {
                 const docSnap = await getDoc(docRef);
                 if (docSnap.exists()) {
                     currentMonthPlanDisplay.innerHTML = ''; // Clear loading/message
                     currentMonthPlanDisplay.appendChild(createMonthElement(monthId, docSnap.data()));
                 } else {
                     console.error("Document for monthId not found:", monthId);
                     currentMonthPlanDisplay.innerHTML = '<p class="text-red-500 text-center">Could not find plan data for this month.</p>';
                 }
             } catch (error) {
                 console.error("Error fetching specific month plan:", error);
                 currentMonthPlanDisplay.innerHTML = '<p class="text-red-500 text-center">Error loading this month\'s plan.</p>';
             }
         }


       // Add a new month (logic remains similar, but UI update is handled by loadStudyPlans via snapshot)
        addMonthBtn.addEventListener('click', async () => {
             if (!currentUser || !userId) return;
             // ... (rest of the prompt and ID generation logic is the same) ...
            const currentYear = new Date().getFullYear();
            const currentMonthIndex = new Date().getMonth(); // 0-11
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const nextMonthIndex = (currentMonthIndex + 1) % 12;
            const nextMonthYear = currentMonthIndex === 11 ? currentYear + 1 : currentYear;
            const suggestedMonthName = `${monthNames[nextMonthIndex]} ${nextMonthYear}`;
            const monthNameInput = prompt("Enter month name (e.g., 'October 2025'):", suggestedMonthName);
             if (!monthNameInput || monthNameInput.trim() === '') return;
             const monthName = monthNameInput.trim();

             let monthId = '';
             try {
                const parts = monthName.split(' ');
                const year = parseInt(parts[1]);
                const monthIndex = monthNames.findIndex(m => m.toLowerCase() === parts[0].toLowerCase());
                if (year && monthIndex !== -1 && year > 1900 && year < 3000) { // Basic validation
                    monthId = `${year}-${(monthIndex + 1).toString().padStart(2, '0')}`;
                } else { throw new Error("Invalid format"); }
             } catch (e) {
                 monthId = `${nextMonthYear}-${(nextMonthIndex + 1).toString().padStart(2, '0')}`;
                 console.warn("Could not parse month name, using generated ID:", monthId);
             }

             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             const docSnap = await getDoc(docRef);
             if (docSnap.exists()) { showCustomAlert(`Month ID ${monthId} already exists.`); return; }

             const newPlanData = {
                monthName: monthName, // Use the trimmed name
                createdAt: Timestamp.now(),
                weeklyTargets: { week1: '', week2: '', week3: '', week4: '' },
                weeks: {
                    week1: { days: [] }, week2: { days: [] }, week3: { days: [] }, week4: { days: [] }
                }
             };
            // Initialize Week 1 with a default day/row if preferred, or leave empty
            // newPlanData.weeks.week1.days = [{ dayNumber: 1, date: '', rows: [...] }];

            try { await setDoc(docRef, newPlanData); console.log("New month added:", monthId); }
            catch (error) { console.error("Error adding new month:", error); showCustomAlert("Error adding month."); }
        });


        // --- UI Creation ---

        function createMonthElement(monthId, data) {
             // ... (innerHTML structure remains largely the same as before) ...
            const monthDiv = document.createElement('div');
            // USE light theme card style:
            monthDiv.className = 'mb-12 p-6 card'; // Use the card class
            monthDiv.dataset.monthId = monthId;

            monthDiv.innerHTML = `
                <div class="flex justify-between items-start mb-6">
                     <h2 class="text-2xl font-bold text-emerald-600">${data.monthName || 'Unnamed Month'} <span class="text-lg text-gray-400 font-normal">(${monthId})</span></h2>
                     <button class="icon-button delete-month-btn" title="Delete Month"><i class="fas fa-trash-alt text-red-500"></i></button>
                 </div>

                 <!-- Monthly Targets -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Monthly Targets</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 monthly-targets">
                        ${[1, 2, 3, 4].map(weekNum => `
                            <div class="bg-gray-50 border border-gray-200 p-3 rounded-md shadow-sm">
                                <label for="target-week-${monthId}-${weekNum}" class="block text-sm font-medium text-emerald-700 mb-1">Week ${weekNum}</label>
                                <textarea id="target-week-${monthId}-${weekNum}" data-week="week${weekNum}" rows="3" class="editable-input w-full text-sm placeholder-gray-400 bg-white" placeholder="Enter target...">${data.weeklyTargets?.[`week${weekNum}`] || ''}</textarea>
                            </div>
                        `).join('')}
                    </div>
                     <div class="text-right mt-3">
                        <button class="action-button action-button-secondary text-xs save-targets-btn">Save Targets</button>
                    </div>
                </div>

                 <!-- Weekly Plans Container -->
                <div class="space-y-8 weekly-plans-container">
                    ${[1, 2, 3, 4].map(weekNum => createWeekElement(monthId, `week${weekNum}`, data.weeks?.[`week${weekNum}`])).join('')}
                </div>`;

             monthDiv.querySelector('.save-targets-btn').addEventListener('click', () => saveMonthlyTargets(monthId, monthDiv));
             monthDiv.querySelector('.delete-month-btn').addEventListener('click', () => confirmDeleteMonth(monthId));
             attachWeekEventListeners(monthDiv, monthId);
             return monthDiv;
        }

        function createWeekElement(monthId, weekId, weekData) {
            const daysHtml = weekData?.days?.map((dayData, index) => createDayElement(monthId, weekId, index, dayData)).join('') || '<p class="text-gray-500 italic text-sm py-4 text-center">No days added yet.</p>';
            const totalDays = weekData?.days?.length || 0;
            const initialProgress = calculateWeeklyProgress(weekData);

            return `
                <div class="bg-white/60 border border-gray-200 p-4 rounded-lg shadow week-section" data-week-id="${weekId}">
                    <h3 class="text-lg font-semibold text-emerald-700 mb-4 capitalize">${weekId.replace('week', 'Week ')} Plan</h3>
                    <div class="mb-4">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>Weekly Progress</span>
                            <span class="progress-percentage font-medium">${initialProgress}%</span>
                        </div>
                        <div class="progress-bar-container w-full"> <div class="progress-bar-fill" style="width: ${initialProgress}%;"></div> </div>
                    </div>
                    <div class="days-container space-y-6"> ${daysHtml} </div>
                     ${totalDays < 7 ? (totalDays > 0 ? `<button class="add-day-btn w-full mt-4" data-week-id="${weekId}"><i class="fas fa-plus"></i> Add New Day</button>` : `<button class="action-button mt-4 add-first-day-btn" data-week-id="${weekId}"><i class="fas fa-calendar-plus mr-2"></i> Add First Day</button>`) : '<p class="text-center text-xs text-gray-400 mt-4">Maximum 7 days reached for this week.</p>'}
                </div>`;
        }

        function createDayElement(monthId, weekId, dayIndex, dayData) {
             const tableId = `table-${monthId}-${weekId}-${dayIndex}`;
             return `
                 <div class="day-section border-t border-gray-200 pt-4" data-day-index="${dayIndex}">
                     <div class="flex justify-between items-center mb-3">
                         <div class="flex items-center gap-2">
                             <h4 class="font-semibold text-gray-700">Day ${dayData.dayNumber}</h4>
                             <button class="icon-button delete-day-btn hidden" title="Delete Day"><i class="fas fa-calendar-times text-red-500"></i></button>
                         </div>
                         <button class="action-button action-button-secondary text-xs edit-day-btn"> <i class="fas fa-pencil-alt mr-1"></i> Edit </button>
                     </div>
                     <table class="w-full text-sm text-left text-gray-600 study-table" id="${tableId}">
                         <thead class="text-xs text-gray-500 uppercase">
                             <tr>
                                 <th scope="col" class="px-3 py-2 w-[20%]">Subject</th>
                                 <th scope="col" class="px-3 py-2 w-[40%]">Topic / Vocab</th>
                                 <th scope="col" class="px-3 py-2 w-[20%]">Comment</th>
                                 <th scope="col" class="px-3 py-2 w-[5%] center-cell">Done</th>
                                 <th scope="col" class="px-3 py-2 w-[5%] center-cell completion-perc-header hidden">%</th>
                                 <th scope="col" class="px-3 py-2 w-[5%] center-cell actions-header hidden"></th> <!-- Header for delete btn -->
                             </tr>
                         </thead>
                         <tbody> ${dayData.rows?.map((rowData, rowIndex) => createTableRow(monthId, weekId, dayIndex, rowIndex, rowData, false)).join('') || ''} </tbody>
                     </table>
                     <div class="edit-mode-controls hidden mt-3 space-x-2">
                         <button class="action-button action-button-secondary text-xs add-normal-row-btn"><i class="fas fa-plus mr-1"></i> Add Row</button>
                         <button class="action-button action-button-secondary text-xs add-vocab-row-btn"><i class="fas fa-book mr-1"></i> Add Vocabulary</button>
                         <button class="action-button action-button-secondary text-xs add-story-btn"><i class="fas fa-feather-alt mr-1"></i> Add/Edit Story</button>
                     </div>
                 </div>`;
        }


        function createTableRow(monthId, weekId, dayIndex, rowIndex, rowData, isEditing) {
             const uniqueRowId = `row-${monthId}-${weekId}-${dayIndex}-${rowIndex}`;
             const isVocabRow = rowData.subject?.toLowerCase() === 'vocabulary'; // Use specific subject name

             let topicContent = '';
             if (isEditing) {
                 if (isVocabRow) {
                     topicContent = `<div class="vocab-edit-container space-y-2">`;
                     (rowData.vocabData || [{ word: '', meaning: '' }]).forEach((pair, pairIndex) => {
                         topicContent += `
                             <div class="vocab-pair" data-pair-index="${pairIndex}">
                                 <input type="text" class="vocab-input vocab-word-input" placeholder="Word" value="${escapeHtml(pair.word || '')}">
                                 <input type="text" class="vocab-input vocab-meaning-input" placeholder="Meaning" value="${escapeHtml(pair.meaning || '')}">
                                 <button type="button" class="icon-button delete-vocab-pair-btn" title="Delete Pair"><i class="fas fa-times text-red-500"></i></button>
                             </div>`;
                     });
                     topicContent += `<button type="button" class="icon-button add-vocab-pair-btn mt-1" title="Add Word/Meaning Pair"><i class="fas fa-plus-circle text-emerald-500"></i></button></div>`;
                 } else {
                     topicContent = `<textarea class="editable-input topic-input text-xs" rows="2" placeholder="Topic details...">${rowData.topic || ''}</textarea>`;
                 }
             } else {
                 if (isVocabRow) {
                     topicContent = generateVocabHtml(rowData.vocabData);
                 } else {
                     topicContent = `<span class="topic-display">${rowData.topic || '-'}</span>`;
                 }
             }

             // Read story button only appears in normal mode if a story exists for THIS ROW
             const storyButtonHtml = (!isEditing && rowData.story)
                ? `<button class="action-button action-button-secondary text-xs read-story-btn mt-2 block">Read Story</button>` : '';


             return `
                 <tr id="${uniqueRowId}" data-row-index="${rowIndex}" class="${isEditing ? 'editing-mode' : ''} ${isVocabRow ? 'vocab-row' : 'normal-row'}">
                     <td class="px-3 py-2 align-top">
                         ${isEditing ? `<input type="text" class="editable-input subject-input" placeholder="Subject" value="${escapeHtml(rowData.subject || '')}" ${isVocabRow ? 'readonly style="background-color:#e5e7eb;"' : ''}>` : `<span class="subject-display font-medium text-gray-700">${rowData.subject || '-'}</span>`}
                     </td>
                     <td class="px-3 py-2 align-top vocab-topic-cell">
                         ${topicContent}
                         ${storyButtonHtml}
                     </td>
                     <td class="px-3 py-2 align-top">
                         ${isEditing ? `<textarea class="editable-input comment-input text-xs" rows="2" placeholder="Comment...">${escapeHtml(rowData.comment || '')}</textarea>` : `<span class="comment-display text-xs text-gray-500">${rowData.comment || '-'}</span>`}
                     </td>
                     <td class="px-3 py-2 align-middle center-cell">
                         <input type="checkbox" class="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500 completion-checkbox" ${rowData.completed ? 'checked' : ''} ${isEditing ? 'disabled' : ''}>
                     </td>
                      <td class="px-3 py-2 align-middle center-cell completion-perc-cell ${isEditing ? '' : 'hidden'}">
                          ${isEditing ? `<input type="number" min="0" max="100" class="editable-input completion-perc-input w-16 text-center text-xs" placeholder="%" value="${rowData.completionPercentage ?? ''}">` : ''}
                      </td>
                     <td class="px-3 py-2 align-middle center-cell actions-cell ${isEditing ? '' : 'hidden'}">
                          ${isEditing ? `<button class="icon-button delete-row-btn" title="Delete Row"><i class="fas fa-trash-alt text-red-500"></i></button>` : ''}
                     </td>
                 </tr>`;
        }

        function generateVocabHtml(vocabData) {
            if (!vocabData || vocabData.length === 0) return '-';
            return vocabData.map(v => `<span class="vocab-word" data-meaning="${escapeHtml(v.meaning || '')}">${escapeHtml(v.word || '')}</span>`).join(' '); // Join with space
        }

        function escapeHtml(unsafe) { /* ... same as before ... */
            if (unsafe === null || unsafe === undefined) return '';
             return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }


        // --- Event Listeners ---

         function attachWeekEventListeners(monthElement, monthId) {
             const weeklyPlansContainer = monthElement.querySelector('.weekly-plans-container');

             weeklyPlansContainer.addEventListener('click', async (e) => {
                 const target = e.target;
                 const button = target.closest('button');
                 const weekSection = target.closest('.week-section');
                 if (!weekSection) return;
                 const weekId = weekSection.dataset.weekId;
                 const daySection = target.closest('.day-section');
                 const row = target.closest('tr');

                 // Edit/Save Day Button
                 if (button?.classList.contains('edit-day-btn')) {
                     const isEditing = daySection.classList.contains('editing');
                     toggleDayEditMode(monthId, weekId, daySection, !isEditing);
                 }
                 // Add Normal Row Button (Edit Mode)
                 else if (button?.classList.contains('add-normal-row-btn')) {
                     addRowToDay(monthId, weekId, daySection, 'normal');
                 }
                 // Add Vocab Row Button (Edit Mode)
                  else if (button?.classList.contains('add-vocab-row-btn')) {
                     addRowToDay(monthId, weekId, daySection, 'vocabulary');
                 }
                 // Add/Edit Story Button (Edit Mode) - Opens modal
                 else if (button?.classList.contains('add-story-btn')) {
                      // Find the first vocab row in this day to associate the story
                      const vocabRow = daySection.querySelector('tr.vocab-row');
                      if (vocabRow) {
                          const dayIndex = parseInt(daySection.dataset.dayIndex);
                          const rowIndex = parseInt(vocabRow.dataset.rowIndex);
                          openEditStoryModal(monthId, weekId, dayIndex, rowIndex); // Pass vocab row context
                      } else {
                          showCustomAlert("Please add a Vocabulary row first to attach a story.");
                      }
                 }
                  // Delete Row Button (Edit Mode)
                 else if (button?.classList.contains('delete-row-btn')) {
                     confirmDeleteRow(monthId, weekId, daySection, row);
                 }
                  // Delete Day Button (Edit Mode)
                 else if (button?.classList.contains('delete-day-btn')) {
                     confirmDeleteDay(monthId, weekId, daySection);
                 }
                 // Add Vocab Pair Button (Edit Mode)
                 else if (button?.classList.contains('add-vocab-pair-btn')) {
                      addVocabPairInputs(button.closest('.vocab-edit-container'));
                 }
                 // Delete Vocab Pair Button (Edit Mode)
                 else if (button?.classList.contains('delete-vocab-pair-btn')) {
                      deleteVocabPairInputs(button.closest('.vocab-pair'));
                 }
                 // Completion Checkbox (Normal Mode Only)
                 else if (target.classList.contains('completion-checkbox') && !daySection.classList.contains('editing')) {
                     await saveDayPlan(monthId, weekId, daySection); // Save just the checkbox state
                     updateWeeklyProgressUI(monthId, weekId);
                 }
                 // Vocab Word Click (Normal Mode)
                 else if (target.classList.contains('vocab-word') && !daySection.classList.contains('editing')) {
                     showVocabMeaning(target);
                 }
                 // Read Story Button (Normal Mode)
                 else if (button?.classList.contains('read-story-btn')) {
                     const dayIndex = parseInt(daySection.dataset.dayIndex);
                     const rowIndex = parseInt(row.dataset.rowIndex);
                     readStory(monthId, weekId, dayIndex, rowIndex);
                 }
                 // Add Day Button / Add First Day
                 else if (button?.classList.contains('add-day-btn') || button?.classList.contains('add-first-day-btn')) {
                     addNewDay(monthId, weekId, weekSection);
                 }
             });
        }


        // Toggle Edit Mode
        async function toggleDayEditMode(monthId, weekId, daySection, enterEditMode) {
             const dayIndex = parseInt(daySection.dataset.dayIndex);
             const tableBody = daySection.querySelector('tbody');
             const editButton = daySection.querySelector('.edit-day-btn');
             const editModeControls = daySection.querySelector('.edit-mode-controls');
             const deleteDayButton = daySection.querySelector('.delete-day-btn');
             const actionsHeader = daySection.querySelector('.actions-header');
             const completionPercHeader = daySection.querySelector('.completion-perc-header');


             if (enterEditMode) {
                 daySection.classList.add('editing');
                 editButton.innerHTML = '<i class="fas fa-save mr-1"></i> Save';
                 editButton.classList.remove('action-button-secondary');
                 editModeControls.classList.remove('hidden');
                 deleteDayButton.classList.remove('hidden');
                 actionsHeader.classList.remove('hidden');
                 completionPercHeader.classList.remove('hidden');


                 const planDoc = await getDoc(doc(db, getUserPlansCollectionPath(), monthId));
                 const dayData = planDoc.exists() ? planDoc.data().weeks[weekId]?.days[dayIndex] : null;
                 if (!dayData) return;

                 tableBody.innerHTML = dayData.rows.map((rowData, rowIndex) =>
                    createTableRow(monthId, weekId, dayIndex, rowIndex, rowData, true)
                 ).join('');
                 daySection.querySelectorAll('.completion-checkbox').forEach(cb => cb.disabled = true);

             } else {
                 await saveDayPlan(monthId, weekId, daySection); // Save first

                 daySection.classList.remove('editing');
                 editButton.innerHTML = '<i class="fas fa-pencil-alt mr-1"></i> Edit';
                 editButton.classList.add('action-button-secondary');
                 editModeControls.classList.add('hidden');
                 deleteDayButton.classList.add('hidden');
                 actionsHeader.classList.add('hidden');
                 completionPercHeader.classList.add('hidden');


                 const planDoc = await getDoc(doc(db, getUserPlansCollectionPath(), monthId));
                 const dayData = planDoc.exists() ? planDoc.data().weeks[weekId]?.days[dayIndex] : null;
                 if (!dayData) { tableBody.innerHTML = ''; return; } // Clear if day was deleted somehow

                 tableBody.innerHTML = dayData.rows.map((rowData, rowIndex) =>
                    createTableRow(monthId, weekId, dayIndex, rowIndex, rowData, false)
                 ).join('');

                 updateWeeklyProgressUI(monthId, weekId);
             }
        }


        // Save Day Plan (Improved for new rows and vocab)
        async function saveDayPlan(monthId, weekId, daySection) {
            if (!currentUser || !userId) return;
            const dayIndex = parseInt(daySection.dataset.dayIndex);
            console.log(`Saving day plan for ${monthId}, ${weekId}, Day Index: ${dayIndex}`);

            const docRef = doc(db, getUserPlansCollectionPath(), monthId);
            try {
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) throw new Error("Month document not found.");

                let monthData = docSnap.data();
                let daysArray = monthData.weeks?.[weekId]?.days || [];
                const currentDayData = daysArray[dayIndex];
                 if (!currentDayData) throw new Error(`Day data for index ${dayIndex} not found in Firestore.`);

                const updatedRows = [];
                const rowElements = daySection.querySelectorAll('tbody tr');

                rowElements.forEach(row => {
                    const existingRowIndex = parseInt(row.dataset.rowIndex); // Get original index if exists
                    const existingRowData = currentDayData.rows?.[existingRowIndex] || {}; // Get previous state

                    let subject, topic, comment, completed, completionPercentage, vocabData = null, story;

                    if (daySection.classList.contains('editing')) {
                         subject = row.querySelector('.subject-input')?.value.trim() || '';
                         comment = row.querySelector('.comment-input')?.value.trim() || '';
                         completed = existingRowData.completed || false; // Persist non-editable completed status
                         completionPercentage = parseInt(row.querySelector('.completion-perc-input')?.value) || null;
                         story = existingRowData.story; // Story is saved via modal

                         if (row.classList.contains('vocab-row')) {
                             subject = 'Vocabulary'; // Ensure subject is set for vocab rows
                             vocabData = [];
                             row.querySelectorAll('.vocab-pair').forEach(pairEl => {
                                 const word = pairEl.querySelector('.vocab-word-input')?.value.trim();
                                 const meaning = pairEl.querySelector('.vocab-meaning-input')?.value.trim();
                                 if (word) { // Only save pairs with a word
                                     vocabData.push({ word: word, meaning: meaning || '' });
                                 }
                             });
                             topic = null; // Vocab rows don't use the simple topic field
                         } else {
                             topic = row.querySelector('.topic-input')?.value.trim() || '';
                         }

                    } else { // Handle saving checkbox clicks in normal mode
                         completed = row.querySelector('.completion-checkbox')?.checked || false;
                         // Get other data from existing state in Firestore (via currentDayData)
                         subject = existingRowData.subject;
                         topic = existingRowData.topic;
                         comment = existingRowData.comment;
                         completionPercentage = existingRowData.completionPercentage;
                         vocabData = existingRowData.vocabData;
                         story = existingRowData.story;
                     }

                     updatedRows.push({ subject, topic, comment, completed, completionPercentage, vocabData, story });
                });

                // Update the day's rows in the local copy
                 daysArray[dayIndex].rows = updatedRows;

                // Prepare update payload
                const updatePayload = {};
                updatePayload[`weeks.${weekId}.days`] = daysArray;

                // Update Firestore
                await updateDoc(docRef, updatePayload);
                console.log(`Day ${dayIndex + 1} for ${weekId} saved successfully.`);

            } catch (error) {
                console.error("Error saving day plan:", error);
                showCustomAlert("Error saving changes. Please check your connection and try again.");
            }
        }


         // Add Row (normal or vocab)
        function addRowToDay(monthId, weekId, daySection, type = 'normal') {
             const dayIndex = parseInt(daySection.dataset.dayIndex);
             const tableBody = daySection.querySelector('tbody');
             const newRowIndex = tableBody.rows.length; // Will be the index after adding

             let newRowData;
             if (type === 'vocabulary') {
                 newRowData = { subject: 'Vocabulary', topic: null, completed: false, comment: '', completionPercentage: null, vocabData: [{ word: '', meaning: '' }], story: null };
             } else {
                 newRowData = { subject: '', topic: '', completed: false, comment: '', completionPercentage: null, vocabData: null, story: null };
             }

             const newRowHtml = createTableRow(monthId, weekId, dayIndex, newRowIndex, newRowData, true); // Create in edit mode
             tableBody.insertAdjacentHTML('beforeend', newRowHtml);
         }

        // Add/Delete Vocab Pair Inputs
         function addVocabPairInputs(container) {
             const newPairIndex = container.querySelectorAll('.vocab-pair').length;
             const pairHtml = `
                 <div class="vocab-pair" data-pair-index="${newPairIndex}">
                     <input type="text" class="vocab-input vocab-word-input" placeholder="Word" value="">
                     <input type="text" class="vocab-input vocab-meaning-input" placeholder="Meaning" value="">
                     <button type="button" class="icon-button delete-vocab-pair-btn" title="Delete Pair"><i class="fas fa-times text-red-500"></i></button>
                 </div>`;
             // Insert before the add button
             container.querySelector('.add-vocab-pair-btn').insertAdjacentHTML('beforebegin', pairHtml);
         }

         function deleteVocabPairInputs(pairElement) {
             // Prevent deleting the last pair
             const container = pairElement.closest('.vocab-edit-container');
             if (container && container.querySelectorAll('.vocab-pair').length > 1) {
                pairElement.remove();
             } else {
                 showCustomAlert("Cannot delete the last word/meaning pair.");
             }
         }


        // --- Delete Operations ---
         function confirmDeleteRow(monthId, weekId, daySection, rowElement) {
             const rowIndex = parseInt(rowElement.dataset.rowIndex);
             showConfirmationModal(
                 "Delete Row",
                 "Are you sure you want to delete this row? This action cannot be undone.",
                 () => deleteRow(monthId, weekId, daySection, rowElement, rowIndex)
             );
         }

         async function deleteRow(monthId, weekId, daySection, rowElement, rowIndex) {
            if (!currentUser || !userId) return;
             const dayIndex = parseInt(daySection.dataset.dayIndex);
             console.log(`Attempting to delete row ${rowIndex} from day ${dayIndex}, week ${weekId}, month ${monthId}`);

             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             try {
                 const docSnap = await getDoc(docRef);
                 if (!docSnap.exists()) throw new Error("Month document not found.");

                 let monthData = docSnap.data();
                 let daysArray = monthData.weeks?.[weekId]?.days || [];
                 if (!daysArray[dayIndex] || !daysArray[dayIndex].rows) throw new Error("Day or rows not found in Firestore.");

                 // Remove the row from the array
                 daysArray[dayIndex].rows.splice(rowIndex, 1);

                 // Prepare update payload
                 const updatePayload = {};
                 updatePayload[`weeks.${weekId}.days`] = daysArray;

                 await updateDoc(docRef, updatePayload);
                 console.log("Row deleted successfully from Firestore.");
                 rowElement.remove(); // Remove from UI
                 // Re-index subsequent rows' data-row-index in the UI if needed, though saving rebuilds it
                 daySection.querySelectorAll('tbody tr').forEach((tr, newIdx) => tr.dataset.rowIndex = newIdx);


             } catch (error) {
                 console.error("Error deleting row:", error);
                 showCustomAlert("Error deleting row. Please try again.");
             }
         }

         function confirmDeleteDay(monthId, weekId, daySection) {
             const dayIndex = parseInt(daySection.dataset.dayIndex);
             const dayNum = daySection.querySelector('h4').textContent; // Get "Day X"
             showConfirmationModal(
                 `Delete ${dayNum}`,
                 `Are you sure you want to delete all entries for ${dayNum}? This action cannot be undone.`,
                 () => deleteDay(monthId, weekId, daySection, dayIndex)
             );
         }

         async function deleteDay(monthId, weekId, daySection, dayIndex) {
            if (!currentUser || !userId) return;
            console.log(`Attempting to delete day index ${dayIndex} from week ${weekId}, month ${monthId}`);

            const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             try {
                 const docSnap = await getDoc(docRef);
                 if (!docSnap.exists()) throw new Error("Month document not found.");

                 let monthData = docSnap.data();
                 let daysArray = monthData.weeks?.[weekId]?.days || [];
                 if (!daysArray[dayIndex]) throw new Error("Day not found in Firestore.");

                 // Remove the day from the array
                 daysArray.splice(dayIndex, 1);

                 // Renumber subsequent days
                 for (let i = dayIndex; i < daysArray.length; i++) {
                     daysArray[i].dayNumber = i + 1;
                 }

                 // Prepare update payload
                 const updatePayload = {};
                 updatePayload[`weeks.${weekId}.days`] = daysArray;

                 await updateDoc(docRef, updatePayload);
                 console.log("Day deleted successfully from Firestore.");

                 // Remove day section from UI and update subsequent day numbers/indices in UI
                const daysContainer = daySection.parentNode;
                 daySection.remove();
                 daysContainer.querySelectorAll('.day-section').forEach((ds, newIdx) => {
                     ds.dataset.dayIndex = newIdx;
                     ds.querySelector('h4').textContent = `Day ${newIdx + 1}`;
                      // Update table IDs etc. if necessary for future edits
                      ds.querySelector('table').id = `table-${monthId}-${weekId}-${newIdx}`;
                 });
                  updateWeeklyProgressUI(monthId, weekId); // Recalculate progress

             } catch (error) {
                 console.error("Error deleting day:", error);
                 showCustomAlert("Error deleting day. Please try again.");
             }
         }

         function confirmDeleteMonth(monthId) {
             // Get month name for confirmation message
             const monthButton = monthNavButtonsContainer.querySelector(`button[data-month-id="${monthId}"]`);
             const monthName = monthButton ? monthButton.textContent : monthId;
             showConfirmationModal(
                 `Delete Month: ${monthName}`,
                 `Are you sure you want to delete the entire study plan for ${monthName}? This action cannot be undone.`,
                 () => deleteMonth(monthId)
             );
         }

         async function deleteMonth(monthId) {
             if (!currentUser || !userId) return;
             console.log("Attempting to delete month:", monthId);
             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             try {
                 await deleteDoc(docRef);
                 console.log("Month deleted successfully.");
                 // UI update happens via onSnapshot listener triggering loadStudyPlans
                 currentMonthPlanDisplay.innerHTML = ''; // Clear display
                 selectMonthMessage.classList.remove('hidden'); // Show select message again
             } catch (error) {
                 console.error("Error deleting month:", error);
                 showCustomAlert("Error deleting month. Please try again.");
             }
         }

         // Show Confirmation Modal
         function showConfirmationModal(title, message, onConfirm) {
             confirmModalTitle.textContent = title;
             confirmModalMessage.textContent = message;
             currentConfirmAction = onConfirm; // Store the action

             confirmModalConfirmBtn.onclick = () => {
                 if (currentConfirmAction) {
                     currentConfirmAction();
                 }
                 closeModal('confirm-modal');
             };
             confirmModalCancelBtn.onclick = () => {
                 closeModal('confirm-modal');
             };

             confirmModal.style.display = 'block';
         }

        // Add New Day (with 7-day limit)
        async function addNewDay(monthId, weekId, weekSection) {
            if (!currentUser || !userId) return;

             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             try {
                 const docSnap = await getDoc(docRef);
                 if (!docSnap.exists()) throw new Error("Month document not found.");

                 const monthData = docSnap.data();
                 let daysArray = monthData.weeks?.[weekId]?.days || [];

                 // Check day limit
                 if (daysArray.length >= 7) {
                     showCustomAlert("You cannot add more than 7 days to a week.");
                     return;
                 }
                console.log(`Adding new day to ${monthId}, ${weekId} (Current count: ${daysArray.length})`);


                 const lastDayIndex = daysArray.length - 1;
                 let newDayData;
                 // ... (rest of the copy logic remains the same) ...
                  if (lastDayIndex >= 0) {
                     const lastDayRows = daysArray[lastDayIndex].rows || [];
                     newDayData = {
                         dayNumber: daysArray.length + 1, date: '',
                         rows: lastDayRows.map(row => ({
                             subject: row.subject || '', topic: row.topic || '', completed: false, comment: '', completionPercentage: null,
                             vocabData: row.vocabData ? JSON.parse(JSON.stringify(row.vocabData)) : null, story: null
                         }))
                     };
                 } else {
                     newDayData = { dayNumber: 1, date: '', rows: [{ subject: '', topic: '', completed: false, comment: '', completionPercentage: null, vocabData: null, story: null }] };
                 }


                 const updatePayload = {};
                 updatePayload[`weeks.${weekId}.days`] = arrayUnion(newDayData);
                 await updateDoc(docRef, updatePayload);
                 console.log("New day added successfully.");

             } catch (error) {
                 console.error("Error adding new day:", error);
                 showCustomAlert("Error adding new day.");
             }
        }


        // Save Story (Modified to target specific row)
         saveStoryBtn.addEventListener('click', async () => {
             if (!currentUser || !userId || !currentStoryTarget) return;
             const { monthId, weekId, dayIndex, rowIndex } = currentStoryTarget; // Use the stored target row
             const newStory = document.getElementById('story-textarea').value.trim();
             const docRef = doc(db, getUserPlansCollectionPath(), monthId);

             try {
                 const docSnap = await getDoc(docRef);
                 if (!docSnap.exists()) throw new Error("Month document not found.");
                 let monthData = docSnap.data();
                 let daysArray = monthData.weeks?.[weekId]?.days || [];

                 if (daysArray[dayIndex]?.rows?.[rowIndex]) {
                     daysArray[dayIndex].rows[rowIndex].story = newStory || null; // Update specific row's story
                     const updatePayload = { [`weeks.${weekId}.days`]: daysArray };
                     await updateDoc(docRef, updatePayload);
                     console.log("Story saved successfully for row:", rowIndex);
                     closeModal('edit-story-modal');

                     // --- Immediate UI Update ---
                     const daySection = document.querySelector(`.day-section[data-day-index="${dayIndex}"]`);
                     if (daySection && !daySection.classList.contains('editing')) {
                         const rowElement = daySection.querySelector(`tr[data-row-index="${rowIndex}"]`);
                         if(rowElement){
                              const updatedDocSnap = await getDoc(docRef); // Re-fetch
                              if(updatedDocSnap.exists()){
                                   const updatedRowData = updatedDocSnap.data().weeks?.[weekId]?.days?.[dayIndex]?.rows?.[rowIndex];
                                   if(updatedRowData) {
                                        rowElement.outerHTML = createTableRow(monthId, weekId, dayIndex, rowIndex, updatedRowData, false);
                                   }
                              }
                         }
                     }
                     // --- End UI Update ---

                 } else { throw new Error("Target row for story not found."); }
             } catch (error) { console.error("Error saving story:", error); showCustomAlert("Error saving story."); }
             finally { currentStoryTarget = null; }
         });


        // --- Other functions (calculateWeeklyProgress, updateWeeklyProgressUI, showVocabMeaning, readStory, parseVocabString, escapeHtml, closeModal, showCustomAlert) remain largely the same ---
         // --- Progress Calculation ---
        function calculateWeeklyProgress(weekData) { /* ... same as before ... */
            if (!weekData || !weekData.days || weekData.days.length === 0) return 0;
            let totalPercentage = 0;
            weekData.days.forEach(day => {
                day.rows?.forEach(row => {
                    if (row.completed && typeof row.completionPercentage === 'number' && row.completionPercentage > 0) {
                        totalPercentage += row.completionPercentage;
                    }
                });
            });
             return Math.min(Math.round(totalPercentage), 100);
        }

         // Update the progress bar UI
        async function updateWeeklyProgressUI(monthId, weekId) { /* ... same as before but fetch data ... */
             if (!currentUser || !userId) return;
             const weekSection = document.querySelector(`[data-month-id="${monthId}"] .week-section[data-week-id="${weekId}"]`);
             if (!weekSection) return;
             const progressBarFill = weekSection.querySelector('.progress-bar-fill');
             const progressPercentageSpan = weekSection.querySelector('.progress-percentage');
             try {
                const docRef = doc(db, getUserPlansCollectionPath(), monthId);
                const docSnap = await getDoc(docRef);
                 if (docSnap.exists()) {
                     const weekData = docSnap.data().weeks?.[weekId];
                     const progress = calculateWeeklyProgress(weekData);
                    progressBarFill.style.width = `${progress}%`;
                    progressPercentageSpan.textContent = `${progress}%`;
                 }
             } catch (error) { console.error("Error fetching data for progress UI:", error); }
        }

        // --- Modals ---
        function showVocabMeaning(wordSpan) { /* ... same as before ... */
             document.getElementById('vocab-modal-word').textContent = wordSpan.textContent;
             document.getElementById('vocab-modal-meaning').textContent = wordSpan.dataset.meaning || 'No meaning provided.';
             vocabModal.style.display = "block";
        }
         async function readStory(monthId, weekId, dayIndex, rowIndex) { /* ... same as before ... */
             if (!currentUser || !userId) return;
              try {
                  const docRef = doc(db, getUserPlansCollectionPath(), monthId);
                  const docSnap = await getDoc(docRef);
                  if (docSnap.exists()) {
                      const story = docSnap.data().weeks?.[weekId]?.days?.[dayIndex]?.rows?.[rowIndex]?.story;
                      if (story) { document.getElementById('story-modal-content').textContent = story; storyModal.style.display = "block"; }
                      else { showCustomAlert("No story found for this entry."); }
                  }
              } catch (error) { console.error("Error reading story:", error); showCustomAlert("Could not load story."); }
         }
         window.closeModal = function(modalId) { document.getElementById(modalId).style.display = "none"; }
         window.onclick = function(event) { if (event.target.classList.contains('modal')) { event.target.style.display = "none"; } }

        // --- Alert ---
         function showCustomAlert(message, type = "error") { /* ... same as before ... */
             console.log(`ALERT (${type}): ${message}`);
             const alertBox = document.createElement('div');
             alertBox.style.cssText = `position:fixed; top:20px; left:50%; transform:translateX(-50%); padding:10px 20px; border-radius:5px; z-index:200; box-shadow:0 2px 10px rgba(0,0,0,0.2); font-size: 0.875rem; font-weight: 500;`;
             if (type === 'success') { alertBox.style.backgroundColor = '#10b981'; alertBox.style.color = 'white'; }
             else { alertBox.style.backgroundColor = '#f87171'; alertBox.style.color = 'white'; }
             alertBox.textContent = message; document.body.appendChild(alertBox);
             setTimeout(() => { alertBox.remove(); }, 3000);
         }

    </script>

     <!-- Your existing script.js link -->
     <script src="script.js" defer></script>

</body>
</html>

