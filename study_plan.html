<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-JWZXVQC68L"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-JWZXVQC68L');
	</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Caddy - My Study Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Noto+Naskh+Arabic:wght@400;700&family=Kalpurush:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Link to your existing style.css for consistency -->
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="https://eco.du.ac.bd//assets/images/fab_icon.ico" type="image/x-icon">
    <style>
        /* Add specific styles for Study Plan page here if needed, keeping consistency */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #111827; /* Dark background */
            color: white;
        }
        .kalpurush {
            font-family: 'Kalpurush', sans-serif;
        }
        .arabic-font {
             font-family: 'Noto Naskh Arabic', serif;
        }
        /* Style for editable cells */
        [contenteditable="true"] {
            outline: 2px solid #10b981; /* Emerald border */
            background-color: #1f2937; /* Slightly lighter gray */
            padding: 4px;
            border-radius: 4px;
        }
        /* Style for vocabulary words */
        .vocab-word {
            cursor: pointer;
            text-decoration: underline dotted;
            margin-right: 8px;
            display: inline-block;
            padding: 2px 5px;
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .vocab-word:hover {
            background-color: rgba(16, 185, 129, 0.2);
        }
        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #1f2937; /* gray-800 */
            margin: 15% auto;
            padding: 25px;
            border: 1px solid #4b5563; /* gray-600 */
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            position: relative;
        }
        .modal-close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
        /* Progress Bar */
        .progress-bar-container {
            background-color: #374151; /* gray-700 */
            border-radius: 9999px;
            overflow: hidden;
            height: 12px;
        }
        .progress-bar-fill {
            background-color: #10b981; /* emerald-500 */
            height: 100%;
            transition: width 0.3s ease-in-out;
            text-align: center;
            line-height: 12px;
            font-size: 10px;
            color: #111827;
            font-weight: bold;
            border-radius: 9999px;
        }
        /* Add Row Button Style */
        .add-row-btn {
            background: none;
            border: none;
            color: #6ee7b7; /* emerald-300 */
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .add-row-btn:hover {
            color: #10b981; /* emerald-500 */
        }
        /* General Button Style Consistency */
        .action-button {
            background-color: #10b981; /* emerald-500 */
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            font-size: 0.875rem; /* text-sm */
        }
        .action-button:hover {
            background-color: #059669; /* emerald-600 */
        }
        .action-button-secondary {
             background-color: #374151; /* gray-700 */
             color: #d1d5db; /* gray-300 */
        }
        .action-button-secondary:hover {
             background-color: #4b5563; /* gray-600 */
        }
         /* Styling for table cells in editing mode */
        .study-table tbody tr.editing-mode td {
            padding-top: 10px;
            padding-bottom: 10px;
        }
        .study-table tbody tr.editing-mode td > * { /* Target direct children like inputs/buttons within the TD */
            margin-top: 4px;
            margin-bottom: 4px;
        }
        .editable-input {
            background-color: #374151; /* gray-700 */
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 4px;
            padding: 4px 8px;
            color: white;
            width: 100%;
            font-size: 0.875rem;
        }
         /* Add Day Button Styling */
        .add-day-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(16, 185, 129, 0.1); /* emerald-500 with alpha */
            color: #6ee7b7; /* emerald-300 */
            border: 1px dashed #34d399; /* emerald-400 */
            border-radius: 8px;
            padding: 12px;
            margin-top: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        .add-day-btn:hover {
            background-color: rgba(16, 185, 129, 0.2);
            color: #a7f3d0; /* emerald-200 */
            border-color: #6ee7b7; /* emerald-300 */
        }
        .add-day-btn i {
            margin-right: 8px;
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <!-- Header (Assuming you have a standard header included via server-side or copy-pasted) -->
    <!-- You Copy/Paste your existing header structure here -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-gray-900/80 backdrop-blur-sm border-b border-gray-700 main-website-ui">
        <div class="container mx-auto px-6 py-3">
            <nav class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <a href="https://facebook.com/emammehedi17" target="_blank" rel="noopener noreferrer">
                        <img src="images/profile.jpg" alt="Profile" class="h-12 w-12 rounded-full border-2 border-emerald-400 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/48x48/111827/a7f3d0?text=CC';">
                    </a>
                    <a href="index.html">
                        <h1 class="text-2xl font-bold">Class Caddy</h1>
                    </a>
                </div>
                <div class="hidden md:flex items-center gap-2 bg-gray-800/50 backdrop-blur-sm border border-gray-700 rounded-full p-1">
                    <a href="index.html" class="px-6 py-2 text-sm text-gray-400 hover:text-white transition-colors">Home</a>
                    <div id="academic-dropdown" class="relative">
                        <button id="academic-button" class="px-6 py-2 text-sm font-semibold text-gray-400 hover:text-white rounded-full transition-colors flex items-center">
                            <a href="academic.html">Academic</a>
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="academic-menu" class="dropdown-menu absolute top-full left-1/2 -translate-x-1/2 mt-2 w-48 bg-gray-800 border border-gray-700 rounded-lg shadow-lg hidden">
                            <a href="course-405.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Course 405</a>
                            <a href="course-406.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Course 406</a>
                            <a href="course-407.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Course 407</a>
                            <a href="course-408.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white">Course 408 (B)</a>
                        </div>
                    </div>
                     <a href="study_plan.html" class="px-6 py-2 text-sm bg-emerald-500 rounded-full text-white transition-colors">Study Plan</a> <!-- Active Link Example -->
                    <a href="shop.html" class="px-6 py-2 text-sm text-gray-400 hover:text-white transition-colors">Shop</a>
                    <a href="about.html" class="px-6 py-2 text-sm text-gray-400 hover:text-white transition-colors">About</a>
                    <a href="contact.html" class="px-6 py-2 text-sm text-gray-400 hover:text-white transition-colors">Contact</a>
                </div>
                <div class="hidden md:flex items-center gap-4">
                    <a href="https://du.ac.bd/" target="_blank" rel="noopener noreferrer">
                        <img src="images/du_logo.png" alt="DU Logo" class="h-12 w-12 rounded-full border-2 border-gray-600 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/48x48/eeeeee/111827?text=DU';">
                    </a>
                    <!-- User info/logout button will replace Sign Up when logged in -->
                     <div id="auth-container-desktop" class="auth-container">
                        <!-- Sign Up button initially -->
                         <a href="index.html#signup" class="px-6 py-3 text-sm font-semibold bg-emerald-500 hover:bg-emerald-600 rounded-full transition-colors signup-button">Sign Up</a>
                        <!-- Logged in state will be populated by JS -->
                    </div>
                </div>
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button" class="text-white focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </nav>
             <div id="mobile-menu" class="hidden md:hidden bg-gray-800 border-t border-gray-700 -mx-6">
                <a href="index.html" class="block px-6 py-3 text-sm text-gray-300 hover:bg-gray-700 transition-colors">Home</a>
                <div>
                    <button id="mobile-academic-button" class="w-full text-left px-6 py-3 text-sm text-gray-300 hover:bg-gray-700 transition-colors flex justify-between items-center">
                        <span>Academic</span>
                        <svg class="w-4 h-4 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="mobile-academic-menu" class="hidden pl-8 bg-gray-900">
                        <a href="course-405.html" class="block px-4 py-2 text-sm text-gray-400 hover:bg-gray-700 transition-colors">Course 405</a>
                        <a href="course-406.html" class="block px-4 py-2 text-sm text-gray-400 hover:bg-gray-700 transition-colors">Course 406</a>
                        <a href="course-407.html" class="block px-4 py-2 text-sm text-gray-400 hover:bg-gray-700 transition-colors">Course 407</a>
                        <a href="course-408.html" class="block px-4 py-2 text-sm text-gray-400 hover:bg-gray-700 transition-colors">Course 408 (B)</a>
                    </div>
                </div>
                 <a href="study_plan.html" class="block px-6 py-3 text-sm text-emerald-400 bg-gray-700 transition-colors">Study Plan</a> <!-- Active Link Example -->
                <a href="shop.html" class="block px-6 py-3 text-sm text-gray-300 hover:bg-gray-700 transition-colors">Shop</a>
                <a href="about.html" class="block px-6 py-3 text-sm text-gray-300 hover:bg-gray-700 transition-colors">About</a>
                <a href="contact.html" class="block px-6 py-3 text-sm text-gray-300 hover:bg-gray-700 transition-colors">Contact</a>
                <!-- Mobile Auth -->
                <div id="auth-container-mobile" class="auth-container px-6 py-3">
                    <a href="index.html#signup" class="block w-full text-center text-sm font-semibold bg-emerald-500 hover:bg-emerald-600 rounded-full py-2 transition-colors signup-button">Sign Up</a>
                </div>
            </div>
        </div>
    </header>
    <!-- End Header -->

    <!-- Main Content Area -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-16">

        <h1 class="text-3xl sm:text-4xl font-bold text-emerald-400 mb-6 text-center">My Study Plan</h1>

        <!-- Auth Status / Login Section -->
        <div id="auth-section" class="mb-8 p-4 bg-gray-800/50 backdrop-blur-sm border border-gray-700 rounded-lg shadow-md">
            <!-- Content dynamically updated by JS based on auth state -->
             <div id="login-prompt" class="text-center">
                <p class="text-gray-400 mb-4">Please log in to view and manage your study plans.</p>
                <button id="google-login-btn" class="action-button bg-red-600 hover:bg-red-700">
                    <i class="fab fa-google mr-2"></i> Sign in with Google
                </button>
                <!-- Add other login methods if desired -->
            </div>
             <div id="user-info" class="hidden flex flex-col sm:flex-row justify-between items-center text-sm">
                 <div class="flex items-center gap-3 mb-2 sm:mb-0">
                     <i class="fas fa-check-circle text-emerald-400"></i>
                     <span class="font-semibold text-gray-300">Sync Status:</span>
                     <span class="text-emerald-400">Synced</span>
                     <span id="user-id-display" class="ml-4 text-xs text-gray-500 break-all"></span> <!-- Added User ID display -->
                 </div>
                <div class="text-center sm:text-right">
                    <p id="user-display" class="font-medium text-gray-200"></p>
                    <p id="user-email-display" class="text-gray-400 text-xs"></p>
                    <button id="logout-btn" class="mt-1 text-red-400 hover:text-red-300 text-xs font-semibold">Log Out</button>
                </div>
            </div>
        </div>

        <!-- Study Plan Content (Hidden until logged in) -->
        <div id="study-plan-content" class="hidden">

            <div class="flex justify-center mb-8">
                 <button id="add-month-btn" class="action-button flex items-center gap-2">
                     <i class="fas fa-plus-circle"></i> Add Month
                 </button>
            </div>

            <!-- Container for Monthly Plans -->
            <div id="monthly-plans-container" class="space-y-12">
                <!-- Monthly plans will be loaded here by JavaScript -->
                 <p id="no-plans-message" class="text-center text-gray-500 italic">No study plans found. Click "Add Month" to create one.</p>
            </div>

        </div> <!-- End Study Plan Content -->

    </main>

    <!-- Modal for Vocabulary Meaning -->
    <div id="vocab-modal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal('vocab-modal')">&times;</span>
        <h3 id="vocab-modal-word" class="text-xl font-semibold mb-3 text-emerald-400">Word</h3>
        <p id="vocab-modal-meaning" class="text-gray-300"></p>
      </div>
    </div>

    <!-- Modal for Story -->
    <div id="story-modal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal('story-modal')">&times;</span>
        <h3 class="text-xl font-semibold mb-3 text-emerald-400">Story</h3>
        <p id="story-modal-content" class="text-gray-300 whitespace-pre-wrap"></p>
      </div>
    </div>

     <!-- Modal for Adding/Editing Story -->
    <div id="edit-story-modal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal('edit-story-modal')">&times;</span>
        <h3 class="text-xl font-semibold mb-3 text-emerald-400">Add/Edit Story</h3>
        <textarea id="story-textarea" rows="6" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md text-gray-100 placeholder-gray-400 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Write a story using the vocabulary words..."></textarea>
        <div class="mt-4 flex justify-end gap-3">
             <button onclick="closeModal('edit-story-modal')" class="action-button action-button-secondary">Cancel</button>
             <button id="save-story-btn" class="action-button">Save Story</button>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import necessary functions from Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            setDoc,
            doc,
            getDoc,
            collection,
            query,
            getDocs,
            onSnapshot,
            addDoc,
            updateDoc,
            deleteDoc,
            arrayUnion,
            arrayRemove,
             writeBatch,
             Timestamp,
             where,
             orderBy, // Note: orderBy might require composite indexes in Firestore
             setLogLevel // Import setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        setLogLevel('debug'); // Keep debug logging enabled for now

        let firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use provided app ID or a default

        console.log("Checking for __firebase_config..."); // Log check
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                console.log("Firebase config loaded from environment variable:", firebaseConfig);
            } catch (e) {
                console.error("Error parsing __firebase_config JSON:", e);
                // Fallback if JSON parsing fails
                firebaseConfig = { /* Your Fallback Config - MAKE SURE this is correctly filled if needed */
                     apiKey: "YOUR_FALLBACK_API_KEY", // Replace if needed, but ideally env var should work
                     authDomain: "YOUR_FALLBACK_AUTH_DOMAIN",
                     projectId: "YOUR_FALLBACK_PROJECT_ID",
                     // ... other fallback keys ...
                     appId: "YOUR_FALLBACK_APP_ID"
                 };
                console.warn("Using fallback Firebase config due to parsing error.");
            }
        } else {
            console.error("__firebase_config is not defined or empty. Authentication will likely fail.");
            // Define fallback config if the environment variable is completely missing
            firebaseConfig = { /* Your Fallback Config - MAKE SURE this is correctly filled if needed */
                 apiKey: "YOUR_FALLBACK_API_KEY", // Replace if needed, but ideally env var should work
                 authDomain: "YOUR_FALLBACK_AUTH_DOMAIN",
                 projectId: "YOUR_FALLBACK_PROJECT_ID",
                 // ... other fallback keys ...
                 appId: "YOUR_FALLBACK_APP_ID"
             };
            console.warn("Using fallback Firebase config because environment variable was missing.");
        }


        // Initialize Firebase
        let app;
        let auth;
        let db;
        let googleProvider;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            googleProvider = new GoogleAuthProvider();
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("CRITICAL ERROR initializing Firebase:", error);
            console.error("Firebase Config Used:", firebaseConfig);
            // Display an error message to the user on the page itself
             const authSection = document.getElementById('auth-section');
             if(authSection) authSection.innerHTML = `<p class="text-red-500 font-bold text-center">Error: Could not initialize Firebase. Please check the console.</p>`;
             // Stop further execution if Firebase fails to init
             throw new Error("Firebase initialization failed.");
        }
        // --- End Firebase Configuration ---
        // Use environment variables provided by the platform
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Provide default fallback config if needed, but ideally rely on __firebase_config
            apiKey: "YOUR_FALLBACK_API_KEY",
            authDomain: "YOUR_FALLBACK_AUTH_DOMAIN",
            projectId: "YOUR_FALLBACK_PROJECT_ID",
            storageBucket: "YOUR_FALLBACK_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FALLBACK_MESSAGING_SENDER_ID",
            appId: "YOUR_FALLBACK_APP_ID"
         };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use provided app ID or a default

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const loginPrompt = document.getElementById('login-prompt');
        const userInfo = document.getElementById('user-info');
        const userDisplay = document.getElementById('user-display');
        const userEmailDisplay = document.getElementById('user-email-display');
        const userIdDisplay = document.getElementById('user-id-display'); // Get the User ID display element
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const studyPlanContent = document.getElementById('study-plan-content');
        const addMonthBtn = document.getElementById('add-month-btn');
        const monthlyPlansContainer = document.getElementById('monthly-plans-container');
        const noPlansMessage = document.getElementById('no-plans-message');

        // Desktop/Mobile Auth Containers
        const authContainerDesktop = document.getElementById('auth-container-desktop');
        const authContainerMobile = document.getElementById('auth-container-mobile');
        const signupButtons = document.querySelectorAll('.signup-button');


        // Modals
        const vocabModal = document.getElementById('vocab-modal');
        const storyModal = document.getElementById('story-modal');
        const editStoryModal = document.getElementById('edit-story-modal');
        const saveStoryBtn = document.getElementById('save-story-btn');
        let currentStoryTarget = null; // To store monthId, weekId, dayIndex, rowIndex for saving story

        let currentUser = null;
        let userId = null;
        let unsubscribePlans = null; // To hold the listener


        // --- Authentication Logic ---

         // Function to update UI based on auth state
        function updateAuthUI(user) {
            const loggedInContentDesktop = `
                <div class="text-sm">
                    <p class="font-semibold text-gray-200">${user.displayName || 'User'}</p>
                    <p class="text-gray-400 text-xs">${user.email || ''}</p>
                </div>
                <button id="logout-btn-desktop" class="ml-3 px-4 py-2 text-xs font-semibold bg-red-600 hover:bg-red-700 rounded-full transition-colors">Log Out</button>
            `;
            const loggedInContentMobile = `
                <div class="text-sm mb-2">
                    <p class="font-semibold text-gray-200">${user.displayName || 'User'}</p>
                    <p class="text-gray-400 text-xs">${user.email || ''}</p>
                </div>
                <button id="logout-btn-mobile" class="w-full text-center text-sm font-semibold bg-red-600 hover:bg-red-700 rounded-full py-2 transition-colors">Log Out</button>
            `;
            const loggedOutContentDesktop = `<a href="index.html#signup" class="px-6 py-3 text-sm font-semibold bg-emerald-500 hover:bg-emerald-600 rounded-full transition-colors signup-button">Sign Up</a>`;
            const loggedOutContentMobile = `<a href="index.html#signup" class="block w-full text-center text-sm font-semibold bg-emerald-500 hover:bg-emerald-600 rounded-full py-2 transition-colors signup-button">Sign Up</a>`;


             if (user) {
                currentUser = user;
                userId = user.uid; // Use the authenticated user's UID
                console.log("User logged in:", userId);

                // Update Auth Section
                loginPrompt.style.display = 'none';
                userInfo.classList.remove('hidden');
                userDisplay.textContent = user.displayName || 'Anonymous User';
                userEmailDisplay.textContent = user.email || '';
                userIdDisplay.textContent = `ID: ${userId}`; // Display User ID

                // Update Header Auth Containers
                authContainerDesktop.innerHTML = loggedInContentDesktop;
                authContainerMobile.innerHTML = loggedInContentMobile;

                // Attach logout listeners to the newly created buttons
                document.getElementById('logout-btn-desktop')?.addEventListener('click', handleLogout);
                document.getElementById('logout-btn-mobile')?.addEventListener('click', handleLogout);
                logoutBtn.classList.remove('hidden'); // Show logout in the main section too


                // Show study plan content and load data
                studyPlanContent.classList.remove('hidden');
                loadStudyPlans();

            } else {
                currentUser = null;
                userId = crypto.randomUUID(); // Generate a random ID for anonymous users
                console.log("User logged out or anonymous:", userId);

                // Update Auth Section
                loginPrompt.style.display = 'block';
                userInfo.classList.add('hidden');
                logoutBtn.classList.add('hidden'); // Hide logout in main section

                 // Update Header Auth Containers
                authContainerDesktop.innerHTML = loggedOutContentDesktop;
                authContainerMobile.innerHTML = loggedOutContentMobile;


                // Hide study plan content and clear display
                studyPlanContent.classList.add('hidden');
                monthlyPlansContainer.innerHTML = ''; // Clear previous plans
                noPlansMessage.style.display = 'block';
                if (unsubscribePlans) {
                    unsubscribePlans(); // Detach listener
                    unsubscribePlans = null;
                }
            }

             // Re-attach listeners for dynamically added signup buttons if needed
             document.querySelectorAll('.signup-button').forEach(button => {
                 // Add smooth scroll logic if needed again, assuming script.js handles it
             });
        }


        onAuthStateChanged(auth, async (user) => {
            console.log("Auth state changed. User:", user);
             if (user) {
                updateAuthUI(user);
            } else {
                // Try signing in with the custom token if available
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        console.log("Attempting sign in with custom token...");
                        await signInWithCustomToken(auth, __initial_auth_token);
                        // onAuthStateChanged will trigger again with the authenticated user
                        console.log("Sign in with custom token successful.");
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        // If custom token fails, sign in anonymously
                        try {
                            console.log("Attempting anonymous sign in as fallback...");
                            await signInAnonymously(auth);
                            console.log("Anonymous sign in successful.");
                            // onAuthStateChanged will trigger again with the anonymous user
                        } catch (anonError) {
                            console.error("Error signing in anonymously:", anonError);
                            updateAuthUI(null); // Show logged-out state if all fails
                        }
                    }
                } else {
                    // If no custom token, sign in anonymously directly
                     try {
                        console.log("No custom token found, attempting anonymous sign in...");
                        await signInAnonymously(auth);
                         console.log("Anonymous sign in successful.");
                        // onAuthStateChanged will trigger again with the anonymous user
                    } catch (anonError) {
                        console.error("Error signing in anonymously:", anonError);
                        updateAuthUI(null); // Show logged-out state if anonymous sign-in fails
                    }
                }
            }
        });


        // Google Login Handler
        googleLoginBtn.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, googleProvider);
                // onAuthStateChanged will handle the UI update
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                // Handle specific errors like popup blocked
            }
        });

        // Logout Handler
        async function handleLogout() {
             console.log("Logging out...");
            try {
                await signOut(auth);
                 console.log("Logout successful.");
                // onAuthStateChanged will handle the UI update to the logged-out state
            } catch (error) {
                console.error("Logout Error:", error);
            }
        }
         // Initial setup for the main logout button in the auth section
         logoutBtn.addEventListener('click', handleLogout);


        // --- Firestore Logic ---

        // Function to get the path for user's private data
        function getUserPlansCollectionPath() {
             if (!userId) throw new Error("User ID is not available.");
             // Storing study plans as private data by default
             return `artifacts/${appId}/users/${userId}/studyPlans`;
        }


        // Load existing study plans
        async function loadStudyPlans() {
            if (!currentUser || !userId) return;
            console.log("Loading study plans for user:", userId);

             const plansCollectionPath = getUserPlansCollectionPath();
             const q = query(collection(db, plansCollectionPath)); // Consider adding orderBy('createdAt', 'desc') later if needed

            // Detach previous listener if exists
            if (unsubscribePlans) {
                unsubscribePlans();
            }

            unsubscribePlans = onSnapshot(q, (querySnapshot) => {
                 console.log("Received plans snapshot. Number of plans:", querySnapshot.size);
                monthlyPlansContainer.innerHTML = ''; // Clear existing plans first
                if (querySnapshot.empty) {
                    noPlansMessage.style.display = 'block';
                } else {
                    noPlansMessage.style.display = 'none';
                     const plans = [];
                     querySnapshot.forEach((doc) => {
                         plans.push({ id: doc.id, ...doc.data() });
                     });

                     // Sort plans client-side (e.g., by monthId YYYY-MM descending)
                     plans.sort((a, b) => b.id.localeCompare(a.id));

                     plans.forEach(planData => {
                        monthlyPlansContainer.appendChild(createMonthElement(planData.id, planData));
                    });
                }
            }, (error) => {
                 console.error("Error fetching study plans:", error);
                 monthlyPlansContainer.innerHTML = '<p class="text-red-400 text-center">Error loading plans. Please try again later.</p>';
                 noPlansMessage.style.display = 'none';
            });
        }

       // Add a new month
        addMonthBtn.addEventListener('click', async () => {
            if (!currentUser || !userId) return;

            const currentYear = new Date().getFullYear();
            const currentMonthIndex = new Date().getMonth(); // 0-11
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            // Suggest the next month by default
            const nextMonthIndex = (currentMonthIndex + 1) % 12;
            const nextMonthYear = currentMonthIndex === 11 ? currentYear + 1 : currentYear;
            const suggestedMonthName = `${monthNames[nextMonthIndex]} ${nextMonthYear}`;

            const monthName = prompt("Enter month name (e.g., 'October 2025'):", suggestedMonthName);
            if (!monthName || monthName.trim() === '') return;

             // Generate a Firestore-friendly ID (e.g., YYYY-MM)
             // Try to parse the input or use the suggested one
             let monthId = '';
             try {
                // Basic parsing attempt - adjust if needed for more robust parsing
                const parts = monthName.split(' ');
                const year = parseInt(parts[1]);
                const monthIndex = monthNames.findIndex(m => m.toLowerCase() === parts[0].toLowerCase());
                if (year && monthIndex !== -1) {
                    monthId = `${year}-${(monthIndex + 1).toString().padStart(2, '0')}`;
                } else {
                     throw new Error("Invalid format");
                }
             } catch (e) {
                 // Fallback if parsing fails - use next month's ID
                 monthId = `${nextMonthYear}-${(nextMonthIndex + 1).toString().padStart(2, '0')}`;
                 console.warn("Could not parse month name, using generated ID:", monthId);
             }


             // Check if month already exists (optional but good practice)
             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             const docSnap = await getDoc(docRef);
             if (docSnap.exists()) {
                // Using a simple browser confirm replacement
                showCustomAlert(`Study plan for month ID ${monthId} already exists.`);
                 return;
             }


            const newPlanData = {
                monthName: monthName.trim(),
                createdAt: Timestamp.now(), // Add a timestamp
                weeklyTargets: { week1: '', week2: '', week3: '', week4: '' },
                weeks: {
                    // Initialize Week 1 with one default day and one default row
                     week1: {
                         days: [
                             {
                                 dayNumber: 1,
                                 date: '', // User can set this
                                 rows: [
                                     { subject: '', topic: '', completed: false, comment: '', completionPercentage: null, vocabData: null, story: null }
                                 ]
                             }
                         ]
                     },
                     week2: { days: [] },
                     week3: { days: [] },
                     week4: { days: [] }
                }
            };

            try {
                await setDoc(docRef, newPlanData);
                console.log("New month added with ID:", monthId);
                // UI update will happen via onSnapshot listener
            } catch (error) {
                console.error("Error adding new month:", error);
                 showCustomAlert("Error adding month. Please try again.");
            }
        });

        // --- UI Creation Functions ---

        // Create HTML for a whole month section
        function createMonthElement(monthId, data) {
            const monthDiv = document.createElement('div');
            monthDiv.classList.add('mb-12', 'p-6', 'bg-gray-800', 'rounded-lg', 'shadow-lg');
            monthDiv.dataset.monthId = monthId;

            monthDiv.innerHTML = `
                <h2 class="text-2xl font-bold text-emerald-300 mb-4">${data.monthName || 'Unnamed Month'} (${monthId})</h2>

                <!-- Monthly Targets -->
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-300 mb-3">Monthly Targets</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 monthly-targets">
                        ${[1, 2, 3, 4].map(weekNum => `
                            <div class="bg-gray-700 p-4 rounded-md shadow">
                                <label for="target-week-${monthId}-${weekNum}" class="block text-sm font-medium text-emerald-400 mb-1">Week ${weekNum}</label>
                                <textarea id="target-week-${monthId}-${weekNum}" data-week="week${weekNum}" rows="3" class="editable-input w-full text-sm placeholder-gray-400" placeholder="Enter target...">${data.weeklyTargets?.[`week${weekNum}`] || ''}</textarea>
                            </div>
                        `).join('')}
                    </div>
                     <div class="text-right mt-3">
                        <button class="action-button action-button-secondary text-xs save-targets-btn">Save Targets</button>
                    </div>
                </div>

                 <!-- Weekly Plans Container -->
                <div class="space-y-8 weekly-plans-container">
                    ${[1, 2, 3, 4].map(weekNum => createWeekElement(monthId, `week${weekNum}`, data.weeks?.[`week${weekNum}`])).join('')}
                </div>
            `;

            // Add event listener for saving targets
             monthDiv.querySelector('.save-targets-btn').addEventListener('click', (e) => {
                 saveMonthlyTargets(monthId, monthDiv);
             });

             // Add event listeners for week elements (delegated or added within createWeekElement)
             attachWeekEventListeners(monthDiv, monthId);


            return monthDiv;
        }

        // Create HTML for a week section
        function createWeekElement(monthId, weekId, weekData) {
            const daysHtml = weekData?.days?.map((dayData, index) => createDayElement(monthId, weekId, index, dayData)).join('') || '<p class="text-gray-500 italic text-sm py-4">No days added for this week yet.</p>';
            const totalDays = weekData?.days?.length || 0;
            // Calculate progress initially
            const initialProgress = calculateWeeklyProgress(weekData);

            return `
                <div class="bg-gray-700/50 p-4 rounded-lg shadow-inner week-section" data-week-id="${weekId}">
                    <h3 class="text-lg font-semibold text-emerald-400 mb-3 capitalize">Daily Plan - ${weekId.replace('week', 'Week ')}</h3>

                    <!-- Weekly Progress Bar -->
                    <div class="mb-4">
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>Weekly Progress</span>
                            <span class="progress-percentage">${initialProgress}%</span>
                        </div>
                        <div class="progress-bar-container w-full">
                            <div class="progress-bar-fill" style="width: ${initialProgress}%;"></div>
                        </div>
                    </div>

                    <!-- Days Container -->
                    <div class="days-container space-y-6">
                        ${daysHtml}
                    </div>
                    <!-- Add Day Button for the week -->
                     ${totalDays > 0 ? `<button class="add-day-btn w-full mt-4" data-week-id="${weekId}"><i class="fas fa-plus"></i> Add New Day</button>` : `<button class="action-button mt-4 add-first-day-btn" data-week-id="${weekId}"><i class="fas fa-calendar-plus mr-2"></i> Add First Day</button>`}
                </div>
            `;
        }

       // Create HTML for a day section (including the table)
        function createDayElement(monthId, weekId, dayIndex, dayData) {
            const tableId = `table-${monthId}-${weekId}-${dayIndex}`;
            return `
                <div class="day-section border-t border-gray-600 pt-4" data-day-index="${dayIndex}">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold text-gray-200">Day ${dayData.dayNumber}</h4>
                        <button class="action-button action-button-secondary text-xs edit-day-btn">
                            <i class="fas fa-pencil-alt mr-1"></i> Edit
                        </button>
                    </div>
                    <table class="w-full text-sm text-left text-gray-400 study-table" id="${tableId}">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-600/50">
                            <tr>
                                <th scope="col" class="px-3 py-2 w-1/6">Subject</th>
                                <th scope="col" class="px-3 py-2 w-3/6">Topic / Vocab</th>
                                <th scope="col" class="px-3 py-2 w-1/6">Comment</th>
                                <th scope="col" class="px-3 py-2 w-1/12 text-center">Done</th>
                                <th scope="col" class="px-3 py-2 w-1/12 text-center completion-perc-header hidden">%</th> <!-- Hidden by default -->
                            </tr>
                        </thead>
                        <tbody>
                            ${dayData.rows?.map((rowData, rowIndex) => createTableRow(monthId, weekId, dayIndex, rowIndex, rowData, false)).join('') || ''}
                        </tbody>
                    </table>
                     <!-- Add Row Button - Initially Hidden -->
                    <button class="add-row-btn hidden mt-2 ml-1" title="Add Row">
                        <i class="fas fa-plus-circle"></i>
                    </button>
                </div>
            `;
        }

       // Create HTML for a table row (normal or edit mode)
        function createTableRow(monthId, weekId, dayIndex, rowIndex, rowData, isEditing) {
            const uniqueRowId = `row-${monthId}-${weekId}-${dayIndex}-${rowIndex}`;
            const isVocab = rowData.subject?.toLowerCase().startsWith('vocab');
            const topicContent = isEditing
                ? `<textarea class="editable-input topic-input text-xs" rows="2" placeholder="Topic details...">${rowData.topic || ''}</textarea>`
                 : (isVocab ? generateVocabHtml(rowData.vocabData) : `<span class="topic-display">${rowData.topic || ''}</span>`);

            const storyButtonHtml = (!isEditing && isVocab && rowData.story)
                 ? `<button class="action-button action-button-secondary text-xs read-story-btn mt-1">Read Story</button>` : '';

             const addStoryButtonHtml = (isEditing && isVocab)
                 ? `<button class="action-button action-button-secondary text-xs add-story-btn mt-1">Add/Edit Story</button>` : '';


            return `
                <tr id="${uniqueRowId}" data-row-index="${rowIndex}" class="${isEditing ? 'editing-mode' : ''} border-b border-gray-700 hover:bg-gray-700/30">
                    <td class="px-3 py-2 align-top">
                        ${isEditing ? `<input type="text" class="editable-input subject-input" placeholder="Subject" value="${rowData.subject || ''}">` : `<span class="subject-display font-medium text-gray-200">${rowData.subject || '-'}</span>`}
                    </td>
                    <td class="px-3 py-2 align-top vocab-topic-cell">
                        ${topicContent}
                        ${storyButtonHtml}
                        ${addStoryButtonHtml}
                    </td>
                    <td class="px-3 py-2 align-top">
                        ${isEditing ? `<textarea class="editable-input comment-input text-xs" rows="2" placeholder="Comment...">${rowData.comment || ''}</textarea>` : `<span class="comment-display text-xs">${rowData.comment || '-'}</span>`}
                    </td>
                    <td class="px-3 py-2 align-middle text-center">
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-emerald-500 bg-gray-600 border-gray-500 rounded focus:ring-emerald-400 completion-checkbox" ${rowData.completed ? 'checked' : ''} ${isEditing ? 'disabled' : ''}>
                    </td>
                     <td class="px-3 py-2 align-middle text-center completion-perc-cell ${isEditing ? '' : 'hidden'}">
                         ${isEditing ? `<input type="number" min="0" max="100" class="editable-input completion-perc-input w-16 text-center text-xs" placeholder="%" value="${rowData.completionPercentage ?? ''}">` : ''}
                     </td>
                </tr>
            `;
        }

        // Generate HTML for vocabulary display
        function generateVocabHtml(vocabData) {
            if (!vocabData || vocabData.length === 0) return '-';
            return vocabData.map(v => `<span class="vocab-word" data-meaning="${escapeHtml(v.meaning || '')}">${escapeHtml(v.word || '')}</span>`).join('');
        }

        // Helper to escape HTML characters
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
             return unsafe
                 .toString()
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }


        // --- Event Listeners and Handlers ---

        function attachWeekEventListeners(monthElement, monthId) {
             const weeklyPlansContainer = monthElement.querySelector('.weekly-plans-container');

             weeklyPlansContainer.addEventListener('click', async (e) => {
                 const target = e.target;
                 const weekSection = target.closest('.week-section');
                 if (!weekSection) return;
                 const weekId = weekSection.dataset.weekId;

                // Edit/Save Day Button
                if (target.closest('.edit-day-btn')) {
                    const button = target.closest('.edit-day-btn');
                    const daySection = button.closest('.day-section');
                    const isEditing = daySection.classList.contains('editing');
                    toggleDayEditMode(monthId, weekId, daySection, !isEditing);
                 }
                 // Add Row Button
                 else if (target.closest('.add-row-btn')) {
                    const daySection = target.closest('.day-section');
                    addRowToDay(monthId, weekId, daySection);
                 }
                 // Completion Checkbox
                 else if (target.classList.contains('completion-checkbox')) {
                     // Save immediately when checkbox is clicked in non-edit mode
                     const daySection = target.closest('.day-section');
                     if (!daySection.classList.contains('editing')) {
                         await saveDayPlan(monthId, weekId, daySection); // Save the entire day's state
                         updateWeeklyProgressUI(monthId, weekId); // Update progress bar after saving
                     }
                 }
                 // Vocab Word Click
                 else if (target.classList.contains('vocab-word')) {
                     showVocabMeaning(target);
                 }
                 // Read Story Button
                 else if (target.classList.contains('read-story-btn')) {
                     const row = target.closest('tr');
                     const dayIndex = parseInt(row.closest('.day-section').dataset.dayIndex);
                     const rowIndex = parseInt(row.dataset.rowIndex);
                     readStory(monthId, weekId, dayIndex, rowIndex);
                 }
                  // Add/Edit Story Button
                 else if (target.classList.contains('add-story-btn')) {
                     const row = target.closest('tr');
                      const daySection = row.closest('.day-section');
                      const dayIndex = parseInt(daySection.dataset.dayIndex);
                      const rowIndex = parseInt(row.dataset.rowIndex);
                      openEditStoryModal(monthId, weekId, dayIndex, rowIndex);
                 }
                 // Add Day Button
                 else if (target.classList.contains('add-day-btn') || target.classList.contains('add-first-day-btn')) {
                     const weekId = target.dataset.weekId;
                     addNewDay(monthId, weekId, weekSection);
                 }
             });
        }


        // Toggle Edit Mode for a Day
        async function toggleDayEditMode(monthId, weekId, daySection, enterEditMode) {
            const dayIndex = parseInt(daySection.dataset.dayIndex);
            const tableBody = daySection.querySelector('tbody');
            const editButton = daySection.querySelector('.edit-day-btn');
            const addRowButton = daySection.querySelector('.add-row-btn');
             const completionPercHeader = daySection.querySelector('.completion-perc-header');


             if (enterEditMode) {
                // Entering Edit Mode
                 daySection.classList.add('editing');
                 editButton.innerHTML = '<i class="fas fa-save mr-1"></i> Save';
                 editButton.classList.remove('action-button-secondary'); // Make it primary save color
                 addRowButton.classList.remove('hidden');
                 completionPercHeader.classList.remove('hidden');


                // Fetch current data to populate editable fields accurately
                const planDoc = await getDoc(doc(db, getUserPlansCollectionPath(), monthId));
                if (!planDoc.exists()) return;
                const dayData = planDoc.data().weeks[weekId]?.days[dayIndex];
                if (!dayData) return;

                // Re-render rows in edit mode
                tableBody.innerHTML = dayData.rows.map((rowData, rowIndex) =>
                    createTableRow(monthId, weekId, dayIndex, rowIndex, rowData, true)
                ).join('');

                // Disable completion checkboxes in edit mode
                daySection.querySelectorAll('.completion-checkbox').forEach(cb => cb.disabled = true);


            } else {
                // Saving and Exiting Edit Mode
                 await saveDayPlan(monthId, weekId, daySection); // Save the data first

                 daySection.classList.remove('editing');
                 editButton.innerHTML = '<i class="fas fa-pencil-alt mr-1"></i> Edit';
                 editButton.classList.add('action-button-secondary'); // Make it secondary color again
                 addRowButton.classList.add('hidden');
                  completionPercHeader.classList.add('hidden');

                 // Fetch the *saved* data to re-render in normal mode
                const planDoc = await getDoc(doc(db, getUserPlansCollectionPath(), monthId));
                 if (!planDoc.exists()) return;
                const dayData = planDoc.data().weeks[weekId]?.days[dayIndex];
                 if (!dayData) return;

                 // Re-render rows in normal mode
                tableBody.innerHTML = dayData.rows.map((rowData, rowIndex) =>
                    createTableRow(monthId, weekId, dayIndex, rowIndex, rowData, false)
                ).join('');

                updateWeeklyProgressUI(monthId, weekId); // Update progress bar after saving
            }
        }


         // Save the current state of a day's plan
        async function saveDayPlan(monthId, weekId, daySection) {
            if (!currentUser || !userId) return;
             console.log(`Saving day plan for ${monthId}, ${weekId}, Day Index: ${daySection.dataset.dayIndex}`);

            const dayIndex = parseInt(daySection.dataset.dayIndex);
            const rowsData = [];
            const rows = daySection.querySelectorAll('tbody tr');

            rows.forEach((row, rowIndex) => {
                 let rowData = {};
                 if (daySection.classList.contains('editing')) {
                     // Read from input fields in edit mode
                     rowData = {
                         subject: row.querySelector('.subject-input')?.value.trim() || '',
                         topic: row.querySelector('.topic-input')?.value.trim() || '',
                         comment: row.querySelector('.comment-input')?.value.trim() || '',
                         completed: false, // Checkboxes are disabled in edit mode, save as false initially
                         completionPercentage: parseInt(row.querySelector('.completion-perc-input')?.value) || null,
                         vocabData: null, // Will be processed below if subject is vocab
                         story: null // Will be retrieved from existing data if not changed
                     };
                      // Parse vocab if subject is 'Vocabulary'
                     if (rowData.subject?.toLowerCase().startsWith('vocab')) {
                        rowData.vocabData = parseVocabString(rowData.topic);
                     }
                      // Preserve existing story if not editing it now
                     // Need to fetch previous story data if it exists
                     // This part is tricky without fetching state *before* editing.
                     // Let's assume story is handled separately via the modal save.

                 } else {
                     // Read from display elements and checkbox in normal mode (mainly for checkbox changes)
                     const subject = row.querySelector('.subject-display')?.textContent || '';
                     const topic = row.querySelector('.topic-display')?.textContent || ''; // Or handle vocab spans if needed
                     const comment = row.querySelector('.comment-display')?.textContent || '';
                     const completed = row.querySelector('.completion-checkbox')?.checked || false;

                     // Need to fetch percentage, vocabData, story from Firestore for this row
                     // This highlights a potential issue: saving just checkbox requires fetching other row data
                     // A better approach might be to ONLY update the 'completed' field in Firestore for checkbox clicks
                      rowData = { subject, topic, comment, completed }; // INCOMPLETE - needs full data fetch or targeted update
                 }
                rowsData.push(rowData);
            });


             // --- More Robust Saving Strategy ---
             // Fetch the entire month document first
             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             try {
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    console.error("Month document not found for saving.");
                    showCustomAlert("Error: Could not find the month plan to save.");
                    return;
                }

                let monthData = docSnap.data();
                let daysArray = monthData.weeks?.[weekId]?.days || [];

                // Reconstruct the day's data accurately
                const currentDayData = daysArray[dayIndex]; // Get existing data
                const updatedRows = [];

                rows.forEach((row, rowIndex) => {
                    let subject, topic, comment, completed, completionPercentage, vocabData, story;
                     const existingRowData = currentDayData?.rows?.[rowIndex] || {}; // Data before edit/click

                     if (daySection.classList.contains('editing')) {
                         // Read from inputs
                         subject = row.querySelector('.subject-input')?.value.trim() || '';
                         topic = row.querySelector('.topic-input')?.value.trim() || '';
                         comment = row.querySelector('.comment-input')?.value.trim() || '';
                         completed = existingRowData.completed || false; // Keep completed status unless checkbox was clicked *before* edit
                         completionPercentage = parseInt(row.querySelector('.completion-perc-input')?.value) || null;
                         vocabData = subject?.toLowerCase().startsWith('vocab') ? parseVocabString(topic) : null;
                         story = existingRowData.story; // Preserve existing story
                     } else {
                         // Read from display + checkbox (only checkbox can change here)
                         subject = existingRowData.subject;
                         topic = existingRowData.topic;
                         comment = existingRowData.comment;
                         completed = row.querySelector('.completion-checkbox')?.checked || false; // The changed value
                         completionPercentage = existingRowData.completionPercentage;
                         vocabData = existingRowData.vocabData;
                         story = existingRowData.story;
                     }

                     updatedRows.push({
                         subject,
                         topic,
                         comment,
                         completed,
                         completionPercentage,
                         vocabData,
                         story
                     });
                 });

                 // Update the specific day's rows in the fetched data
                 if (daysArray[dayIndex]) {
                     daysArray[dayIndex].rows = updatedRows;
                 } else {
                     // This case shouldn't happen if we're saving an existing day
                     console.error("Trying to save data for a non-existent day index.");
                     return;
                 }

                 // Prepare the update object for Firestore
                 const updatePayload = {};
                 updatePayload[`weeks.${weekId}.days`] = daysArray;

                 // Update Firestore
                await updateDoc(docRef, updatePayload);
                console.log(`Day ${dayIndex + 1} for ${weekId} saved successfully.`);

             } catch (error) {
                 console.error("Error saving day plan:", error);
                 showCustomAlert("Error saving changes. Please check your connection and try again.");
             }
        }


         // Add a new row to a day's table (in edit mode)
        function addRowToDay(monthId, weekId, daySection) {
            const dayIndex = parseInt(daySection.dataset.dayIndex);
            const tableBody = daySection.querySelector('tbody');
            const newRowIndex = tableBody.rows.length; // Index for the new row

            const newRowData = { subject: '', topic: '', completed: false, comment: '', completionPercentage: null, vocabData: null, story: null };
            const newRowHtml = createTableRow(monthId, weekId, dayIndex, newRowIndex, newRowData, true); // Create in edit mode

            tableBody.insertAdjacentHTML('beforeend', newRowHtml);
             // Note: This row only exists in the UI until 'Save' is clicked for the day.
             // saveDayPlan handles collecting all rows including new ones.
        }

       // Add a new day to a week
        async function addNewDay(monthId, weekId, weekSection) {
            if (!currentUser || !userId) return;
             console.log(`Adding new day to ${monthId}, ${weekId}`);

             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             try {
                 const docSnap = await getDoc(docRef);
                 if (!docSnap.exists()) throw new Error("Month document not found.");

                 const monthData = docSnap.data();
                 let daysArray = monthData.weeks?.[weekId]?.days || [];
                 const lastDayIndex = daysArray.length - 1;
                 let newDayData;

                 if (lastDayIndex >= 0) {
                     // Copy structure from the last day
                     const lastDayRows = daysArray[lastDayIndex].rows || [];
                     newDayData = {
                         dayNumber: daysArray.length + 1,
                         date: '', // Reset date
                         rows: lastDayRows.map(row => ({
                             subject: row.subject || '',
                             topic: row.topic || '', // Keep topic structure
                             completed: false, // Reset completion
                             comment: '', // Reset comment
                             completionPercentage: null, // Reset percentage
                             vocabData: row.vocabData ? JSON.parse(JSON.stringify(row.vocabData)) : null, // Deep copy vocab structure if exists
                             story: null // Reset story
                         }))
                     };
                 } else {
                     // If it's the first day being added
                     newDayData = {
                         dayNumber: 1,
                         date: '',
                         rows: [{ subject: '', topic: '', completed: false, comment: '', completionPercentage: null, vocabData: null, story: null }] // Start with one blank row
                     };
                 }

                 // Update Firestore using arrayUnion or by setting the whole array
                 const updatePayload = {};
                 updatePayload[`weeks.${weekId}.days`] = arrayUnion(newDayData); // Atomically add the new day object

                 await updateDoc(docRef, updatePayload);
                 console.log("New day added successfully to Firestore.");
                 // UI will update via the onSnapshot listener

             } catch (error) {
                 console.error("Error adding new day:", error);
                 showCustomAlert("Error adding new day. Please try again.");
             }
         }


        // Save monthly targets
        async function saveMonthlyTargets(monthId, monthElement) {
             if (!currentUser || !userId) return;
             console.log("Saving targets for month:", monthId);

             const targets = {};
             monthElement.querySelectorAll('.monthly-targets textarea').forEach(textarea => {
                 targets[textarea.dataset.week] = textarea.value.trim();
             });

             const docRef = doc(db, getUserPlansCollectionPath(), monthId);
             try {
                 await updateDoc(docRef, {
                     weeklyTargets: targets
                 });
                 console.log("Monthly targets saved.");
                  showCustomAlert("Monthly targets saved successfully!", "success"); // Simple feedback
             } catch (error) {
                 console.error("Error saving targets:", error);
                  showCustomAlert("Error saving targets. Please try again.");
             }
        }

       // --- Vocabulary and Story Functions ---

        // Parse "Word,Meaning; Word2,Meaning2" string
        function parseVocabString(text) {
             if (!text || typeof text !== 'string') return null;
             return text.split(';')
                 .map(pair => {
                     const parts = pair.split(',');
                     if (parts.length >= 2) {
                         return { word: parts[0].trim(), meaning: parts.slice(1).join(',').trim() }; // Handle commas in meaning
                     }
                     return null; // Ignore invalid pairs
                 })
                 .filter(item => item && item.word); // Filter out nulls and items without a word
        }


        // Show vocab meaning in modal
        function showVocabMeaning(wordSpan) {
            document.getElementById('vocab-modal-word').textContent = wordSpan.textContent;
            document.getElementById('vocab-modal-meaning').textContent = wordSpan.dataset.meaning || 'No meaning provided.';
            vocabModal.style.display = "block";
        }

        // Show story in modal
        async function readStory(monthId, weekId, dayIndex, rowIndex) {
            if (!currentUser || !userId) return;
             try {
                 const docRef = doc(db, getUserPlansCollectionPath(), monthId);
                 const docSnap = await getDoc(docRef);
                 if (docSnap.exists()) {
                     const story = docSnap.data().weeks?.[weekId]?.days?.[dayIndex]?.rows?.[rowIndex]?.story;
                     if (story) {
                         document.getElementById('story-modal-content').textContent = story;
                         storyModal.style.display = "block";
                     } else {
                         showCustomAlert("No story found for this entry.");
                     }
                 }
             } catch (error) {
                 console.error("Error reading story:", error);
                  showCustomAlert("Could not load the story.");
             }

        }

        // Open the modal to add/edit a story
         async function openEditStoryModal(monthId, weekId, dayIndex, rowIndex) {
             if (!currentUser || !userId) return;
             currentStoryTarget = { monthId, weekId, dayIndex, rowIndex }; // Store context

             // Fetch existing story to pre-fill textarea
             let existingStory = '';
             try {
                 const docRef = doc(db, getUserPlansCollectionPath(), monthId);
                 const docSnap = await getDoc(docRef);
                 if (docSnap.exists()) {
                     existingStory = docSnap.data().weeks?.[weekId]?.days?.[dayIndex]?.rows?.[rowIndex]?.story || '';
                 }
             } catch (error) {
                 console.error("Error fetching existing story:", error);
             }

             document.getElementById('story-textarea').value = existingStory;
             editStoryModal.style.display = "block";
         }

         // Save the story from the modal
        saveStoryBtn.addEventListener('click', async () => {
             if (!currentUser || !userId || !currentStoryTarget) return;

             const { monthId, weekId, dayIndex, rowIndex } = currentStoryTarget;
             const newStory = document.getElementById('story-textarea').value.trim();

             const docRef = doc(db, getUserPlansCollectionPath(), monthId);

             try {
                // Fetch the current state of the day's rows
                 const docSnap = await getDoc(docRef);
                 if (!docSnap.exists()) throw new Error("Month document not found.");

                 let monthData = docSnap.data();
                 let daysArray = monthData.weeks?.[weekId]?.days || [];

                 // Ensure the structure exists
                 if (daysArray[dayIndex] && daysArray[dayIndex].rows && daysArray[dayIndex].rows[rowIndex]) {
                     // Update the story for the specific row
                     daysArray[dayIndex].rows[rowIndex].story = newStory || null; // Store null if empty

                     // Prepare the update payload
                     const updatePayload = {};
                     updatePayload[`weeks.${weekId}.days`] = daysArray;

                     // Update Firestore
                     await updateDoc(docRef, updatePayload);
                     console.log("Story saved successfully.");

                     closeModal('edit-story-modal');
                     // Optionally, refresh the specific day's UI or rely on onSnapshot

                     // --- Update UI immediately after saving story ---
                     const daySection = document.querySelector(`[data-month-id="${monthId}"] .week-section[data-week-id="${weekId}"] .day-section[data-day-index="${dayIndex}"]`);
                     if (daySection && !daySection.classList.contains('editing')) { // Only update if not in edit mode
                         const rowElement = daySection.querySelector(`tbody tr[data-row-index="${rowIndex}"]`);
                         if (rowElement) {
                             // Fetch updated row data (including the saved story)
                              const updatedDocSnap = await getDoc(docRef);
                              if(updatedDocSnap.exists()){
                                  const updatedRowData = updatedDocSnap.data().weeks?.[weekId]?.days?.[dayIndex]?.rows?.[rowIndex];
                                  if(updatedRowData){
                                        rowElement.outerHTML = createTableRow(monthId, weekId, dayIndex, rowIndex, updatedRowData, false);
                                  }
                              }
                         }
                     }
                     // --- End UI Update ---


                 } else {
                     console.error("Row structure not found for saving story.");
                     showCustomAlert("Error: Could not find the specific row to save the story.");
                 }

             } catch (error) {
                 console.error("Error saving story:", error);
                  showCustomAlert("Error saving story. Please try again.");
             } finally {
                 currentStoryTarget = null; // Reset target
             }
         });


        // --- Progress Calculation ---

        function calculateWeeklyProgress(weekData) {
            if (!weekData || !weekData.days || weekData.days.length === 0) {
                return 0;
            }

            let totalPercentage = 0;
            let completedCount = 0;

            weekData.days.forEach(day => {
                day.rows?.forEach(row => {
                    if (row.completed && typeof row.completionPercentage === 'number' && row.completionPercentage > 0) {
                        totalPercentage += row.completionPercentage;
                        // completedCount++; // Don't count items, just sum percentages
                    }
                });
            });

             // Cap at 100%
             return Math.min(Math.round(totalPercentage), 100);
        }

         // Update the progress bar UI for a specific week
        async function updateWeeklyProgressUI(monthId, weekId) {
             if (!currentUser || !userId) return;
              console.log(`Updating progress UI for ${monthId}, ${weekId}`);

             const weekSection = document.querySelector(`[data-month-id="${monthId}"] .week-section[data-week-id="${weekId}"]`);
             if (!weekSection) return;

             const progressBarFill = weekSection.querySelector('.progress-bar-fill');
             const progressPercentageSpan = weekSection.querySelector('.progress-percentage');

             try {
                const docRef = doc(db, getUserPlansCollectionPath(), monthId);
                const docSnap = await getDoc(docRef);
                 if (docSnap.exists()) {
                     const weekData = docSnap.data().weeks?.[weekId];
                     const progress = calculateWeeklyProgress(weekData);

                    progressBarFill.style.width = `${progress}%`;
                    progressPercentageSpan.textContent = `${progress}%`;
                     // Optional: Add text inside bar if needed
                     // progressBarFill.textContent = progress > 10 ? `${progress}%` : '';
                     console.log(`Progress updated to ${progress}%`);
                 }
             } catch (error) {
                 console.error("Error fetching week data for progress update:", error);
             }
        }


        // --- Modal Handling ---
        window.closeModal = function(modalId) {
          document.getElementById(modalId).style.display = "none";
        }
        // Close modal if clicked outside of it
        window.onclick = function(event) {
          if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
          }
        }

         // --- Simple Custom Alert ---
         function showCustomAlert(message, type = "error") {
            // In a real app, you'd create a styled modal or toast notification
            console.log(`ALERT (${type}): ${message}`);
            // Simple temporary alert-like behavior (replace with a proper UI element)
            const alertBox = document.createElement('div');
            alertBox.style.position = 'fixed';
            alertBox.style.top = '20px';
            alertBox.style.left = '50%';
            alertBox.style.transform = 'translateX(-50%)';
            alertBox.style.padding = '10px 20px';
            alertBox.style.borderRadius = '5px';
            alertBox.style.zIndex = '200';
            alertBox.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            if (type === 'success') {
                alertBox.style.backgroundColor = '#10b981'; // emerald-500
                 alertBox.style.color = 'white';
            } else {
                 alertBox.style.backgroundColor = '#f87171'; // red-400
                 alertBox.style.color = 'white';
            }
             alertBox.textContent = message;
             document.body.appendChild(alertBox);
             setTimeout(() => {
                 alertBox.remove();
             }, 3000); // Remove after 3 seconds
         }


        // --- Initial Load ---
        // Authentication state determines the initial load call via onAuthStateChanged

    </script>

     <!-- Your existing script.js link - Ensure it's loaded AFTER the Firebase module script -->
     <script src="script.js" defer></script>


</body>
</html>
