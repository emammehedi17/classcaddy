<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Study Plan</title>
    <!-- Importing Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Importing Inter font --><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6; /* Light gray-green background */
        }
        /* ... existing styles ... */

        /* Add transitions for smooth bg change */
        .task-item, .card-item {
            transition: background-color 0.3s;
        }

        /* Style for completed table row */
        .task-item.completed {
            background-color: #bbf7d0; /* Green-200 (Even Deeper) */
        }
        .task-item.completed td {
            color: #374151; /* Gray-700 */
        }
        /* Keep vocab items looking normal */
        .task-item.completed .vocab-item {
            color: #3730a3; /* Indigo-800 */
            opacity: 0.9;
        }
        .task-item.completed .vocab-item:hover {
            background-color: #c7d2fe; /* Indigo-200 */
            opacity: 1;
        }

        /* Style for completed mobile card */
        .card-item.completed {
            background-color: #bbf7d0; /* Green-200 (Even Deeper) */
        }
        .card-item.completed p,
        .card-item.completed .text-gray-600,
        .card-item.completed .text-sm div { /* Target the div wrapping vocab on mobile */
            color: #374151; /* Gray-700 */
        }
        .card-item.completed .vocab-item {
            color: #3730a3; /* Indigo-800 */
            opacity: 0.9;
        }
        .card-item.completed .vocab-item:hover {
            background-color: #c7d2fe; /* Indigo-200 */
            opacity: 1;
        }

        /* Custom checkbox style */
        .task-checkbox {
            appearance: none;
            -webkit-appearance: none;
            height: 1.25rem;
            width: 1.25rem;
            min-width: 1.25rem;
            border: 2px solid #cbd5e1; /* Gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            display: inline-block;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 0.75rem; /* mr-3 */
            flex-shrink: 0;
        }
        .task-checkbox:checked {
            background-color: #2563eb; /* Blue-600 */
            border-color: #2563eb; /* Blue-600 */
        }
        .task-checkbox:checked::after {
            content: "";
            position: absolute;
            display: block;
            left: 0.4rem; /* 6px */
            top: 0.125rem; /* 2px */
            width: 0.35rem; /* 5px */
            height: 0.7rem; /* 11px */
            border-style: solid;
            border-color: white;
            border-width: 0 0.15rem 0.15rem 0; /* 0 2px 2px 0 */
            transform: rotate(45deg);
        }

        /* --- Vocabulary Styles --- */
        .vocab-item {
            position: relative;
            display: inline-block;
            background-color: #eef2ff; /* Indigo-50 */
            color: #3730a3; /* Indigo-800 */
            padding: 4px 10px;
            border-radius: 9999px; /* rounded-full */
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .vocab-item:hover {
            background-color: #c7d2fe; /* Indigo-200 */
        }
        .vocab-meaning {
            visibility: hidden;
            opacity: 0;
            width: max-content;
            max-width: 250px;
            background-color: #312e81; /* Indigo-900 */
            color: #fff;
            text-align: center;
            border-radius: 6px; /* rounded-md */
            padding: 6px 12px;
            position: absolute;
            z-index: 10;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            transition: opacity 0.3s, visibility 0.3s;
            font-weight: 500;
            white-space: normal;
        }
        .vocab-item.active .vocab-meaning {
            visibility: visible;
            opacity: 1;
        }
        .vocab-item .vocab-meaning::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #312e81 transparent transparent transparent;
        }
        /* --- End Vocabulary Styles --- */
        
        /* --- Modal Styles (Shared) --- */
        .modal-hidden {
            display: none;
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 40;
            transition: opacity 0.3s;
        }
        .modal-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: transparent;
            border: none;
            color: #4b5563; /* Gray-600 */
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700;
            line-height: 1;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 999px;
            transition: background-color 0.2s, color 0.2s;
        }
        .modal-close-btn:hover {
            background-color: #f3f4f6; /* Gray-100 */
            color: #1f2937; /* Gray-800 */
        }
        
        /* --- Story Modal Styles --- */
        #story-modal-box {
            background-color: #fffbef; /* Amber-50 (parchment) */
            border: 4px solid #78350f; /* Amber-800 (dark border) */
            max-width: 500px; /* 500px */
            padding: 1.5rem; /* p-6 */
        }
        #story-modal-box h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: #78350f; /* Amber-800 */
            margin-bottom: 1rem;
        }
        #story-modal-box p {
            color: #451a03; /* Amber-950 */
            line-height: 1.6;
        }
        #story-modal-box p strong {
            color: #c2410c; /* Orange-600 */
            font-weight: 600;
        }
        #story-modal-box .modal-close-btn {
            color: #78350f; /* Amber-800 */
        }
        #story-modal-box .modal-close-btn:hover {
            color: #c2410c; /* Orange-600 */
            background-color: #fef3c7; /* Amber-100 */
        }

        /* --- NEW: Edit Modal Styles --- */
        #edit-modal-box {
            max-width: 700px; /* Wider modal */
            padding: 0;
        }
        #edit-modal-header {
            padding: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb; /* Gray-200 */
        }
        #edit-modal-header h3 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* Semibold */
            color: #111827; /* Gray-900 */
        }
        #edit-modal-content {
            padding: 1.5rem;
            background-color: #f9fafb; /* Gray-50 */
            max-height: 60vh;
            overflow-y: auto;
        }
        #edit-modal-content .form-group {
            margin-bottom: 1.25rem;
        }
        #edit-modal-content label {
            display: block;
            font-weight: 500;
            color: #374151; /* Gray-700 */
            margin-bottom: 0.5rem;
            font-size: 0.875rem; /* text-sm */
        }
        #edit-modal-content input,
        #edit-modal-content textarea {
            width: 100%;
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.6rem 0.8rem;
            font-size: 0.95rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #edit-modal-content input:focus,
        #edit-modal-content textarea:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo-600 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
        }
        #edit-modal-content textarea {
            min-height: 80px;
            font-family: 'Inter', sans-serif;
        }
        #edit-modal-footer {
            padding: 1.25rem 1.5rem;
            background-color: #ffffff;
            border-top: 1px solid #e5e7eb; /* Gray-200 */
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        .modal-btn {
            padding: 0.5rem 1rem;
            font-weight: 500;
            border-radius: 0.5rem; /* rounded-lg */
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .btn-secondary {
            background-color: #ffffff;
            color: #374151; /* Gray-700 */
            border: 1px solid #d1d5db; /* Gray-300 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        .btn-secondary:hover {
            background-color: #f9fafb; /* Gray-50 */
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        .btn-primary:disabled {
            background-color: #a5b4fc; /* Indigo-300 */
            cursor: not-allowed;
        }
        /* --- End Edit Modal Styles --- */

        .read-story-btn, .edit-day-btn {
            display: inline-block;
            margin-top: 0.75rem; /* mt-3 */
            margin-left: 0.25rem; /* ml-1 */
            color: white;
            padding: 4px 12px;
            border-radius: 9999px; /* rounded-full */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
        }
        .read-story-btn {
             background-color: #3730a3; /* Indigo-800 */
        }
        .read-story-btn:hover {
            background-color: #4f46e5; /* Indigo-600 */
        }
        /* NEW Edit button style */
        .edit-day-btn {
            background-color: #059669; /* Green-600 */
            margin-left: 0.5rem; /* ml-2 */
        }
        .edit-day-btn:hover {
            background-color: #047857; /* Green-700 */
        }
        /* Make checkbox and edit button line up */
        .completion-cell-content {
            display: flex;
            align-items: center;
        }
        .completion-card-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .completion-card-controls {
            display: flex;
            align-items: center;
            width: 100%;
        }


        /* --- Progress Bar Styles --- */
        .progress-container {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f4f7f6; /* Match body bg */
            padding-top: 1rem; /* 16px */
            padding-bottom: 1rem; /* 16px */
            margin-bottom: 1.5rem; /* 24px (was mb-6) */
        }
        .progress-bar-outer {
            background-color: #e5e7eb; /* Gray-200 */
        }
        .progress-bar-inner {
            background-color: #4f46e5; /* Indigo-600 */
            transition: width 0.4s ease-in-out;
        }
        /* --- End Progress Bar Styles --- */

        /* --- Table Coloring & Grouping --- */
        .full-table table {
            border-collapse: collapse; /* Makes borders connect */
        }

        .full-table thead th {
            background-color: #6366f1; /* Indigo-500 */
            color: white;
            font-weight: 600; /* Semibold */
            text-align: center; /* Center align header text */
            padding-top: 0.75rem; /* py-3 */
            padding-bottom: 0.75rem; /* py-3 */
            padding-left: 1.5rem; /* px-6 */
            padding-right: 1.5rem; /* px-6 */
            border-top: 3px solid #4f46e5; /* Indigo-600 */
            border-bottom: 2px solid #4f46e5; /* Indigo-600 */
        }
        .full-table thead th:first-child {
            border-left: 3px solid #4f46e5; /* Indigo-600 */
        }
        .full-table thead th:last-child {
            border-right: 3px solid #4f46e5; /* Indigo-600 */
        }
        .full-table tbody tr:nth-child(even) {
            background-color: #e0e7ff; /* Indigo-100 for even rows */
        }
        .full-table tbody tr:nth-child(odd) {
            background-color: #f0f4ff; /* Indigo-50 for odd rows */
        }
        .full-table tbody tr.task-item.completed:nth-child(even) {
            background-color: #99f6e4; /* Teal-200, slightly different completed color */
        }
        .full-table tbody tr.task-item.completed:nth-child(odd) {
            background-color: #a7f3d0; /* Green-200, slightly different completed color */
        }
        .full-table tbody td {
            color: #374151; /* Darker gray for text */
            border-top: 1px solid #c7d2fe; /* Indigo-200, thin horizontal line */
        }
        .full-table tbody tr.day-group-start td {
            border-top: 3px solid #4f46e5; /* Indigo-600 */
        }
        .full-table tbody tr.task-item td:first-child {
            border-left: 3px solid #4f46e5; /* Indigo-600 */
        }
        .full-table tbody tr.task-item td:last-child {
            border-right: 3px solid #4f46e5; /* Indigo-600 */
        }
        .full-table tbody tr:last-child td {
             border-bottom: 3px solid #4f46e5; /* Indigo-600 */
        }
        .full-table tbody td:first-child { /* Day cell */
            font-weight: 600;
            color: #1e3a8a; /* Darker blue for day */
        }
        .full-table tbody td:nth-child(2) { /* Subject cell */
            color: #4b5563; /* Medium gray */
        }
        .full-table tbody td:nth-child(3) { /* Topic cell */
            color: #1f2937; /* Even darker gray for topic */
        }

        /* Mobile Cards Coloring */
        .mobile-cards .card-item {
            background-color: #ffffff; /* White base */
            border: 1px solid #e5e7eb; /* Add a light border to mobile cards */
        }
        .mobile-cards .card-item.completed {
            background-color: #d1fae5; /* Green-100 for completed mobile cards */
            border-color: #a7f3d0;
        }
        .mobile-cards .card-item h3 {
            color: #1e3a8a; /* Darker blue for day header */
        }
        .mobile-cards .card-item p.font-medium {
            color: #4b5563; /* Medium gray for subject */
        }
        .mobile-cards .card-item .text-sm {
            color: #1f2937; /* Darker gray for topic */
        }

        /* Responsive table layout */
        @media (max-width: 768px) {
            .full-table {
                display: none;
            }
            .mobile-cards {
                display: block;
            }
        }
        @media (min-width: 769px) {
            .full-table {
                display: table;
            }
            .mobile-cards {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        
        <!-- Header --><div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">My Study Plan</h1>
            <p class="text-lg text-gray-500">Monthly Plan (18.10.25 – 17.11.25)</p>
        </div>

        <!-- Auth & Sync Status -->
        <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg shadow">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                <!-- Status -->
                <div>
                    <h3 class="font-semibold text-indigo-800">Sync Status</h3>
                    <div class="flex items-center space-x-2">
                        <div id="sync-indicator" class="w-3 h-3 rounded-full bg-gray-400 animate-pulse"></div>
                        <p id="sync-status" class="text-sm text-indigo-700">Waiting for login...</p>
                    </div>
                    <p id="sync-error" class="hidden text-xs text-red-600 mt-1"></p>
                </div>
                
                <!-- Auth Controls -->
                <div id="auth-container" class="mt-4 sm:mt-0 sm:ml-4 flex-shrink-0">
                    <!-- Logged Out State (Default) -->
                    <button id="login-btn" class="w-full sm:w-auto bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg shadow-sm hover:bg-gray-50 transition flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v8.51h13.04c-.57 2.75-2.23 5.08-4.79 6.64l7.98 6.19C45.27 36.64 48 31.13 48 24c0-.79-.07-1.55-.17-2.3z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.98-6.19c-2.11 1.45-4.8 2.3-7.91 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        Sign in with Google
                    </button>
                    
                    <!-- Logged In State (Hidden by default) -->
                    <div id="user-info" class="hidden text-sm text-right">
                         <p class="font-medium text-gray-800" id="user-name">Loading...</p>
                         <p class="text-gray-600 truncate max-w-[200px]" id="user-email">...</p>
                         <button id="logout-btn" class="text-xs text-red-600 font-medium hover:underline mt-1">Log Out</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Targets Grid --><div class="mb-10">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Monthly Targets</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">
                <!-- Week 1 --><div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="font-semibold text-lg text-indigo-700 mb-2">1st Week</h3>
                    <p class="text-gray-600">Math Class 15, Basic View 1-150 pages</p>
                </div>
                <!-- Week 2 --><div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="font-semibold text-lg text-teal-700 mb-2">2nd Week</h3>
                    <p class="text-gray-600">Bangla Class 15, Computer hour 1-150 pages</p>
                </div>
                <!-- Week 3 --><div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="font-semibold text-lg text-amber-700 mb-2">3rd Week</h3>
                    <p class="text-gray-600">Math Class 7, English lit. handbook complete</p>
                </div>
                <!-- Week 4 --><div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="font-semibold text-lg text-rose-700 mb-2">4th Week</h3>
                    <p class="text-gray-600">Basic View 151-300 pages, Mental Ability classes 15</p>
                </div>
            </div>
        </div>

        <!-- Daily Plan - 1st Week --><div>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Daily Plan – 1st Week</h2>
            
            <!-- Progress Bar -->
            <div class="progress-container"> 
                <div class="flex justify-between mb-1">
                    <span id="weekly-progress-label" class="text-base font-medium text-indigo-700">Weekly Progress: 0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3.5 progress-bar-outer shadow-inner">
                    <div id="weekly-progress-bar" class="bg-indigo-600 h-3.5 rounded-full progress-bar-inner" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Desktop Table --><div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 full-table">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Day</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Topic</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completed</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white" id="daily-plan-body">
                        <!-- Tasks will be dynamically inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards --><div class="space-y-4 mobile-cards" id="daily-plan-cards">
                <!-- Mobile cards will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- --- Story Modal HTML (hidden by default) --- -->
    <div id="story-modal" class="modal-hidden">
        <div id="story-overlay" class="modal-overlay"></div>
        <div id="story-modal-box" class="modal-box">
            <button id="story-close-btn" class="modal-close-btn">&times;</button>
            <h3 id="story-title">A Day's Tale</h3>
            <p id="story-content" class="mt-4"></p>
        </div>
    </div>
    <!-- --- End Story Modal HTML --- -->

    <!-- --- NEW: Edit Modal HTML (hidden by default) --- -->
    <div id="edit-modal" class="modal-hidden">
        <div id="edit-overlay" class="modal-overlay"></div>
        <div id="edit-modal-box" class="modal-box">
            <div id="edit-modal-header">
                <h3 id="edit-modal-title">Edit Day</h3>
                <button id="edit-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div id="edit-modal-content">
                <!-- Dynamic form content will be injected here -->
            </div>
            <div id="edit-modal-footer">
                <button id="edit-cancel-btn" class="modal-btn btn-secondary">Cancel</button>
                <button id="edit-save-btn" class="modal-btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
    <!-- --- End Edit Modal HTML --- -->


    <!-- Firebase Imports -->
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot,
            collection,
            query,
            getDocs,
            limit,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyAj7MDnrnzKUO73BXG0jeM-uBGrAH3XiAY",
          authDomain: "study-plan17.firebaseapp.com",
          projectId: "study-plan17",
          storageBucket: "study-plan17.firebasestorage.app",
          messagingSenderId: "394648483332",
          appId: "1:394648483332:web:a0b8f6adc9c8cad0e4e751",
          measurementId: "G-X9CFFJCM2F"
        };

        // --- Firebase Initialization ---
        let app, auth, db, userId;
        let planContentCollectionRef = null;
        let progressDocRef = null;
        let unsubscribePlanListener = null; 
        let unsubscribeProgressListener = null;
        let isDataLoaded = false;
        let currentPlanData = []; // Holds the local copy of the plan
        let currentProgressData = {}; // Holds local copy of progress

        // --- UI Elements for Auth & Sync ---
        const syncIndicator = document.getElementById('sync-indicator');
        const syncStatus = document.getElementById('sync-status');
        const syncError = document.getElementById('sync-error');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');

        // --- UI Elements for Modals ---
        const storyModal = document.getElementById('story-modal');
        const storyOverlay = document.getElementById('story-overlay');
        const storyCloseBtn = document.getElementById('story-close-btn');
        const storyContent = document.getElementById('story-content');
        const storyTitle = document.getElementById('story-title');

        const editModal = document.getElementById('edit-modal');
        const editOverlay = document.getElementById('edit-overlay');
        const editCloseBtn = document.getElementById('edit-close-btn');
        const editCancelBtn = document.getElementById('edit-cancel-btn');
        const editSaveBtn = document.getElementById('edit-save-btn');
        const editModalTitle = document.getElementById('edit-modal-title');
        const editModalContent = document.getElementById('edit-modal-content');

        // --- UI Elements for Plan ---
        const tableBody = document.getElementById('daily-plan-body');
        const mobileCardsContainer = document.getElementById('daily-plan-cards');
        const progressLabel = document.getElementById('weekly-progress-label');
        const progressBar = document.getElementById('weekly-progress-bar');
        
        // --- Progress Bar Logic ---
        const taskWeights = {
            'quran': 5/7,
            'newspaper': 5/7,
            'vocabulary': 10/7,
            'math': 40/7,
            'basic': 40/7
        };
        let maxWeight = 0; // Will be calculated when UI is built

        // --- Set Sync Status UI ---
        function setSyncStatus(status, isError = false) {
            if (isError) {
                syncIndicator.classList.remove('bg-green-500', 'animate-pulse');
                syncIndicator.classList.add('bg-red-500');
                syncStatus.textContent = "Sync Error";
                syncError.textContent = status;
                syncError.classList.remove('hidden');
            } else if (status === 'synced') {
                syncIndicator.classList.remove('bg-gray-400', 'animate-pulse', 'bg-yellow-500');
                syncIndicator.classList.add('bg-green-500');
                syncStatus.textContent = "Synced";
                syncError.classList.add('hidden');
            } else if (status === 'saving') {
                syncIndicator.classList.remove('bg-green-500');
                syncIndicator.classList.add('bg-yellow-500', 'animate-pulse');
                syncStatus.textContent = "Saving...";
            } else { // connecting
                syncIndicator.classList.add('bg-gray-400', 'animate-pulse');
                syncStatus.textContent = "Connecting...";
            }
        }

        // --- Auth UI Functions ---
        function showLoggedOutUI() {
            if (unsubscribePlanListener) unsubscribePlanListener();
            if (unsubscribeProgressListener) unsubscribeProgressListener();
            
            userInfo.classList.add('hidden');
            loginBtn.classList.remove('hidden');

            setSyncStatus("Waiting for login...");
            syncIndicator.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500');
            syncIndicator.classList.add('bg-gray-400');
            
            clearLocalData();
            isDataLoaded = false;
        }

        function showLoggedInUI(user) {
            loginBtn.classList.add('hidden');
            userInfo.classList.remove('hidden');
            userName.textContent = user.displayName;
            userEmail.textContent = user.email;
            setSyncStatus("Connecting...");
        }

        // --- Clear UI ---
        function clearLocalData() {
            tableBody.innerHTML = '';
            mobileCardsContainer.innerHTML = '';
            currentPlanData = [];
            currentProgressData = {};
            updateWeeklyProgress();
            console.log("Local UI cleared.");
        }

        // --- Auth Functions ---
        async function signInWithGoogle() {
            if (!auth) return;
            const provider = new GoogleAuthProvider();
            try {
                setSyncStatus("Logging in...");
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error during Google sign-in:", error);
                setSyncStatus(error.message, true);
            }
        }

        async function signOutUser() {
            if (!auth) return;
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out:", error);
                setSyncStatus(error.message, true);
            }
        }

        // --- Default Data Function ---
        // This is the new, structured data that will be seeded for new users
        function getDefaultPlanData() {
            return [
                {
                    dayId: 'Day-1',
                    tasks: [
                        { id: 'quran', subject: 'Quran', topic: 'Sura Anfal 8:45- 8:53' },
                        { id: 'newspaper', subject: 'Newspaper', topic: 'The Daily Star: Shibir-backed panel sweeps Rucsu polls, Lowest HSC pass rate in 21 years' },
                        { id: 'vocabulary', subject: 'Vocabulary', topic: 'Sweep- বিজয় অর্জন, Clinch- সমর্থন করা, unbridled-অবাধ, outperform-ছাড়িয়ে যাওয়া, Steep-خাড়া, dismally- poorly, poor show- নিম্ন ফলাফল, lenient- কোমল, pronounced- সুস্পষ্ট।' },
                        { id: 'math', subject: 'Math', topic: 'Ratio Class 12, 13' },
                        { id: 'basic', subject: 'Basic View', topic: 'Page 1-20' }
                    ],
                    story: "The young prince planned to <strong>sweep</strong> the election. He needed to <strong>clinch</strong> the final vote from the stubborn council. His victory led to <strong>unbridled</strong> celebrations in the streets. He promised his advisors he would <strong>outperform</strong> all previous rulers. But his first challenge was a <strong>steep</strong> mountain pass, now blocked by snow. The kingdom's food supply looked <strong>dismally</strong> low. The public called his first month a <strong>poor show</strong>. His <strong>pronounced</strong> frown showed his worry. He wondered, should he be <strong>lenient</strong> with the grain merchants, or seize their stock for the people?"
                },
                {
                    dayId: 'Day-2',
                    tasks: [
                        { id: 'quran', subject: 'Quran', topic: 'Sura Anfal 8:53-8:69' },
                        { id: 'newspaper', subject: 'Newspaper', topic: 'Editorial: Our children deserve clean air' },
                        { id: 'vocabulary', subject: 'Vocabulary', topic: 'Unnerved- ভীত, dire- অত্যান্ত জরুরি, particulate matter- অতিক্ষুদ্র পদার্থ, brick kilns- ইট ভাটা, infants- শিশু, likelihood- সম্ভাবনা, ingrained- বদ্ধমূল, halt- থামা, perpetuate- অবিরাম করা,' },
                        { id: 'math', subject: 'Math', topic: 'Ratio Class 14, 15' },
                        { id: 'basic', subject: 'Basic View', topic: '' }
                    ],
                    story: "The old scientist felt <strong>unnerved</strong> by the sky's strange color. He gave a <strong>dire</strong> warning to the town's mayor. 'The <strong>particulate matter</strong> is at a deadly level,' he explained. 'It's coming from the new <strong>brick kilns</strong>.' He worried most about the <strong>infants</strong>, who were weakest. The <strong>likelihood</strong> of a lung disease was rising daily. This cough was now <strong>ingrained</strong> in the town's life. 'We must <strong>halt</strong> production!' he cried. 'If we let this <strong>perpetuate</strong>, no one will be left.'"
                },
                {
                    dayId: 'Day-3',
                    tasks: [
                        { id: 'quran', subject: 'Quran', topic: 'Sura Anfal 8:70- Sura Tawbah 9:6' },
                        { id: 'newspaper', subject: 'Newspaper', topic: 'Editorial: Sabotage or not, the government must account for the recent fires' },
                        { id: 'vocabulary', subject: 'Vocabulary', topic: 'Sabotage- নাশকতা, Devastating- ধ্বংশাত্মক, Blaze- তীব্র অগ্নিকাণ্ড, deploy- মোতায়েন করা, disrupt- বিঘ্ন ঘটানো, stranded- আটকে পড়া, spate- ঢল, undermine- দুর্বল করা, <strong>sow</strong> panic- আতঙ্ক ছড়ানো, arson- অগ্নিসংযোগ, resolute- দৃঢ় প্রতিজ্ঞ, beyond comprehension- বোধগম্যতার বাইরে, contingency- বিকল্প ব্যবস্থা, bode- ইঙ্গিত দেয়া/ পূর্বাভাস' },
                        { id: 'math', subject: 'Math', topic: 'Class 16, 17' },
                        { id: 'basic', subject: 'Basic View', topic: '' }
                    ],
                    story: "The empress was certain it was <strong>sabotage</strong>. The result of the fire was <strong>devastating</strong>. The great <strong>blaze</strong> had destroyed the silk market. She had to <strong>deploy</strong> her royal guard immediately. Someone wanted to <strong>disrupt</strong> the peace festival. Many merchants were now <strong>stranded</strong> with no goods to sell. This was the latest in a <strong>spate</strong> of strange accidents. Someone was trying to <strong>undermine</strong> her authority. They wanted to <strong>sow</strong> panic among the citizens. This was clearly an act of <strong>arson</strong>. The empress remained <strong>resolute</strong> in her duty. The cruelty of the act was <strong>beyond comprehension</strong>. She immediately ordered a new <strong>contingency</strong> plan for the city's safety. 'This fire,' she whispered to her general, 'does not <strong>bode</strong> well for our future.'"
                },
                {
                    dayId: 'Day-4',
                    tasks: [
                        { id: 'quran', subject: 'Quran', topic: 'Sura Tawbah 9:7- 9:20' },
                        { id: 'newspaper', subject: 'Newspaper', topic: '' },
                        { id: 'vocabulary', subject: 'Vocabulary', topic: '' },
                        { id: 'math', subject: 'Math', topic: 'Class 18, 19' },
                        { id: 'basic', subject: 'Basic View', topic: '' }
                    ],
                    story: ""
                },
                {
                    dayId: 'Day-5',
                    tasks: [
                        { id: 'quran', subject: 'Quran', topic: 'Sura Tawbah 9:21- 9:31' },
                        { id: 'newspaper', subject: 'Newspaper', topic: 'Tripura mob killing of Bangladeshis exposes the accountability gap' },
                        { id: 'vocabulary', subject: 'Vocabulary', topic: 'Gruesome-ভয়াবহ, heinous-নিকৃষ্ট, sanctity- পবিত্রতা, frontier vengeance- সীমান্ত প্রতিহিংসা, porous- ছিদ্রযুক্ত, flux- অবিরাম গতি, illicit- অবৈধ, intricate- সূক্ষ্ণ, backdrop- পটভূমি, precarious- ঝুঁকিপূর্ণ, pledged- প্রতিজ্ঞা করা, curb- দমন করা, intrusions- onadhikar probes, repatriate- নিজ দেশে ফেরত পাঠানো, patrols- টহল, usher in- শুরু করা, restraint- সংগম, hollow- ফাঁপা, invoking- আহ্বান করা, culminating-শেষ করা, perpetrators- অপরাধী' },
                        { id: 'math', subject: 'Math', topic: 'Class 20, 21' },
                        { id: 'basic', subject: 'Basic View', topic: '' }
                    ],
                    story: "The detective inspected the <strong>gruesome</strong> crime scene. It was a truly <strong>heinous</strong> act. The killer had violated the <strong>sanctity</strong> of the old library. This felt like some kind of <strong>frontier vengeance</strong>. The city's borders were famously <strong>porous</strong>. There was a constant <strong>flux</strong> of strange visitors. Many were smuggling <strong>illicit</strong> goods. An <strong>intricate</strong> tapestry hung on the wall, a silent <strong>backdrop</strong> to the crime. The detective's own position was <strong>precarious</strong>. He had <strong>pledged</strong> to the public that he would solve the case. He had to <strong>curb</strong> these violent <strong>intrusions</strong>. He would find the killer and <strong>repatriate</strong> him to his home country for justice. His <strong>patrols</strong> would work day and night. He hoped to <strong>usher in</strong> an age of peace. He had to practice <strong>restraint</strong> and not rush the investigation. But his promises to the victim's family felt <strong>hollow</strong>. He found himself <strong>invoking</strong> the city's old charter for help. The long investigation was <strong>culminating</strong> in a final chase. At last, he cornered the <strong>perpetrators</strong> in the old bell tower."
                },
                {
                    dayId: 'Day-6',
                    tasks: [
                        { id: 'quran', subject: 'Quran', topic: 'Sura Tawbah 9:31- 9:41' },
                        { id: 'newspaper', subject: 'Newspaper', topic: '' },
                        { id: 'vocabulary', subject: 'Vocabulary', topic: '' },
                        { id: 'math', subject: 'Math', topic: '' },
                        { id: 'basic', subject: 'Basic View', topic: '' }
                    ],
                    story: ""
                },
                {
                    dayId: 'Day-7',
                    tasks: [
                        { id: 'quran', subject: 'Quran', topic: '' },
                        { id: 'newspaper', subject: 'Newspaper', topic: '' },
                        { id: 'vocabulary', subject: 'Vocabulary', topic: '' },
                        { id: 'math', subject: 'Math', topic: '' },
                        { id: 'basic', subject: 'Basic View', topic: '' }
                    ],
                    story: ""
                }
            ];
        }

        // --- NEW: Check if user is new, if so, seed default data ---
        async function checkAndSeedDefaultData() {
            if (!planContentCollectionRef) return;
            
            setSyncStatus("Checking data...");
            const q = query(planContentCollectionRef, limit(1));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                // This is a new user
                console.log("New user detected. Seeding default plan data...");
                setSyncStatus("Saving default plan...");
                const defaultData = getDefaultPlanData();
                const batch = writeBatch(db);

                defaultData.forEach(dayData => {
                    const dayDocRef = doc(planContentCollectionRef, dayData.dayId);
                    batch.set(dayDocRef, dayData);
                });

                try {
                    await batch.commit();
                    console.log("Default data seeded successfully.");
                } catch (error) {
                    console.error("Error seeding data: ", error);
                    setSyncStatus(error.message, true);
                }
            } else {
                // Existing user
                console.log("Existing user data found.");
            }
        }


        // --- Initialize Firebase and Authentication ---
        async function initFirebase() {
            if (firebaseConfig.apiKey.startsWith("PASTE_YOUR_")) {
                const errorMsg = "Firebase config is missing."
                console.error(errorMsg);
                setSyncStatus(errorMsg, true);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        console.log("User is signed in:", user.displayName, `(${userId})`);
                        showLoggedInUI(user);
                        
                        // Set up paths to this user's private data
                        planContentCollectionRef = collection(db, `studyPlan/users/${userId}/planContent`);
                        progressDocRef = doc(db, `studyPlan/users/${userId}/progress`);
                        
                        // Check if they are a new user and seed data if needed
                        await checkAndSeedDefaultData();

                        // Start listening for their data
                        listenForPlanChanges();
                        listenForProgressChanges();

                    } else {
                        // User is signed out
                        console.log("User is signed out.");
                        showLoggedOutUI();
                        userId = null;
                        planContentCollectionRef = null;
                        progressDocRef = null;
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                setSyncStatus(error.message, true);
            }
        }

        // --- Data-saving function for PROGRESS (checkboxes/dates) ---
        let saveTimeout;
        function debouncedSaveProgress() {
            if (!isDataLoaded) return; 

            clearTimeout(saveTimeout);
            setSyncStatus('saving'); // Show "Saving..."
            saveTimeout = setTimeout(() => {
                saveProgressToFirestore();
            }, 1500); // Wait 1.5 seconds after the last change to save
        }

        async function saveProgressToFirestore() {
            if (!progressDocRef) {
                console.log("No data reference. Cannot save progress.");
                return;
            }
            const newProgressData = {};
            // 1. Save all checkbox states
            const allCheckboxes = document.querySelectorAll('.task-checkbox');
            allCheckboxes.forEach(cb => {
                const day = cb.dataset.dayId;
                const taskId = cb.dataset.taskId;
                const key = `${day}-${taskId}-checked`;
                if (newProgressData[key] === undefined) {
                    newProgressData[key] = cb.checked;
                }
            });
            // 2. Save all date inputs
            const allDateInputs = document.querySelectorAll('.date-input-desktop input, .date-input-mobile input');
            allDateInputs.forEach(input => {
                const day = input.dataset.dayId;
                const key = `${day}-date`;
                if (newProgressData[key] === undefined) {
                     newProgressData[key] = input.value;
                }
            });

            try {
                console.log("Saving progress data to Firestore...");
                await setDoc(progressDocRef, newProgressData); // Overwrite with new progress
                console.log("Progress saved successfully.");
                setSyncStatus('synced'); // Show "Synced"
            } catch (error) {
                console.error("Error saving progress to Firestore:", error);
                setSyncStatus(error.message, true);
            }
        }

        // --- Data Listeners ---
        function listenForPlanChanges() {
            if (!planContentCollectionRef) return;
            if (unsubscribePlanListener) unsubscribePlanListener();

            console.log("Listening for plan data changes...");
            unsubscribePlanListener = onSnapshot(planContentCollectionRef, (snapshot) => {
                console.log("Received plan data from Firestore.");
                currentPlanData = snapshot.docs.map(doc => doc.data());
                // Sort by dayId to ensure "Day-1, Day-2" order
                currentPlanData.sort((a, b) => a.dayId.localeCompare(b.dayId, undefined, {numeric: true}));
                
                buildUI(currentPlanData);
                applyLoadedProgress(currentProgressData); // Re-apply progress
                
                setSyncStatus('synced');
                isDataLoaded = true;
            }, (error) => {
                console.error("Error listening to plan data:", error);
                setSyncStatus(error.message, true);
            });
        }

        function listenForProgressChanges() {
            if (!progressDocRef) return;
            if (unsubscribeProgressListener) unsubscribeProgressListener();

            console.log("Listening for progress data changes...");
            unsubscribeProgressListener = onSnapshot(progressDocRef, (doc) => {
                console.log("Received progress data from Firestore.");
                currentProgressData = doc.data() || {};
                applyLoadedProgress(currentProgressData);
            }, (error) => {
                console.error("Error listening to progress data:", error);
                setSyncStatus(error.message, true);
            });
        }
        

        // --- Main UI Building Function ---
        function buildUI(planData) {
            // Clear existing UI
            tableBody.innerHTML = '';
            mobileCardsContainer.innerHTML = '';
            maxWeight = 0;
            let currentDay = '';
            let currentMobileDay = '';

            planData.forEach(day => {
                let isFirstRowOfDay = true;
                day.tasks.forEach((task, taskIndex) => {
                    const isLastTaskOfDay = taskIndex === day.tasks.length - 1;
                    
                    if ((task.subject || task.topic) && taskWeights[task.id]) {
                        maxWeight += taskWeights[task.id];
                    }

                    // --- Create Table Row (Desktop) ---
                    const row = document.createElement('tr');
                    row.classList.add('task-item');
                    row.setAttribute('data-day-id', day.dayId); 
                    row.setAttribute('data-task-id', task.id);

                    // Day Cell
                    const dayCell = document.createElement('td');
                    dayCell.classList.add('px-6', 'py-4', 'text-sm', 'font-medium', 'text-gray-900', 'align-top');
                    
                    if (isFirstRowOfDay) {
                        row.classList.add('day-group-start');
                        const dayText = document.createElement('span');
                        dayText.textContent = day.dayId;
                        dayCell.appendChild(dayText);

                        const dateInputDiv = document.createElement('div');
                        dateInputDiv.classList.add('date-input-desktop', 'mt-2'); 
                        dateInputDiv.setAttribute('data-day-input', day.dayId);
                        dateInputDiv.style.display = 'none'; 
                        const dateInputId = `date-${day.dayId}`;
                        dateInputDiv.innerHTML = `
                            <div class="flex flex-col gap-1">
                                <label for="${dateInputId}" class="text-xs font-medium text-gray-600">Completion Date:</label>
                                <input type="text" id="${dateInputId}" data-day-id="${day.dayId}" class="form-input p-1 border border-gray-300 rounded-md shadow-sm text-sm w-full max-w-xs" placeholder="e.g., 24/10/25">
                            </div>
                        `;
                        dateInputDiv.querySelector('input').addEventListener('input', onInputChange);
                        dayCell.appendChild(dateInputDiv);
                        isFirstRowOfDay = false;
                    }
                    row.appendChild(dayCell);

                    // Subject Cell
                    const subjectCell = document.createElement('td');
                    subjectCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-500', 'font-medium', 'align-top');
                    subjectCell.textContent = task.subject;
                    row.appendChild(subjectCell);

                    // Topic Cell
                    const topicCell = document.createElement('td');
                    topicCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-600', 'align-top', 'whitespace-normal', 'break-words');

                    if (task.id === 'vocabulary' && task.topic) {
                        const wrapper = document.createElement('div');
                        wrapper.classList.add('flex', 'flex-wrap', 'gap-2', 'py-1');
                        
                        const pairs = task.topic.split(/, |।/).filter(p => p.trim());
                        pairs.forEach(pair => {
                            const vocabEl = createVocabElement(pair);
                            if(vocabEl) wrapper.appendChild(vocabEl);
                        });
                        topicCell.appendChild(wrapper);

                        if (pairs.length > 0 && day.story) {
                            const storyBtn = document.createElement('button');
                            storyBtn.textContent = 'Read story';
                            storyBtn.classList.add('read-story-btn'); 
                            storyBtn.setAttribute('data-day-id', day.dayId);
                            topicCell.appendChild(storyBtn); 
                        }
                    } else {
                        const topicSpan = document.createElement('span');
                        topicSpan.textContent = task.topic || '-'; 
                        topicCell.appendChild(topicSpan);
                    }
                    row.appendChild(topicCell);

                    // Completion Cell
                    const completionCell = document.createElement('td');
                    completionCell.classList.add('px-6', 'py-4', 'text-sm', 'text-gray-500', 'align-top');
                    const completionCellContent = document.createElement('div');
                    completionCellContent.classList.add('completion-cell-content');
                    
                    if (task.subject || task.topic) {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.classList.add('task-checkbox');
                        checkbox.setAttribute('data-day-id', day.dayId); 
                        checkbox.setAttribute('data-task-id', task.id);
                        checkbox.addEventListener('change', onInputChange);
                        completionCellContent.appendChild(checkbox);
                    }

                    // Add Edit button to the last task
                    if (isLastTaskOfDay) {
                        const editBtn = document.createElement('button');
                        editBtn.innerHTML = '&#9998;'; // Pencil icon
                        editBtn.classList.add('edit-day-btn');
                        editBtn.setAttribute('data-day-id', day.dayId);
                        completionCellContent.appendChild(editBtn);
                    }
                    completionCell.appendChild(completionCellContent);
                    row.appendChild(completionCell);
                    tableBody.appendChild(row);

                    // --- Create Mobile Card ---
                    if (task.subject || task.topic) {
                        const card = document.createElement('div');
                        card.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow', 'card-item'); 
                        card.setAttribute('data-day-id', day.dayId); 
                        card.setAttribute('data-task-id', task.id);
                        
                        let cardDay = '';
                        let dateInputMobile = ''; 
                        const dateInputMobileId = `date-mobile-${day.dayId}`;
                        
                        if (day.dayId !== currentMobileDay) { 
                            cardDay = `<h3 class="font-bold text-lg text-gray-800 mb-2">${day.dayId}</h3>`;
                            dateInputMobile = `
                                <div class="date-input-mobile mt-2 mb-3 p-3 bg-green-50 rounded-md" data-day-input="${day.dayId}" style="display: none;">
                                    <div class="flex items-center gap-2">
                                        <label for="${dateInputMobileId}" class="text-sm font-medium text-gray-700">Completion Date:</label>
                                        <input type="text" id="${dateInputMobileId}" data-day-id="${day.dayId}" class="form-input p-1 border border-gray-300 rounded-md shadow-sm text-sm w-full" placeholder="e.g., 24/10/25">
                                    </div>
                                </div>
                            `;
                            currentMobileDay = day.dayId; 
                        }
                        
                        let topicContent = '';
                        let storyButtonMobile = ''; 
                        if (task.id === 'vocabulary' && task.topic) {
                            const pairs = task.topic.split(/, |।/).filter(p => p.trim());
                            topicContent = '<div class="flex flex-wrap gap-2 py-1">';
                            pairs.forEach(pair => {
                                const vocabEl = createVocabElement(pair);
                                if(vocabEl) topicContent += vocabEl.outerHTML;
                            });
                            topicContent += '</div>';

                            if (pairs.length > 0 && day.story) {
                                storyButtonMobile = `<button class="read-story-btn" data-day-id="${day.dayId}">Read story</button>`;
                            }

                        } else {
                            topicContent = `<span class="text-gray-600">${task.topic || '-'}</span>`;
                        }

                        // Add Edit button to last card
                        let editButtonMobile = '';
                        if (isLastTaskOfDay) {
                            editButtonMobile = `<button class="edit-day-btn" data-day-id="${day.dayId}">&#9998; Edit Day</button>`;
                        }
                        
                        card.innerHTML = `
                            ${cardDay}
                            ${dateInputMobile} 
                            <div class="flex items-start">
                                <div class="completion-card-controls">
                                    <input type="checkbox" class="task-checkbox mt-1" data-day-id="${day.dayId}" data-task-id="${task.id}">
                                    ${isLastTaskOfDay ? editButtonMobile : ''}
                                </div>
                                <div class="ml-2 flex-1 min-w-0">
                                    <p class="font-medium text-gray-700">${task.subject}</p>
                                    <div class="text-sm break-words">${topicContent}</div>
                                    ${storyButtonMobile}
                                </div>
                            </div>
                        `;
                        
                        card.querySelector('.task-checkbox').addEventListener('change', onInputChange);
                        if(dateInputMobile) {
                            card.querySelector(`#${dateInputMobileId}`).addEventListener('input', onInputChange);
                        }
                        
                        card.querySelectorAll('.vocab-item').forEach(vocabContainer => {
                            vocabContainer.addEventListener('click', function(event) {
                                event.stopPropagation();
                                document.querySelectorAll('.vocab-item.active').forEach(item => {
                                    if(item !== this) item.classList.remove('active');
                                });
                                this.classList.toggle('active');
                            });
                        });
                        mobileCardsContainer.appendChild(card);
                    }
                });
            });
        }

        // --- Apply Loaded Progress to UI ---
        function applyLoadedProgress(progressData) {
            if (!progressData) return;
            // 1. Apply checkbox states
            const allCheckboxes = document.querySelectorAll('.task-checkbox');
            allCheckboxes.forEach(cb => {
                const day = cb.dataset.dayId;
                const taskId = cb.dataset.taskId;
                const key = `${day}-${taskId}-checked`;
                
                const isChecked = progressData[key] || false;
                cb.checked = isChecked;
                const taskItem = cb.closest('.task-item, .card-item');
                if (taskItem) {
                    taskItem.classList.toggle('completed', isChecked);
                }
            });

            // 2. Apply date inputs
            const allDateInputs = document.querySelectorAll('.date-input-desktop input, .date-input-mobile input');
            allDateInputs.forEach(input => {
                const day = input.dataset.dayId;
                const key = `${day}-date`;
                input.value = progressData[key] || '';
            });
            
            // 3. After applying data, check all day completions
            const allDays = new Set(currentPlanData.map(item => item.dayId));
            allDays.forEach(day => checkDayCompletion(day));

            // 4. Finally, update the progress bar
            updateWeeklyProgress();
            console.log("Progress data applied to UI.");
        }
        
        // --- Helper: Create Vocab Elements ---
        function createVocabElement(pair) {
            const parts = pair.split('-');
            if (parts.length >= 2) { // Allow dashes in meaning
                const eng = parts[0].trim();
                const ban = parts.slice(1).join('-').trim().replace('।', ''); 

                if (eng && ban) {
                    const vocabContainer = document.createElement('div');
                    vocabContainer.classList.add('vocab-item');
                    vocabContainer.setAttribute('tabindex', '0'); 
                    
                    vocabContainer.addEventListener('click', function(event) {
                        event.stopPropagation(); 
                        document.querySelectorAll('.vocab-item.active').forEach(item => {
                            if(item !== this) item.classList.remove('active');
                        });
                        this.classList.toggle('active');
                    });
                    
                    const engSpan = document.createElement('span');
                    engSpan.classList.add('vocab-word');
                    engSpan.textContent = eng;
                    
                    const banSpan = document.createElement('span');
                    banSpan.classList.add('vocab-meaning');
                    banSpan.textContent = ban;
                    
                    vocabContainer.appendChild(engSpan);
                    vocabContainer.appendChild(banSpan);
                    return vocabContainer;
                }
            } else if (pair.trim()) {
                    const textSpan = document.createElement('span');
                    textSpan.textContent = pair.trim();
                    return textSpan;
            }
            return null;
        }

        // --- Helper: Update Progress Bar ---
        window.updateWeeklyProgress = function() {
            let currentWeight = 0;
            const allCheckboxes = document.querySelectorAll('.task-checkbox');
            const checkedTasks = new Set();
            
            allCheckboxes.forEach(cb => {
                const uniqueId = `${cb.dataset.dayId}-${cb.dataset.taskId}`;
                if (cb.checked && !checkedTasks.has(uniqueId)) {
                    const taskId = cb.dataset.taskId;
                    if (taskId && taskWeights[taskId]) {
                        currentWeight += taskWeights[taskId];
                    }
                    checkedTasks.add(uniqueId);
                }
            });
            const percentage = (maxWeight > 0) ? (currentWeight / maxWeight) * 100 : 0;
            if(progressLabel) progressLabel.textContent = `Weekly Progress: ${percentage.toFixed(0)}%`;
            if(progressBar) progressBar.style.width = `${percentage}%`;
        }

        // --- Helper: Check Day Completion ---
        window.checkDayCompletion = function(dayId) {
            const allCheckboxesForDay = document.querySelectorAll(`.task-checkbox[data-day-id="${dayId}"]`);
            if (allCheckboxesForDay.length === 0) return;

            let allChecked = true;
            const taskIds = new Set(Array.from(allCheckboxesForDay).map(cb => cb.dataset.taskId));
            
            taskIds.forEach(taskId => {
                const checkboxesForTask = document.querySelectorAll(`.task-checkbox[data-day-id="${dayId}"][data-task-id="${taskId}"]`);
                const isTaskChecked = Array.from(checkboxesForTask).some(cb => cb.checked);
                if (!isTaskChecked) {
                    allChecked = false;
                }
            });

            const dateInputDesktop = document.querySelector(`.date-input-desktop[data-day-input="${dayId}"]`); 
            const dateInputMobile = document.querySelector(`.date-input-mobile[data-day-input="${dayId}"]`);

            if (allChecked) {
                if(dateInputDesktop) dateInputDesktop.style.display = 'block'; 
                if(dateInputMobile) dateInputMobile.style.display = 'block';
            } else {
                if(dateInputDesktop) dateInputDesktop.style.display = 'none';
                if(dateInputMobile) dateInputMobile.style.display = 'none';
            }
        }


        // --- Story Modal Functions ---
        function showStory(dayId) {
            const dayData = currentPlanData.find(d => d.dayId === dayId);
            if (dayData && dayData.story) {
                storyTitle.textContent = `A Tale from ${dayId}`;
                storyContent.innerHTML = dayData.story;
                storyModal.classList.remove('modal-hidden');
            }
        }
        function hideStory() {
            storyModal.classList.add('modal-hidden');
        }

        // --- NEW: Edit Modal Functions ---
        let currentEditingDayId = null;

        function openEditModal(dayId) {
            const dayData = currentPlanData.find(d => d.dayId === dayId);
            if (!dayData) return;

            currentEditingDayId = dayId;
            editModalTitle.textContent = `Edit Plan for ${dayId}`;
            editModalContent.innerHTML = ''; // Clear old form

            // Create form fields for each task
            dayData.tasks.forEach((task, index) => {
                const group = document.createElement('div');
                group.classList.add('form-group', 'p-4', 'bg-white', 'rounded-lg', 'border');
                
                group.innerHTML = `
                    <label for="edit-subject-${index}" class="font-semibold text-indigo-700">Task ${index + 1} Subject</label>
                    <input type="text" id="edit-subject-${index}" data-task-id="${task.id}" value="${task.subject}" class="mb-3">
                    
                    <label for="edit-topic-${index}" class="font-semibold text-indigo-700">Task ${index + 1} Topic</label>
                    <textarea id="edit-topic-${index}" data-task-id="${task.id}" rows="3">${task.topic}</textarea>
                `;
                editModalContent.appendChild(group);
            });

            // Add form field for the story
            const storyGroup = document.createElement('div');
            storyGroup.classList.add('form-group', 'p-4', 'bg-white', 'rounded-lg', 'border');
            storyGroup.innerHTML = `
                <label for="edit-story" class="font-semibold text-indigo-700">Vocabulary Story</label>
                <textarea id="edit-story" rows="6" placeholder="Enter the story for this day...">${dayData.story || ''}</textarea>
            `;
            editModalContent.appendChild(storyGroup);

            editModal.classList.remove('modal-hidden');
        }

        function hideEditModal() {
            editModal.classList.add('modal-hidden');
            currentEditingDayId = null;
        }

        async function saveDayData() {
            if (!currentEditingDayId || !planContentCollectionRef) return;

            setSyncStatus('saving');
            editSaveBtn.disabled = true;
            editSaveBtn.textContent = 'Saving...';

            const dayDocRef = doc(planContentCollectionRef, currentEditingDayId);
            const newTasks = [];

            // Get all task subjects and topics from the form
            const subjectInputs = editModalContent.querySelectorAll('input[id^="edit-subject-"]');
            const topicTextareas = editModalContent.querySelectorAll('textarea[id^="edit-topic-"]');
            
            subjectInputs.forEach((input, index) => {
                const taskId = input.dataset.taskId;
                const subject = input.value;
                const topic = topicTextareas[index].value;
                newTasks.push({ id: taskId, subject, topic });
            });

            const newStory = editModalContent.querySelector('#edit-story').value;

            const newDayData = {
                dayId: currentEditingDayId,
                tasks: newTasks,
                story: newStory
            };

            try {
                // Save the new data back to Firestore
                await setDoc(dayDocRef, newDayData);
                console.log(`Data for ${currentEditingDayId} saved successfully.`);
                hideEditModal();
                // No need to call buildUI here, the onSnapshot listener will do it
            } catch (error) {
                console.error("Error saving day data: ", error);
                setSyncStatus(error.message, true);
            } finally {
                editSaveBtn.disabled = false;
                editSaveBtn.textContent = 'Save Changes';
            }
        }


        // --- Checkbox and Date Input change handler ---
        function onInputChange(event) {
            if (!isDataLoaded) return; // Don't do anything if data isn't loaded
            
            const element = event.target;
            
            if (element.classList.contains('task-checkbox')) {
                const dayId = element.dataset.dayId;
                const taskId = element.dataset.taskId;
                const isChecked = element.checked;
                const allCheckboxesForTask = document.querySelectorAll(`.task-checkbox[data-day-id="${dayId}"][data-task-id="${taskId}"]`);
                allCheckboxesForTask.forEach(cb => {
                    cb.checked = isChecked;
                    const taskItem = cb.closest('.task-item, .card-item');
                    if (taskItem) {
                        taskItem.classList.toggle('completed', isChecked);
                    }
                });
                checkDayCompletion(dayId);
            
            } else if (element.tagName === 'INPUT' && element.type === 'text') {
                const dayId = element.dataset.dayId;
                const desktopInput = document.getElementById(`date-${dayId}`);
                const mobileInput = document.getElementById(`date-mobile-${dayId}`);
                if (desktopInput) desktopInput.value = element.value;
                if (mobileInput) mobileInput.value = element.value;
            }
            updateWeeklyProgress();
            debouncedSaveProgress();
        }

        // --- Run on page load ---
        document.addEventListener('DOMContentLoaded', async function() {
            // --- Add Listeners to Auth Buttons ---
            loginBtn.addEventListener('click', signInWithGoogle);
            logoutBtn.addEventListener('click', signOutUser);

            // --- Add Listeners to Story Modal ---
            storyCloseBtn.addEventListener('click', hideStory);
            storyOverlay.addEventListener('click', hideStory);

            // --- Add Listeners to Edit Modal ---
            editCloseBtn.addEventListener('click', hideEditModal);
            editCancelBtn.addEventListener('click', hideEditModal);
            editOverlay.addEventListener('click', hideEditModal);
            editSaveBtn.addEventListener('click', saveDayData);

            // --- Event Delegation for dynamic buttons ---
            document.body.addEventListener('click', function(event) {
                // Story Button
                const storyBtn = event.target.closest('.read-story-btn');
                if (storyBtn) {
                    const dayId = storyBtn.dataset.dayId;
                    showStory(dayId);
                    return;
                }

                // Edit Button
                const editBtn = event.target.closest('.edit-day-btn');
                if (editBtn) {
                    const dayId = editBtn.dataset.dayId;
                    openEditModal(dayId);
                    return;
                }

                // Vocab Item
                const vocabItem = event.target.closest('.vocab-item');
                if (vocabItem) {
                    event.stopPropagation();
                    document.querySelectorAll('.vocab-item.active').forEach(item => {
                        if(item !== vocabItem) item.classList.remove('active');
                    });
                    vocabItem.classList.toggle('active');
                    return;
                }

                // Global click to close vocab
                document.querySelectorAll('.vocab-item.active').forEach(vocab => {
                    vocab.classList.remove('active');
                });
            });

            // --- Start Firebase Init ---
            await initFirebase();
        });
    </script>

</body>
</html>
